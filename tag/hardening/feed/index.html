<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Portcullis Labs &#187; hardening</title>
	<atom:link href="https://portcullislabs.github.io/tag/hardening/feed/" rel="self" type="application/rss+xml" />
	<link>https://portcullislabs.github.io</link>
	<description>Research and Development</description>
	<language>en-US</language>
		<sy:updatePeriod>hourly</sy:updatePeriod>
		<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.8.5</generator>
	<item>
		<title>Security Engineering &#8211; A manifesto for defensive security</title>
		<link>https://portcullislabs.github.io/presentations/security-engineering-a-manifesto-for-defensive-security/</link>
		<comments>https://portcullislabs.github.io/presentations/security-engineering-a-manifesto-for-defensive-security/#comments</comments>
		<pubDate>Fri, 28 Jun 2019 06:27:47 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[C-Suite]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[CRQ]]></category>
		<category><![CDATA[cyber risk quantification]]></category>
		<category><![CDATA[devops]]></category>
		<category><![CDATA[devsecops]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[infradev]]></category>
		<category><![CDATA[orchestration]]></category>
		<category><![CDATA[risk]]></category>
		<category><![CDATA[seceng]]></category>
		<category><![CDATA[service providers]]></category>
		<category><![CDATA[SnoopCon]]></category>
		<category><![CDATA[sre]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6858</guid>
		<description><![CDATA[<p>Presentation on the need to re-examine how we engineer systems (taking service providers as an example) and the implications on how we quantify cyber risk if we want to take this message into the board room (as given at BT&#8217;s SnoopCon 2019 and Cisco&#8217;s June 2019 Knowledge Network webinar for service providers). Having delivered security [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/presentations/security-engineering-a-manifesto-for-defensive-security/">Security Engineering &#8211; A manifesto for defensive security</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on the need to re-examine how we engineer systems (taking service providers as an example) and the implications on how we quantify cyber risk if we want to take this message into the board room (as given at BT&#8217;s SnoopCon 2019 and Cisco&#8217;s June 2019 <a title="Knowledge Network" href="https://engage2demand.cisco.com/CiscoKnowledgeNetwork">Knowledge Network</a> webinar for service providers).<span id="more-6858"></span></p>
<p>Having delivered security consultancy as part of Portcullis/Cisco for over 15 years, I&#8217;ve seen a variety of shades of broken. Since I recently spent some time on secondment to one of our customers to help them design, build and operationalise security as part of their digital transformation programme, I got to thinking: what would I do if I wanted to get projects delivered right? With apologies to grsec, Jericho Forum, BeyondCorp and Trusted Computing, what followed was part philosophy, part technical brain dump, the result being my take on security engineering and how to build defensible systems. This talk includes the following hits:</p>
<ul>
<li>Helping the blue team – a case study in 3 parts&#8230;</li>
<li>Blue doesn&#8217;t have the man power to adopt gift wrapped improvements let alone offensive research thrown over the wall</li>
<li>Static passwords – why the hell are we still using them?</li>
<li>Vulnerability management – didn’t we say blacklists were bad?</li>
<li>Forget about penetration testing – what are your controls?</li>
<li>Is there another way to report – why don’t businesses listen to us?</li>
<li>Monetising MITRE – can we make money out of CVEs?</li>
</ul>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-1').click();">
  <div class="icon"><a href="https://portcullislabs.github.io/download/SEAMFDS.pdf" target="_blank" title="Download SEAMFDS"><img align="middle" src="https://portcullislabs.github.io/wp-includes/images/crystal/document.png" alt="SEAMFDS" /></a></div>
  <div class="filetitle">
    <a href="https://portcullislabs.github.io/download/SEAMFDS.pdf" title="Download SEAMFDS.pdf" target="_blank" id="wpfb-file-link-1">SEAMFDS.pdf</a>
    
    <br />
    June 28, 2019<br />
    
  </div>
  <div class="info">
    311.8 KiB<br />
    MD5 hash: 185701fbc113ca2a676e802b61df53e2 <br />
    <a href="#" onclick="return wpfilebase_filedetails(1);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails1" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>June 28, 2019</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://portcullislabs.github.io/presentations/security-engineering-a-manifesto-for-defensive-security/">Security Engineering &#8211; A manifesto for defensive security</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/presentations/security-engineering-a-manifesto-for-defensive-security/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>An offensive introduction to Active Directory on UNIX</title>
		<link>https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/</link>
		<comments>https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/#comments</comments>
		<pubDate>Thu, 06 Dec 2018 09:18:36 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[Black Hat Europe]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[root]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[UNIX]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6805</guid>
		<description><![CDATA[<p>By way of an introduction to our talk at Black Hat Europe, Security Advisory EMEAR would like to share the background on our recent research into some common Active Directory integration solutions. Just as with Windows, these solutions can be utilized to join UNIX infrastructure to enterprises&#8217; Active Directory forests. Background to Active Directory integration [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/">An offensive introduction to Active Directory on UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>By way of an introduction to <a href="https://www.blackhat.com/eu-18/briefings/schedule/index.html#where-2-worlds-collide-bringing-mimikatz-et-al-to-unix-12962" title="our talk">our talk</a> at Black Hat Europe, <a href="https://www.cisco.com/c/en/us/products/security/advisory-services.html" title="Security Advisory EMEAR">Security Advisory EMEAR</a> would like to share the background on our recent research into some common Active Directory integration solutions. Just as with Windows, these solutions can be utilized to join UNIX infrastructure to enterprises&#8217; Active Directory forests.<span id="more-6805"></span></p>
<h2>Background to Active Directory integration solutions</h2>
<p>Having seen an uptick in unique UNIX infrastructures that are integrated into customers&#8217; existing Active Directory forests, the question becomes, &#8220;Does this present any concerns that may not be well understood?&#8221; This quickly became &#8220;What if an adversary could get into a UNIX box and then breach your domain?&#8221;<br />
Within a typical Active Directory integration solution (in this case <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/5.7_release_notes/sssd" title="SSSD">SSSD</a>), the solution shares a striking similarity to what a user might see on Windows. Notably, you have:</p>
<ul>
<li>DNS &#8211; Used for name resolution</li>
<li>LDAP &#8211; Used for &#8220;one-time identification&#8221; and assertion of identity</li>
<li>Kerberos &#8211; Used for ongoing authentication</li>
<li>SSSD &#8211; Like LSASS</li>
<li>PAM &#8211; Like msgina.dll or the more modern credential providers</li>
</ul>
<p>You can see a breakdown of this process <a title="here" href="https://rhelblog.redhat.com/2015/02/04/overview-of-direct-integration-options/">here</a>. Unlike Windows, there is no Group Policy for the most part (with some exceptions), so policies for sudo et al. are typically pushed as flat files to hosts.</p>
<h2>Our research</h2>
<p>Realistically, the threat models associated with each part of the implementation should be quite familiar to anyone securing a heterogeneous Windows network. Having worked with a variety of customers, it becomes apparent that the typical UNIX administrator who does not have a strong background in Windows and Active Directory will be ill-equipped to handle this threat. While we&#8217;ve been talking about successful attacks against components such as LSASS and Kerberos for quite some time, Mimikatz dates back to at least April 2014, and dumping hashes has been around even longer. Pwdump, which dumped local Windows hashes, was published by Jeremy Allison in 1997). However, no one has really taken a concerted look at whether these attacks are possible on UNIX infrastructure, nor how a blue team might spot an adversary performing them.</p>
<p>As a result of this research, we were able to develop tactics, tools, and procedures that might further assist an attacker in breaching an enterprise, and we began documenting and developing appropriate strategies to allow blue teams to appropriately detect and respond to such incursions. The Black Hat EU slides can be found <a title="here" href="/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/">here</a> and whilst the tools we developed can be found on <a href="https://github.com/portcullislabs/linikatz" title="our GitHub repo">our GitHub repo</a>.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/">An offensive introduction to Active Directory on UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/an-offensive-introduction-to-active-directory-on-unix/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Where 2 worlds collide: Bringing Mimikatz et al to UNIX</title>
		<link>https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/</link>
		<comments>https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/#comments</comments>
		<pubDate>Thu, 06 Dec 2018 08:04:06 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[analysis]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[Black Hat Europe]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[root]]></category>
		<category><![CDATA[training]]></category>
		<category><![CDATA[UNIX]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6806</guid>
		<description><![CDATA[<p>Presentation on Active Directory integration solutions for UNIX (as given at Black Hat Europe 2018). Over the past fifteen years there&#8217;s been an uptick in &#8220;interesting&#8221; UNIX infrastructures being integrated into customers&#8217; existing AD forests. Whilst the threat models enabled by this should be quite familiar to anyone securing a heterogeneous Windows network, they may [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/">Where 2 worlds collide: Bringing Mimikatz et al to UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on Active Directory integration solutions for UNIX (as given at Black Hat Europe 2018).<span id="more-6806"></span></p>
<p>Over the past fifteen years there&#8217;s been an uptick in &#8220;interesting&#8221; UNIX infrastructures being integrated into customers&#8217; existing AD forests. Whilst the threat models enabled by this should be quite familiar to anyone securing a heterogeneous Windows network, they may not be as well understood by a typical UNIX admin who does not have a strong background in Windows and AD. Over the last few months we&#8217;ve spent some time looking a number of specific Active Directory integration solutions (both open and closed source) for UNIX systems and documenting some of the tools, tactics and procedures that enable attacks on the forest to be staged from UNIX.</p>
<p>This talk describes the technical details regarding our findings. It includes Proof of Concepts (PoC) showing real-world attacks against AD joined UNIX systems. Finally, potential solutions or mitigation controls are discussed that will help to either prevent those attacks or at the very least to detect them when they occur.</p>
<p>Tools referenced in this talk include:</p>
<ul>
<li><a href="https://github.com/portcullislabs/linikatz" title="Linikatz">Linikatz</a></li>
<ul>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/red/JohnTheRipper" title="JohnTheRipper dynamic.conf rules">JohnTheRipper dynamic.conf rules</a></li>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/red/metasploit-framework" title="metasploit-framework post-exploitation modules">metasploit-framework post-exploitation modules</a></li>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/blue/audit" title="auditd policies">auditd policies</a></li>
<li><a href="https://github.com/portcullislabs/linikatz/tree/master/tools/vas/fuzzers" title="fuzzers">fuzzers</a></li>
</ul>
</ul>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-2').click();">
  <div class="icon"><a href="https://portcullislabs.github.io/download/eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf" target="_blank" title="Download Eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX"><img align="middle" src="https://portcullislabs.github.io/wp-includes/images/crystal/document.png" alt="Eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX" /></a></div>
  <div class="filetitle">
    <a href="https://portcullislabs.github.io/download/eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf" title="Download eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf" target="_blank" id="wpfb-file-link-2">eu-18-Wadhwa-Brown-Where-2-worlds-collide-Bringing-Mimikatz-et-al-to-UNIX.pdf</a>
    
    <br />
    December 6, 2018<br />
    
  </div>
  <div class="info">
    724.9 KiB<br />
    MD5 hash: cc712c5e46b16fbff22a2566b1248a91 <br />
    <a href="#" onclick="return wpfilebase_filedetails(2);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails2" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>December 6, 2018</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/">Where 2 worlds collide: Bringing Mimikatz et al to UNIX</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/presentations/where-2-worlds-collide-bringing-mimikatz-et-al-to-unix/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>The importance of logs: You won&#8217;t see what you don&#8217;t log</title>
		<link>https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/</link>
		<comments>https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/#comments</comments>
		<pubDate>Wed, 31 Oct 2018 12:36:40 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[SecureSouthWest]]></category>
		<category><![CDATA[training]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6793</guid>
		<description><![CDATA[<p>Presentation on logging and auditing strategies (as given at Secure South West 11). Building on my blog post on Cisco&#8217;s security blog entitled The Importance of Logs, I put together a presentation that picks apart some of the practical aspects of building a successful logging capability focusing on the need to document &#8220;good&#8221; and curate [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/">The importance of logs: You won&#8217;t see what you don&#8217;t log</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on logging and auditing strategies (as given at Secure South West 11).<span id="more-6793"></span></p>
<p>Building on my blog post on Cisco&#8217;s security blog entitled <a href="https://blogs.cisco.com/security/the-importance-of-logs">The Importance of Logs</a>, I put together a presentation that picks apart some of the practical aspects of building a successful logging capability focusing on the need to document &#8220;good&#8221; and curate &#8220;bad&#8221;.</p>
<p>The purpose of this talk is not to help you build a SOC in 30 minutes, rather it looks at how logging can go wrong and how to plan in order to get it right. The talk includes some composite case studies which highlight some of the challenges that we&#8217;ve seen over the years (particularly when responding in customer breaches) and makes some suggestions on where interested organisations should focus their efforts next.</p>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-3').click();">
  <div class="icon"><a href="https://portcullislabs.github.io/download/SSWTIOLYWSWYDL.pdf" target="_blank" title="Download SSWTIOLYWSWYDL"><img align="middle" src="https://portcullislabs.github.io/wp-includes/images/crystal/document.png" alt="SSWTIOLYWSWYDL" /></a></div>
  <div class="filetitle">
    <a href="https://portcullislabs.github.io/download/SSWTIOLYWSWYDL.pdf" title="Download SSWTIOLYWSWYDL.pdf" target="_blank" id="wpfb-file-link-3">SSWTIOLYWSWYDL.pdf</a>
    
    <br />
    October 31, 2018<br />
    
  </div>
  <div class="info">
    463.7 KiB<br />
    MD5 hash: 390c1d8b29e74f2c15df434b4d0d9f99 <br />
    <a href="#" onclick="return wpfilebase_filedetails(3);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails3" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>October 31, 2018</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/">The importance of logs: You won&#8217;t see what you don&#8217;t log</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/presentations/the-importance-of-logs-you-wont-see-what-you-dont-log/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Enforcing a write-xor-execute memory policy from usermode</title>
		<link>https://portcullislabs.github.io/blog/enforcing-a-write-xor-execute-memory-policy-from-usermode/</link>
		<comments>https://portcullislabs.github.io/blog/enforcing-a-write-xor-execute-memory-policy-from-usermode/#comments</comments>
		<pubDate>Fri, 02 Feb 2018 02:21:20 +0000</pubDate>
		<dc:creator><![CDATA[GCS]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=6399</guid>
		<description><![CDATA[<p>If BuzzFeed ran an article titled &#8220;26 Security Features You Probably Shouldn&#8217;t Enforce From Usermode&#8221;, this one would almost certainly make the list. But, for whatever reason, I thought it would be a fun learning experience to try to enforce a W^X memory policy from usermode. Some of you are probably asking what the heck [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/enforcing-a-write-xor-execute-memory-policy-from-usermode/">Enforcing a write-xor-execute memory policy from usermode</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>If BuzzFeed ran an article titled &#8220;26 Security Features You Probably Shouldn&#8217;t Enforce From Usermode&#8221;, this one would almost certainly make the list. But, for whatever reason, I thought it would be a fun learning experience to try to enforce a W^X memory policy from usermode. Some of you are probably asking what the heck a W^X policy is in the first place, and I&#8217;m terrible at thinking of ways to start blog posts (case in point: this paragraph), so I guess we&#8217;ll start out there.<span id="more-6399"></span></p>
<h2>What&#8217;s a W^X policy, anyway?</h2>
<p>W^X is an exploit mitigation tactic in which memory pages that are, or have ever been, marked as writable can never be marked as executable during the process lifetime. The old exploit tactic of putting your exploit payload on the stack (or heap) and calling it directly was killed off with no-execute (NX, also known as hardware DEP on Windows) support, which made ret2libc/ROP approaches much more popular. ROP involves finding small pieces of existing executable code in the application and its libraries, chaining them together using the stack, with the goal of calling an API or two to allocate some executable memory for the payload to be copied into. On Windows this is usually done with a ROP chain to the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366887.aspx" title="VirtualAlloc">VirtualAlloc</a>() API, passing <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa366786.aspx" title="PAGE_EXECUTE_READWRITE">PAGE_EXECUTE_READWRITE</a>() in order to allow for both writing the data in and executing it afterwards.</p>
<p>Enforcing a W^X policy breaks this approach, as an exploit cannot allocate memory as RWX, or as RW and then later executable. Applications in Windows 8.1 and later can opt into a W^X policy, enforced by the kernel, this using the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh769088.aspx" title="SetProcessMitigationPolicy">SetProcessMitigationPolicy</a>() API with the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/mt706243.aspx" title="ProcessDynamicCodePolicy">ProcessDynamicCodePolicy</a>() argument. Of course, this is also the boring way (at least for this article).</p>
<h2>The small print</h2>
<p>I&#8217;m not going to make you read a sixty-eight page EULA and sign your life away on the dotted line, but there are things you should know before you gallivant away with some source code and a dream of securing your applications:</p>
<ol>
<li>I am a terrible C++ programmer. You should absolutely not use my code in production</li>
<li>This is a proof-of-concept, so you still absolutely should not use it in production. And probably not any other context than &#8220;I want to learn how this works&#8221; or &#8220;I want to torture my eyes by reading wonky code&#8221;</li>
<li>While some effort has been made to make the PoC thread-safe, there are some race conditions (probably security-critical ones) that exist and I haven&#8217;t done anything to fix for reasons of keeping the code fairly simple</li>
<li>Only VirtualAlloc(), VirtualProtect(), and VirtualFree() are hooked. There are ways to get around this (e.g. calling `ntdll` functions directly, or using `Ex` suffix variants) so, again, don&#8217;t expect any concrete security from this</li>
<li>In case you didn&#8217;t already get the memo, implementing this kind of security feature from usermode is colossally silly, particularly when the OS offers a proper version that is enforced in the kernel. An attacker who expects this usermode &#8220;protection&#8221; can tailor their exploit to bypass it in most cases
</li>
<li>Just like the kernelmode version, this breaks any application that uses JIT compilation. So that means all browsers, anything that uses Java, .NET, or a modern JavaScript engine. It also means things that embed a web frame</li>
</ol>
<p>Caveat emptor, and all that.</p>
<h2>How does this thing work?</h2>
<p>The actual approach is fairly simple:</p>
<ol>
<li>Hook APIs</li>
<li>Reject calls that would result in a page being writable and executable at the same time</li>
<li>Track calls that result in a page being writable, and deny future calls that would make those pages executable</li>
</ol>
<p>The grunt work involved with hooking APIs is fairly boring, so I enlisted the help of the <a href="https://github.com/martona/mhook" title="mhook library">mhook library</a> by Marton Anka. This library provides a really intuitive way of hooking APIs:</p>
<pre class="brush: cpp; gutter: false; title: ; notranslate">
Mhook_SetHook((PVOID*)&amp;OriginalVirtualAlloc,   HookedVirtualAlloc);
Mhook_SetHook((PVOID*)&amp;OriginalVirtualProtect, HookedVirtualProtect);
Mhook_SetHook((PVOID*)&amp;OriginalVirtualFree,    HookedVirtualFree);
</pre>
<p>Each call to Mhook_SetHook() takes a pointer to the original API as the first parameter, and a pointer to the hooked version you want to replace it with.</p>
<h3>VirtualAlloc hook</h3>
<p>The VirtualAlloc hook checks if flProtect is either PAGE_EXECUTE_READWRITE or PAGE_EXECUTE_WRITECOPY. The former is the general-case RWX protection, and the latter is used when the segment of memory is a memory-mapped file. If either of these protection options are detected, the operation is failed with an access denied error.</p>
<p>Next, we perform the requested VirtualAlloc() call via OriginalVirtualAlloc. If this succeeds, we check to see if the requested allocation contained a writable flag (e.g. PAGE_READWRITE or PAGE_WRITECOPY) and, if so, add that allocation&#8217;s page address and allocation size to a tracking list. This allows us to later reject requests  to make these pages executable, as they have been tainted with the writable mark.</p>
<h3>VirtualProtect hook</h3>
<p>The VirtualProtect hook is the most involved. As with VirtualAlloc it first rejects RWX protections outright. It then checks to see if the requested protection is executable and, if so, checks if the page exists within the boundary of a tracked writable allocation, i.e. if it starts within one, ends within one, or starts before and ends after one. This prevents tricks like allocating a small chunk of writable memory inside a larger readonly block, then calling VirtualProtect() over the whole block to make it all executable.</p>
<p>In order to protect against abuse of writable memory that was pre-allocated by the loader (e.g. the .data section) the code also calls VirtualQuery() to test the existing protection status of the memory, just in case we aren&#8217;t tracking it.</p>
<p>Another case we need to handle is similar to the VirtualAlloc() call. If the call is making memory writable, we need to track it. First we check if the exact allocation is already present in our tracked list, then if it isn&#8217;t we add it. It doesn&#8217;t matter if we have overlapping tracking metadata for writable allocations &#8211; we handle this case in our hooked VirtualFree(). Speaking of which&#8230;</p>
<h3>VirtualFree hook</h3>
<p>This hook is fairly simple. We just iterate over every item in the tracked allocations and remove them if they cover the address being freed.</p>
<h2>Testing</h2>
<p>The initial driver for me writing this code, before I decided to implement a full W^X policy with it, was to test for cases where an application under test would attempt to allocate RWX buffers, and if they actually needed those buffers to be executable (i.e. swap RWX for RW and see if you get a crash). For fun, I injected this DLL into a bunch of different programs. Many (e.g. notepad, calc) just work without problems, as they don&#8217;t rely on RWX memory at all. A number of others (e.g. Chrome, Spotify) crash due to JIT code that runs inside the process. It was quite fun to watch these allocations occur in realtime via debug messages.</p>
<h2>Bypasses</h2>
<p>There are a number of ways to bypass the PoC as it stands. I thought about eliminating them, but I think it&#8217;s more fun to go through the code and identify the problems.</p>
<p>The first and most obvious way is to ROP to GetModuleHandle() and find the original APIs that way, totally bypassing the checks. It is possible to fix this to some extent by hooking GetModuleHandle() and similar APIs, but this mostly ends up as a cat-and-mouse game. This is why you should implement this stuff in kernelmode.</p>
<p>The second way is a race condition. In both VirtualAlloc and VirtualProtect hooks we call the original function, then lock the tracking list and add the new allocation to the tracked list. It is possible to call either of these functions twice. This can be fixed with a global allocation mutex.</p>
<p>There&#8217;s also a potential <a href="https://en.wikipedia.org/wiki/Time_of_check_to_time_of_use" title="TOCTOU">TOCTOU</a> race condition in our VirtualProtect hook, where we check the page protection using VirtualQuery and later potentially call VirtualAlloc based on the result. However, the attacker would have to get the application to call the unhooked VirtualProtect in order to exploit this particular issue.</p>
<p>Finally there&#8217;s a really interesting case &#8211; marking a page as writable, filling it with data, freeing it, then re-allocating as read-execute and hoping that you get the same page back before it gets reset to zeroes by the OS. In fact, when I thought of this issue, I wondered whether I might have stumbled across a potential mitigation bypass in the real W^X implementation for Windows, and my eyes turned into dollar signs. Thankfully (or sadly) the clever folks at Microsoft thought of this already, and forced every released page to be reset.</p>
<h2>Closing words</h2>
<p>I hope that this ham-fisted approach to implementing W^X has been of some educational use, at least in terms of thinking about how the protection can be implemented in practice. If you&#8217;d like to follow along at home, the code can be found in the <a title="WXPolicyEnforcer" href="https://github.com/portcullislabs/WXPolicyEnforcer">WXPolicyEnforcer</a> project on the Portcullis Labs GitHub. It is released under MIT license.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/enforcing-a-write-xor-execute-memory-policy-from-usermode/">Enforcing a write-xor-execute memory policy from usermode</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/enforcing-a-write-xor-execute-memory-policy-from-usermode/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Fixing the links: Hardening the linker</title>
		<link>https://portcullislabs.github.io/blog/fixing-the-links-hardening-the-linker/</link>
		<comments>https://portcullislabs.github.io/blog/fixing-the-links-hardening-the-linker/#comments</comments>
		<pubDate>Fri, 20 Feb 2015 14:08:36 +0000</pubDate>
		<dc:creator><![CDATA[TMB]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[hardening]]></category>
		<category><![CDATA[UNIX]]></category>

		<guid isPermaLink="false">https://portcullislabs.github.io/?p=5022</guid>
		<description><![CDATA[<p>As many of our regular readers will know, the Portcullis Labs team have a good deal of experience with reviewing the security of POSIX alike OS, and as a result, we&#8217;ve made some interesting discoveries in terms of how easy it can be to escalate ones privileges. As I discussed some time ago at CRESTCon, [&#8230;]</p><p>The post <a href="https://portcullislabs.github.io/blog/fixing-the-links-hardening-the-linker/">Fixing the links: Hardening the linker</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>As many of our regular readers will know, the Portcullis Labs team have a good deal of experience with reviewing the security of POSIX alike OS, and as a result, we&#8217;ve made some interesting discoveries in terms of how easy it can be to escalate ones privileges. As I discussed some time ago at <a href="https://portcullislabs.github.io/presentations/breaking-the-links-exploiting-the-linker/">CRESTCon</a>, one particular avenue of attack that we like is the runtime linker itself. As part of our ongoing research, I&#8217;ve recently issued a <a title="request for comments" href="http://www.openwall.com/lists/oss-security/2015/02/19/9">request for comments</a> for a patch that tackles a number of systemic weaknesses in the Linux (glibc) runtime linker that we often exploit. A few further points on the rationale&#8230;<span id="more-5022"></span></p>
<h2>Why?</h2>
<p>If you take a look over our <a title="advisories" href="https://www.portcullis-security.com/security-research-and-downloads/security-advisories/">advisories</a> page, over the last couple of years I&#8217;ve spent a good deal of time dealing with vendors who, for one reason or another have shipped binaries where it is possible to inject untrusted code into privileged processes, notably but not exclusively via DT_RPATH.</p>
<h2>What&#8217;s the fix?</h2>
<p>More often than not, the underlying issue is an empty element within the DT_RPATH header or equivalent. Sometimes it&#8217;s not, but even in those cases, it is largely that one or more elements isn&#8217;t qualified (i.e. it doesn&#8217;t start with /). The <a title="patch" href="https://www.nth-dimension.org.uk/utils/get.php?downloadsid=100">patch</a> I have circulated fixes this, by causing the runtime linker to ignore any elements of DT_RPATH and LD_LIBRARY_PATH that do not start with a /, and/or junk any use of dlopen() where the filename is likewise unqualified.</p>
<h2>Won&#8217;t this break stuff?</h2>
<p>Maybe (certainly it is means a change to glibc behavior), but more often than not, the fact that a given binary currently works in an unsafe way is a bug &#8211; and an exploitable one at that. Moreover, Solaris has had a similar sanity check (in their case only for privileged setUID binaries) for a good number of years without serious incident. I believe we should be fixing software that exhibits the behavior I&#8217;ve described, but this patch will (I think) kill the bug class irrespective of that.</p>
<p>I&#8217;ve already had some useful <a title="feedback" href="http://www.openwall.com/lists/oss-security/2015/02/20/3">feedback</a> about non-privileged use cases that would be affected by the change. It would be dead easy only to use the part of the patch that rejects unsafe linker paths for setUID binaries only. However, as I have said, that offers less protection. I&#8217;d like to make the patch consumable and indeed, I&#8217;m leaning towards having $RELATIVE (new) and $ORIGIN honoured when the binary isn&#8217;t setUID.</p>
<h2>Further thoughts?</h2>
<p>The patch I have submitted is the most robust variant I&#8217;ve produced in that it kills unqualified linker paths, irrespective of the privileges with which the affected binary is executed. We could kill the checks for non-setUID binaries or we could add some additional errors in such cases. I did experiment with only checking a subset of cases (namely where LD_LIBRARY_PATH itself is set) if the process wasn&#8217;t privileged, but in the end, I concluded that the loading of any unqualified linker path could provide an exploit vector (if the non-setUID binary is executed from a privileged process etc) and so erred on the side of caution. A useful variant of my patch for auditors is one that logs dangerous conditions rather than reject them outright, but I&#8217;m unconvinced that it is helpful for the masses.</p>
<p>The next step will be (once I have digested the views of the oss-security community) to submit it directly to the glibc maintainers. Sharing it with security folk (who may well wear slightly more positive hats to begin with) seemed like a safe place to start but a fix that no one uses does not offer any real value.</p>
<p>The post <a href="https://portcullislabs.github.io/blog/fixing-the-links-hardening-the-linker/">Fixing the links: Hardening the linker</a> appeared first on <a href="https://portcullislabs.github.io">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://portcullislabs.github.io/blog/fixing-the-links-hardening-the-linker/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
