<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Portcullis Labs &#187; MiTM</title>
	<atom:link href="https://labs.portcullis.co.uk/tag/mitm/feed/" rel="self" type="application/rss+xml" />
	<link>https://labs.portcullis.co.uk</link>
	<description>Research and Development</description>
	<language>en-US</language>
		<sy:updatePeriod>hourly</sy:updatePeriod>
		<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.8.5</generator>
	<item>
		<title>Playback: A TLS 1.3 story</title>
		<link>https://labs.portcullis.co.uk/presentations/playback-a-tls-1-3-story-2/</link>
		<comments>https://labs.portcullis.co.uk/presentations/playback-a-tls-1-3-story-2/#comments</comments>
		<pubDate>Mon, 13 Aug 2018 06:28:32 +0000</pubDate>
		<dc:creator><![CDATA[AGA]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[Black Hat USA]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[DEF CON]]></category>
		<category><![CDATA[exploit]]></category>
		<category><![CDATA[MiTM]]></category>
		<category><![CDATA[SSL]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=6781</guid>
		<description><![CDATA[<p>Presentation on 0-RTT in TLS 1.3 (as given at DEF CON 26 and Black Hat 2018). TLS 1.3 is the new secure communication protocol that should be already with us. One of its new features is 0-RTT (Zero Round Trip Time Resumption) that could potentially allow replay attacks. This is a known issue acknowledged by [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/presentations/playback-a-tls-1-3-story-2/">Playback: A TLS 1.3 story</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on 0-RTT in TLS 1.3 (as given at DEF CON 26 and Black Hat 2018).<span id="more-6781"></span></p>
<p>TLS 1.3 is the new secure communication protocol that should be already with us. One of its new features is 0-RTT (Zero Round Trip Time Resumption) that could potentially allow replay attacks. This is a known issue acknowledged by the TLS 1.3 specification, as the protocol does not provide replay protections for 0-RTT data, but proposed countermeasures that would need to be implemented on other layers, not at the protocol level. Therefore, the applications deployed with TLS 1.3 support could end up exposed to replay attacks depending on the implementation of those protections.</p>
<p>This talk will describe the technical details regarding the TLS 1.3 0-RTT feature and its associated risks. It will include Proof of Concepts (PoC) showing real-world replay attacks against TLS 1.3 libraries and browsers. Finally, potential solutions or mitigation controls would be discussed that will help to prevent those attacks when deploying software using a library with TLS 1.3 support.</p>
<p>Tools referenced in this talk include:</p>
<ul>
<li><a title="TLS Playback" href="https://github.com/portcullislabs/tlsplayback">TLS Playback</a></li>
</ul>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-1').click();">
  <div class="icon"><a href="https://labs.portcullis.co.uk/download/us-18-GarciaAlguacil_MurilloMoya-Playback_A_TLS_1.3_Story__v6.pdf" target="_blank" title="Download Us-18-GarciaAlguacil MurilloMoya-Playback A TLS 1.3 Story  V6"><img align="middle" src="https://labs.portcullis.co.uk/wp-includes/images/crystal/document.png" alt="Us-18-GarciaAlguacil MurilloMoya-Playback A TLS 1.3 Story  V6" /></a></div>
  <div class="filetitle">
    <a href="https://labs.portcullis.co.uk/download/us-18-GarciaAlguacil_MurilloMoya-Playback_A_TLS_1.3_Story__v6.pdf" title="Download us-18-GarciaAlguacil_MurilloMoya-Playback_A_TLS_1.3_Story__v6.pdf" target="_blank" id="wpfb-file-link-1">us-18-GarciaAlguacil_MurilloMoya-Playback_A_TLS_1.3_Story__v6.pdf</a>
    
    <br />
    August 13, 2018<br />
    
  </div>
  <div class="info">
    2.6 MiB<br />
    MD5 hash: c56f49adfbda571c9c32f5860d6f9319 <br />
    <a href="#" onclick="return wpfilebase_filedetails(1);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails1" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>August 13, 2018</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://labs.portcullis.co.uk/presentations/playback-a-tls-1-3-story-2/">Playback: A TLS 1.3 story</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/presentations/playback-a-tls-1-3-story-2/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Playback: A TLS 1.3 story</title>
		<link>https://labs.portcullis.co.uk/blog/playback-a-tls-1-3-story/</link>
		<comments>https://labs.portcullis.co.uk/blog/playback-a-tls-1-3-story/#comments</comments>
		<pubDate>Wed, 08 Aug 2018 14:00:00 +0000</pubDate>
		<dc:creator><![CDATA[AGA]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[Black Hat USA]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[DEF CON]]></category>
		<category><![CDATA[MiTM]]></category>
		<category><![CDATA[SSL]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=6776</guid>
		<description><![CDATA[<p>Secure communications are one of the most important topics in information security and the Transport Layer Security (TLS) protocol is currently the most used protocol to provide secure communications on Internet. For example, when you are connecting to your online banking application, your favorite instant message application or social networks, all those communications are being [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/playback-a-tls-1-3-story/">Playback: A TLS 1.3 story</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Secure communications are one of the most important topics in information security and the Transport Layer Security (TLS) protocol is currently the most used protocol to provide secure communications on Internet. For example, when you are connecting to your online banking application, your favorite instant message application or social networks, all those communications are being transmitted using TLS. With TLS the information sent by the browser and the service is secured and encrypted, meaning that the information cannot be modified or tampered with by an attacker. Moreover the communications are verified to ensure that the browser is connected to the right endpoint (e.g. Wikipedia).<span id="more-6776"></span></p>
<p>TLS was born as a substitute of the ancient Secure Sockets Layer (SSL) protocol, which was showing its age and being susceptible to multiple attacks. The first version of TLS, 1.0, was created in 1999 and it was based on SSLv3. Since then TLS 1.1 (2006) and TLS 1.2 (2008) were created to improve previous versions of the protocol, solving some of the security weaknesses that security researchers discovered in the last two decades. </p>
<p>TLS 1.3 is the new protocol version. It is not officially released yet, but it is in the final stage, just waiting for the final approval. In any case, some important vendors and open source projects are currently supporting it. The TLS 1.3 Working Group released multiple iterations (drafts) that refined and improved the protocol in the last four years. One of the outcomes of that hard work is that TLS 1.3 has been simplified compared to previous versions of the protocol and it is not vulnerable to previous known attacks that were affecting previous versions. For example, in TLS 1.2 the number of ciphers supported was high, maybe there were too many, and the Working Group has decided to limit this new version to support only five ciphers. Another example is that with TLS 1.3, forward secrecy is not optional, so, in the case that an attacker manages to steal the private keys of one server, he will not be able to decrypt previous communications as he would not be able to obtain the session keys used to encrypt previous messages.</p>
<p>TLS 1.3 has also introduced a new feature to improve the performance for new connections. The name of this feature is 0-RTT (Zero Round Trip Time Resumption) and it allows to have a fast session resumption that can push data to the server without needing to wait for a server confirmation. This is possible as 0-RTT reuses cryptographic information obtained in the first connection to the server. The following diagram shows how TLS 1.3 0-RTT resumption works:</p>
<div id="attachment_6778" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-6777"><div class="lb-album"><a href="#image-6777"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2018/08/0rtt_handshake_99_full_white_background-300x202.png" alt="0RTT handshake state diagram" class="size-medium wp-image-6778"><span></span></a></div>              
<a href="#imageclose-6777" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-6777">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2018/08/0rtt_handshake_99_full_white_background.png" alt="image-6777">
                   </div></a><p class="wp-caption-text">0RTT handshake state diagram</p></div>
<p>This is an interesting functionality from the point of view of the performance, but it has some known security implications.  </p>
<p>Cisco security consultants <a title="Alfonso Garcia Alguacil" href="https://labs.portcullis.co.uk/author/aga/">Alfonso Garcia Alguacil</a> and <a title="Alejo Murillo Moya" href="https://labs.portcullis.co.uk/author/amm/">Alejo Murillo Moya</a> will deliver a presentation about some of the known security implications of using 0-RTT and will show Proof of Concepts (PoCs) of some attacks in real world environments. The intent is to raise awareness across the security community about that new feature. The presentation is named &#8220;Playback: A TLS 1.3 story&#8221; and it will be presented at <a title="Black Hat USA 18" href="https://www.blackhat.com/us-18/briefings.html#playback-a-tls-1.3-story">Black Hat USA 18</a> and <a href="https://www.defcon.org/html/defcon-26/dc-26-speakers.html#García">DEF CON 26</a>. Attendees will learn about TLS 1.3 0-RTT, see some examples about how an attacker could take advantage of that new feature and finally get an understanding of the security implications of enabling the featu</re and how it could be used safely minimizing any potential security impacts.</p>
<p>You can find the slides and tool from this presentation here:</p>
<ul>
<li><a title="Playback: A TLS 1.3 story" href="/presentations/playback-a-tls-1-3-story-2/">Playback: A TLS 1.3 story</a></li>
</ul>
<p>The post <a href="https://labs.portcullis.co.uk/blog/playback-a-tls-1-3-story/">Playback: A TLS 1.3 story</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/playback-a-tls-1-3-story/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>SSL/TLS Hipsterism</title>
		<link>https://labs.portcullis.co.uk/presentations/ssltls-hipsterism/</link>
		<comments>https://labs.portcullis.co.uk/presentations/ssltls-hipsterism/#comments</comments>
		<pubDate>Fri, 17 Nov 2017 10:44:40 +0000</pubDate>
		<dc:creator><![CDATA[GCS]]></dc:creator>
				<category><![CDATA[Presentations]]></category>
		<category><![CDATA[conference]]></category>
		<category><![CDATA[MiTM]]></category>
		<category><![CDATA[Securi-Tay]]></category>
		<category><![CDATA[SSL]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=6147</guid>
		<description><![CDATA[<p>Presentation on finding implementation* bugs outside the mainstream (as given at Securi-Tay 2017). A lot of fantastic work has gone into the discovery, analysis, and (on occasion) marketing of SSL/TLS vulnerabilities. Some, such as BEAST and LUCKY13, are issues in the protocol itself. Other bugs, however, affect individual implementations of this complicated and nuanced protocol. [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/presentations/ssltls-hipsterism/">SSL/TLS Hipsterism</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Presentation on finding implementation* bugs outside the mainstream (as given at Securi-Tay 2017).<span id="more-6147"></span></p>
<p>A lot of fantastic work has gone into the discovery, analysis, and (on occasion) marketing of SSL/TLS vulnerabilities. Some, such as BEAST and LUCKY13, are issues in the protocol itself. Other bugs, however, affect individual implementations of this complicated and nuanced protocol. This talk will discuss an approach for identifying security bugs in SSL/TLS server implementations, outside the mainstream well-publicised issues that we all know so well.</p>
<p>Tools referenced in this talk include:</p>
<ul>
<li><a title="sslxray" href="https://github.com/portcullislabs/sslxray">sslxray</a></li>
</ul>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-2').click();">
  <div class="icon"><a href="https://labs.portcullis.co.uk/download/STHST.pptx" target="_blank" title="Download STHST"><img align="middle" src="https://labs.portcullis.co.uk/wp-includes/images/crystal/interactive.png" alt="STHST" /></a></div>
  <div class="filetitle">
    <a href="https://labs.portcullis.co.uk/download/STHST.pptx" title="Download STHST.pptx" target="_blank" id="wpfb-file-link-2">STHST.pptx</a>
    
    <br />
    November 16, 2017<br />
    
  </div>
  <div class="info">
    1.0 MiB<br />
    MD5 hash: 503a77150111d59a0352c27a62195c4c <br />
    <a href="#" onclick="return wpfilebase_filedetails(2);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails2" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>November 16, 2017</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<p>The post <a href="https://labs.portcullis.co.uk/presentations/ssltls-hipsterism/">SSL/TLS Hipsterism</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/presentations/ssltls-hipsterism/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Downgrading RDP connections and how to avoid it</title>
		<link>https://labs.portcullis.co.uk/blog/downgrading-rdp-connections-and-how-to-avoid-it/</link>
		<comments>https://labs.portcullis.co.uk/blog/downgrading-rdp-connections-and-how-to-avoid-it/#comments</comments>
		<pubDate>Fri, 22 Apr 2016 15:18:17 +0000</pubDate>
		<dc:creator><![CDATA[MRL]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[cryptography]]></category>
		<category><![CDATA[MiTM]]></category>
		<category><![CDATA[RDP]]></category>
		<category><![CDATA[red team]]></category>
		<category><![CDATA[Windows]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=1488</guid>
		<description><![CDATA[<p>This post describes how Remote Desktop Protocol (RDP) connections can be vulnerable to a downgrade attack if Terminal Servers are configured insecurely. We&#8217;re not aware of this issue being discussed before &#8211; googling only found pages about installing an earlier version of the RDP client, not about downgrading the protocol in the way described here. [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/downgrading-rdp-connections-and-how-to-avoid-it/">Downgrading RDP connections and how to avoid it</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>This post describes how Remote Desktop Protocol (RDP) connections can be vulnerable to a downgrade attack if Terminal Servers are configured insecurely.<span id="more-1488"></span></p>
<p>We&#8217;re not aware of this issue being discussed before &#8211; googling only found pages about installing an earlier version of the RDP client, not about downgrading the protocol in the way described here.  We suspect that it&#8217;s a known limitation of the protocol.  But it&#8217;s one that we though would be interesting to post about.</p>
<p>In this post we provide a demonstration of such a downgrade attack using the aptly named PoC tool rdp-downgrade.py.</p>
<h2>RDP Security Layer</h2>
<p>Before discussing the downgrade attack, we should outline what we&#8217;ll be downgrading from and to.</p>
<p>The following Security Layers are available in the RDP protocol. Support for each can be configured on the Terminal Server:</p>
<ul>
<li>Classic RDP Protocol - this is known as &#8220;RDP Security Layer&#8221; in the tscc.msc configuration tool and PROTOCOL_RDP in the <a title="protocol specification" href="http://msdn.microsoft.com/en-us/library/cc240445.aspx">protocol specification</a> (see page 40 of PDF)</li>
<li>SSL - this is labelled &#8220;SSL&#8221; or &#8220;SSL (TLS 1.0)&#8221; in the GUI and called PROTOCOL_SSL in the protocol specification</li>
<li>CredSSP - this is what you get when you check the &#8221;Network Layer Authentication&#8221; box. It also uses uses SSL. It is called PROTOCOL_HYBRID in protocol specification</li>
</ul>
<p>The first option is the insecure one. If this protocol were to be negotiated, the connection would be vulnerable to a <a title="well known &quot;Man-In-The-Middle&quot; attack" href="http://www.oxid.it/ca_um/topics/apr-rdp.htm">well known &#8220;Man-In-The-Middle&#8221; attack</a>.  Essentially, someone carrying out this attack would be able to see all your key strokes and any other data passed between client and server. This will therefore be the protocol we&#8217;ll be downgrading to.</p>
<p>The last two options are both SSL-wrapped and are more secure.  It will be these protocols that we&#8217;ll be downgrading from.</p>
<h2>How to tell which security layer you connected with</h2>
<p>The various warnings displayed by the Terminal Services client, mstsc.exe can be used as a crude way to identify which protocol is being used.</p>
<h3>Classic RDP</h3>
<p>Note that the warning message about not being able to authenticate the server tallies with the MiTM attack described above.</p>
<div id="attachment_1497" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-1489"><div class="lb-album"><a href="#image-1489"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/classic-rdp-300x180.jpg" alt="classic-rdp" class="size-medium wp-image-1497"><span></span></a></div>              
<a href="#imageclose-1489" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1489">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/classic-rdp.jpg" alt="image-1489">
                   </div></a><p class="wp-caption-text">Warning For Classic RDP Connections</p></div>
<h3>SSL</h3>
<p>Unless you&#8217;ve configured your host to trust the SSL certificate of the RDP server, you&#8217;ll see a certificate warning like this one:</p>
<div id="attachment_1496" style="width: 267px" class="wp-caption alignnone"><a name="imageclose-1490"><div class="lb-album"><a href="#image-1490"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/ssl-warning-257x300.png" alt="ssl-warning" class="size-medium wp-image-1496"><span></span></a></div>              
<a href="#imageclose-1490" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1490">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/ssl-warning.png" alt="image-1490">
                   </div></a><p class="wp-caption-text">Warning for (Non-CredSSP) SSL Connections</p></div>
<h3>CredSSP (NLA + SSL)</h3>
<p>You get prompted for your username and password by a pop-up window &#8211; whereas Classic RDP and SSL both use a full Windows Desktop for password entry.</p>
<div id="attachment_1498" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-1491"><div class="lb-album"><a href="#image-1491"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/gaejegba-300x255.png" alt="gaejegba" class="size-medium wp-image-1498"><span></span></a></div>              
<a href="#imageclose-1491" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1491">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/gaejegba.png" alt="image-1491">
                   </div></a><p class="wp-caption-text">Dialogue Box For NLA Connections</p></div>
<h2>Vulnerable configuration</h2>
<p>Terminal Servers set to negotiate their Security Layer are potentially vulnerable to a downgrade attack. Here we view the settings on a Windows 2003 server, but this also holds for newer versions of Windows:</p>
<p><a name="imageclose-1492"><div class="lb-album"><a href="#image-1492"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-vulnerable-300x235.png" alt="2003-rdp-setting-vulnerable" class="alignnone size-medium wp-image-1491"><span></span></a></div>              
<a href="#imageclose-1492" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1492">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-vulnerable.png" alt="image-1492">
                   </div></a></p>
<h2>The downgrade attack</h2>
<p>We will connect to a Windows 2003 RDP server configured to &#8220;Negotiate&#8221; its Security Layer.  We&#8217;ll connect from a modern windows system that supports Classic RDP, SSL and NLA. This server only supports Classic RDP and SSL. As we&#8217;d hope, the two will normally negotiate the most secure option supported by both: SSL.</p>
<p>During this attack we will modify network traffic to make the server believe the client only supports Classic RDP. We could intercept traffic using ARP-poisoning or DNS spoofing or some other method.</p>
<p>After connecting to TCP port 3389, the client (mstsc) sends data similar to the following (shown in hex):</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
03 00 00 13 0e e0 00 00 00 00 00 01 00 08 00 *03* 00 00 00
</pre>
<p>The 03 is the protocols supported by the client. Several values are possible in this position:</p>
<ul>
<li>00 &#8211; Only Classic RDP is supported</li>
<li>01 &#8211; SSL is supported in addition to Classic RDP.</li>
<li>03 &#8211; CredSSP is supported in addition to the other two protocols.</li>
</ul>
<p>This is described on page 37 of the <a title="protocol specification" href="http://msdn.microsoft.com/en-us/library/cc240445.aspx">protocol specification</a>.</p>
<p>So our proof-of-concept simply replaces the 03 with 00 to cause the client and server to negotiate Classic RDP instead of SSL.</p>
<p>We set our tool listening on 192.168.190.170 on TCP port 3389. We instruct it to forward traffic to 192.168.2.96.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ python rdp-downgrade.py 192.168.2.96
[Proxy] Listening for connections on 0.0.0.0:3389
</pre>
<p>Rather than actually doing ARP-spoofing, I just connect directly to the &#8220;Man-In-The-Middle&#8221; in this demo:</p>
<div style="width: 310px" class="wp-caption alignnone"><a name="imageclose-1493"><div class="lb-album"><a href="#image-1493"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/rdp-attack-prior-to-logon-300x177.jpg" alt="rdp-attack-prior-to-logon" ><span></span></a></div>              
<a href="#imageclose-1493" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1493">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/rdp-attack-prior-to-logon.jpg" alt="image-1493">
                   </div></a><p class="wp-caption-text">Attacker IP Address Is Entered</p></div>
<p>Back in our PoC tool, we then see an incoming connection from the RDP client (192.168.190.1) and the proxy making an outgoing connection to the target server:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
[Proxy] Incoming connection from 192.168.190.1:58715
[Proxy] New outgoing request to 192.168.2.96:3389
[Proxy] Connected
</pre>
<p>Next we see 19 bytes from the client &#8211; note the 03 near the end of the data from the client. This is recognised by our PoC tool and it prints a message to inform us the 03 has been changed to 00:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
[From 192.168.190.1] Received 19 bytes
0000 03 00 00 13 0E E0 00 00 00 00 00 01 00 08 00 03 ................
0010 00 00 00 ...
[From 192.168.190.1] Modified data to downgrade connection
</pre>
<p>Then we see traffic flow freely without further modification:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
[From 192.168.2.96] Received 19 bytes
0000 03 00 00 13 0E D0 00 00 12 34 00 02 00 08 00 00 .........4......
0010 00 00 00 ...
...snip...
</pre>
<p>mstsc shows us the warning message corresponding to a Classic RDP connection, proving that the downgrade has been successful &#8211; remember that we would normally expect a certificate warning for the SSL-wrapped RDP connection.</p>
<div id="attachment_1497" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-1489"><div class="lb-album"><a href="#image-1489"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/classic-rdp-300x180.jpg" alt="classic-rdp" class="size-medium wp-image-1497"><span></span></a></div>              
<a href="#imageclose-1489" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1489">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/classic-rdp.jpg" alt="image-1489">
                   </div></a><p class="wp-caption-text">Warning Message For Classic RDP Connection</p></div>
<h2>Conclusion</h2>
<p>Configuring the Terminal Server to use SSL for it security layer instead of &#8220;Negotiate&#8221; prevents such a downgrade attack.</p>
<h2>Vendor contact</h2>
<p>We were not sure if Microsoft would consider this worthy of a security advisory. We didn&#8217;t think so, but sent them a preview of this post before publishing and asked.</p>
<p>Microsoft who responded swiftly to confirm that &#8220;After researching the issue, we consider this behavior to be By Design&#8221;. They thanked us for our commitment to co-ordinated disclosure and gave their blessing to proceed with publication.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/downgrading-rdp-connections-and-how-to-avoid-it/">Downgrading RDP connections and how to avoid it</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/downgrading-rdp-connections-and-how-to-avoid-it/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Locating SAT based C&amp;Cs</title>
		<link>https://labs.portcullis.co.uk/blog/locating-sat-based-ccs/</link>
		<comments>https://labs.portcullis.co.uk/blog/locating-sat-based-ccs/#comments</comments>
		<pubDate>Wed, 28 Oct 2015 11:45:47 +0000</pubDate>
		<dc:creator><![CDATA[LNE]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[Black Hat]]></category>
		<category><![CDATA[blue team]]></category>
		<category><![CDATA[MiTM]]></category>
		<category><![CDATA[routing]]></category>
		<category><![CDATA[satellite]]></category>
		<category><![CDATA[seaairandland]]></category>
		<category><![CDATA[Turla]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=5280</guid>
		<description><![CDATA[<p>Recently, Kaspersky published a research about how a russian APT group use hijacked satellite links to anonymise their malware command-and-control (C&#38;C) servers (Satellite Turla: APT Command and Control in the Sky). As they say in their blog post, I researched and published how to abuse satellite DVB-S/2 internet communications, the technique used during the Epic [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/locating-sat-based-ccs/">Locating SAT based C&#038;Cs</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>Recently, Kaspersky published a research about how a russian APT group use hijacked satellite links to anonymise their malware command-and-control (C&amp;C) servers (<a title="Satellite Turla: APT Command and Control in the Sky" href="https://securelist.com/blog/research/72081/satellite-turla-apt-command-and-control-in-the-sky/">Satellite Turla: APT Command and Control in the Sky</a>). As they say in their blog post, I researched and published <a title="how to abuse satellite DVB-S/2 internet communications" href="https://www.blackhat.com/presentations/bh-dc-10/Nve_Leonardo/BlackHat-DC-2010-Nve-Playing-with-SAT-1.2-slides.pdf">how to abuse satellite DVB-S/2 internet communications</a>, the technique used during the <a title="Epic Turla operation" href="https://securelist.com/analysis/publications/65545/the-epic-turla-operation/">Epic Turla operation</a>.<span id="more-5280"></span></p>
<h2>Short explanation</h2>
<p>Satellite DVB-S/2 connections are, sometimes, unencrypted so with cheap hardware and some free software the downlink can be sniffed. By using the satellite as the downlink of an Internet connection, an attacker can use another connection which let to spoof IP address as a uplink and then have a hijacked IP from the satellite provider to use as a normal one and almost completely anonymous.</p>
<p><a name="imageclose-5281"><div class="lb-album"><a href="#image-5281"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg8-300x167.png" alt="Anonymous satellite-based Internet" class="alignnone size-medium wp-image-5301"><span></span></a></div>              
<a href="#imageclose-5281" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5281">
                   <img src="/wp-content/uploads/2015/09/rimg8.png" alt="image-5281">
                   </div></a></p>
<p>One good thing about this technique is to have an anonymous broadband connection directly to the attackers base/home/server/laptop without proxies/bouncers &#8211; if you have ever used TOR, you&#8217;ll probably realise know how useful these characteristics can be.</p>
<p>In summary, the attackers were using satellite link to anonymise their activities and prevent them being tracked. In this blog post I&#8217;ll show some ideas to track malicious agents trying to hide behind satellite links.</p>
<h2>The anonymous connection</h2>
<p>What to do when these connections are being used for &#8220;bad things&#8221;? I have also tried to research about different ways to locate these rogue connections. Here are a few ideas on how to solve this challenge:</p>
<h3>The attacker connection is also vulnerable to attacks</h3>
<p>If an attacker is using a connection vulnerable to sniffing and &#8220;Man-In-The-Middle&#8221; attacks, the communication stay vulnerable, so we can attack these:</p>
<p><a name="imageclose-5282"><div class="lb-album"><a href="#image-5282"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg2-300x167.png" alt="Sniffing Information" class="alignnone size-medium wp-image-5307"><span></span></a></div>              
<a href="#imageclose-5282" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5282">
                   <img src="/wp-content/uploads/2015/09/rimg2.png" alt="image-5282">
                   </div></a></p>
<p><span style="line-height: 1.5em;">Hijack communications with the systems the attacker is connecting with.</span></p>
<p>If the attacker navigate through HTTP, in some circumstances we can inject HTML or JavaScript code to get information of the target system.</p>
<p>Sometimes we can inject fake executable, ActiveX or Applets and try to cheat the attacker.</p>
<p>If the attacker system is configured as I proposed in my talk, that system can be reached with an satellite IP address, we can try to attack it.</p>
<p>Definitely these attacks can provide us information about the attacker but, most probably, not an address or a name.</p>
<h3>Attack the network</h3>
<p>Let&#8217;s redraw again the network diagram:</p>
<p><a name="imageclose-5283"><div class="lb-album"><a href="#image-5283"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg7-300x167.png" alt="Bigger net diagram" class="alignnone size-medium wp-image-5302"><span></span></a></div>              
<a href="#imageclose-5283" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5283">
                   <img src="/wp-content/uploads/2015/09/rimg7.png" alt="image-5283">
                   </div></a></p>
<p>Here I draw R1 and R2, which are the routers of the ISP the attacker is using as the uplink channel of the hijacked satellite-based connection.</p>
<p>It&#8217;s not possible to get an IP address of the attacker because it is configured with the hijacked IP address, but, is it possible to get the IP address of R1 or R2? Getting that information can be really useful in the hunting of an attacker, remember that the target must use a local internet connection as uplink.</p>
<p>How can we get router IP addresses?</p>
<p>We can wait till the attacker do a traceroute, that can be a lot of time. We can´t control the TTL of an IP packet leaving the target host so let´s think in other way.</p>
<h4>Record route</h4>
<p>Another option is to ping the target and activate the record route option on IP, you can do that using hping:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
# hping3 -1 IPsat -G
</pre>
<p>The record route option provides a means to record the route of an Internet packet. When an Internet module routes a packet it checks to see if the record route option is present. If it is, it inserts its own Internet address as known in the environment into which this packet is being forwarded into the recorded route.</p>
<p>We have it? No, this option must be activated in all routing devices, from you to the target and back, and usually this option is disabled &#8211; in a lot of years doing pentesting, I have only seen it work in a small fraction of cases.</p>
<h4>ICMP errors</h4>
<p>Another option I found with possibilities is to create IP traffic rejected by the uplink ISP routers (R1 or R2), and sniff the ICMP Destination Unreachable packets to get the IP of R1 or R2.</p>
<p>For example, pinging the satellite IP of the target from an internal address, the remote system will respond to the private IP echo with a ICMP echo response. If the traffic to that internal subnet is rejected by the uplink ISP routers, and usually it is, the routers will send an ICMP error to the satellite IP from the router own IP, so we can sniff that ICMP packet and get the IP address:</p>
<ol>
<li>We send a ping request spoofing the source address:
<pre class="brush: bash; gutter: false; title: ; notranslate">
# hping3 -1 IPsat -a 10.30.16.41
</pre>
<p><a name="imageclose-5284"><div class="lb-album"><a href="#image-5284"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg4-300x167.png" alt="Send spoofed PING" class="alignnone size-medium wp-image-5305"><span></span></a></div>              
<a href="#imageclose-5284" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5284">
                   <img src="/wp-content/uploads/2015/09/rimg4.png" alt="image-5284">
                   </div></a></li>
<li>The target system send a ping response to 10.30.16.41:<a name="imageclose-5285"><div class="lb-album"><a href="#image-5285"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg5-300x168.png" alt="Ping response from target host" class="alignnone size-medium wp-image-5304"><span></span></a></div>              
<a href="#imageclose-5285" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5285">
                   <img src="/wp-content/uploads/2015/09/rimg5.png" alt="image-5285">
                   </div></a></li>
<li>Traffic to 10.30.16.41 is not allowed so the packet is rejected by R1 to IPsat, so we can sniff that packet and know the IP of R1:<a name="imageclose-5286"><div class="lb-album"><a href="#image-5286"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg6-300x167.png" alt="ICMP Dest Unreachable" class="alignnone size-medium wp-image-5303"><span></span></a></div>              
<a href="#imageclose-5286" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-5286">
                   <img src="/wp-content/uploads/2015/09/rimg6.png" alt="image-5286">
                   </div></a></li>
</ol>
<p>Some problems we find to use this technique:</p>
<p>What private IP addresses are rejected? We have to send several packets to the IP of the target, 69781, one packet per private C range or 17891228 which is the number of all private IP addressed.</p>
<p><img class="alignnone  wp-image-5300" title="Private IPs" alt="Private IPs" src="https://labs.portcullis.co.uk/wp-content/uploads/2015/09/rimg9-1024x188.png" width="574" height="106" /></p>
<p>What if the private IP addressed are filtered and not rejected? Bad luck.</p>
<p>The target host filter packets which come from private IP addresses via satellite interface? Bad luck.</p>
<p>What if the target host have filtered the ICMP ping? Please&#8230;</p>
<p>The idea of the target sending traffic to internal IP addresses can be exploited from several angles, for example, injecting malicious JavaScript on the targets browsers if he use it. Imagination! Imagination! Imagination!</p>
<h2>Conclusion</h2>
<p>So, if the attacker who is hijacking the satellite Internet connection is clever enough, this kind of connections are still anonymous. But, as I thought some attacks to break the anonymity, sure you people can follow this way.</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/locating-sat-based-ccs/">Locating SAT based C&#038;Cs</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/locating-sat-based-ccs/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>SSL &#8220;Man-In-The-Middle&#8221; attacks on RDP</title>
		<link>https://labs.portcullis.co.uk/blog/ssl-man-in-the-middle-attacks-on-rdp/</link>
		<comments>https://labs.portcullis.co.uk/blog/ssl-man-in-the-middle-attacks-on-rdp/#comments</comments>
		<pubDate>Tue, 04 Mar 2014 09:30:49 +0000</pubDate>
		<dc:creator><![CDATA[MRL]]></dc:creator>
				<category><![CDATA[Blog]]></category>
		<category><![CDATA[MiTM]]></category>
		<category><![CDATA[RDP]]></category>
		<category><![CDATA[SSL]]></category>

		<guid isPermaLink="false">https://labs.portcullis.co.uk/?p=1510</guid>
		<description><![CDATA[<p>This post seeks to demonstrate why users learning to ignore those certificate warnings for SSL-based RDP connection could leave them open to &#8220;Man-In-The-Middle&#8221; attacks. The MiTM attack demonstrated displays keystrokes sent during an RDP session. We conclude with some advice on how to avoid being the victim of such an attack. Types of RDP connections [&#8230;]</p><p>The post <a href="https://labs.portcullis.co.uk/blog/ssl-man-in-the-middle-attacks-on-rdp/">SSL &#8220;Man-In-The-Middle&#8221; attacks on RDP</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></description>
				<content:encoded><![CDATA[<p>This post seeks to demonstrate why users learning to ignore those certificate warnings for SSL-based RDP connection could leave them open to &#8220;Man-In-The-Middle&#8221; attacks. The MiTM attack demonstrated displays keystrokes sent during an RDP session. We conclude with some advice on how to avoid being the victim of such an attack.<span id="more-1510"></span></p>
<h2>Types of RDP connections</h2>
<p>Before we start, let&#8217;s first clarify which of the various RDP connection types this post is about. There are 3 types of connection:</p>
<ul>
<li>RDP Security Layer</li>
<li>SSL (TLS 1.0)</li>
<li>CredSSP (SSL with NLA)</li>
</ul>
<p>It&#8217;s the middle one we&#8217;ll demonstrate an attack on in this post. On the Terminal Server, SSL is configured like this (with any NLA checkboxes unticked):</p>
<div id="attachment_1492" style="width: 310px" class="wp-caption alignnone"><a href="https://labs.portcullis.co.uk/?attachment_id=1492" rel="attachment wp-att-1492"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-not-vulnerable-300x233.png" alt="RDP configuration used" width="300" height="233" class="size-medium wp-image-1492" /></a><p class="wp-caption-text">RDP configuration used</p></div>
<div id="attachment_1492" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-1511"><div class="lb-album"><a href="#image-1511"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-not-vulnerable-300x233.png" alt="2003-rdp-setting-not-vulnerable" class="size-medium wp-image-1492"><span></span></a></div>              
<a href="#imageclose-1511" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1511">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/2003-rdp-setting-not-vulnerable.png" alt="image-1511">
                   </div></a><p class="wp-caption-text">RDP configuration used</p></div>
<p>Some connections may also be vulnerable if the server is set to &#8220;Negotiate&#8221; its Security Layer to &#8211; as that could result in SSL being used.</p>
<h2>SSL certificate warning</h2>
<p>If users are used to dismissing a warnings like this one each time they connect, then this post is relevant to them:</p>
<div id="attachment_1496" style="width: 267px" class="wp-caption alignnone"><a name="imageclose-1512"><div class="lb-album"><a href="#image-1512"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/ssl-warning-257x300.png" alt="ssl-warning" class="size-medium wp-image-1496"><span></span></a></div>              
<a href="#imageclose-1512" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1512">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/ssl-warning.png" alt="image-1512">
                   </div></a><p class="wp-caption-text">SSL warning that should not be routinely ignored</p></div>
<h2>Attack overview</h2>
<p>At a high level, the attack will proceed in a similar way to any SSL MiTM attack:</p>
<ol>
<li>Have the victim connect to a PoC tool (rdp-ssl-mitm.py) on our system instead of the RDP server they&#8217;re trying to reach</li>
<li>Using the RDP protocol, our tool will negotiate the use of SSL</li>
<li>At the point the connection is upgraded to SSL, our tool will negotiate an SSL connection with the RDP client using its own (untrusted) SSL certificate. This will give our tool access to data sent by the RDP client in cleartext</li>
<li>Our tool also needs to create an SSL connection with the legitimate RDP server down which it will send data from the RDP client</li>
</ol>
<p>The only complication to this attack is that our tool has to talk the RDP protocol briefly before creating the required SSL connections.</p>
<h3>1. Having the victim connect to us</h3>
<p>In a real attack, we&#8217;d need to have the RDP client connect to our system instead of the target server. This could be achieved using ARP spoofing, DNS spoofing or some other method. Rather than cloud the demonstration with such details, we&#8217;ll assume this is step is possible and just type the IP address of the attacker system into the victim RDP client.</p>
<p>On our attacker system (192.168.190.170), we start our PoC tool. We tell it forward connections to the legitimate RDP server 192.168.2.96:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ ./rdp-ssl-mitm.py -r 192.168.2.96:3389
[+] Listening for connections on 0.0.0.0:3389
</pre>
<p>And we simply enter the IP address of the attacker system into the RDP client (the client connects from 192.168.190.1):</p>
<div id="attachment_1495" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-1513"><div class="lb-album"><a href="#image-1513"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/rdp-attack-prior-to-logon-300x177.jpg" alt="rdp-attack-prior-to-logon" class="size-medium wp-image-1495"><span></span></a></div>              
<a href="#imageclose-1513" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1513">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/rdp-attack-prior-to-logon.jpg" alt="image-1513">
                   </div></a><p class="wp-caption-text">We enter the attacker IP address to avoid the complexity of ARP spoofing</p></div>
<h3>2. Talk RDP to the client to negotiate the use of SSL</h3>
<p>The negotiation of SSL is quite short within the RDP protocol:</p>
<p>Message #1: Client > MiTM > Server</p>
<pre class="brush: plain; gutter: false; highlight: [1]; title: ; notranslate">
03 00 00 13 0e e0 00 00 00 00 00 01 00 08 00 *03*
00 00 00
</pre>
<p>This message is fairly static and our tool just passes it through to the server unaltered. The *03* means that the client supports RDP Security Layer, SSL and CredSSP.</p>
<p>Message #2: Server > MiTM > Client</p>
<pre class="brush: plain; gutter: false; highlight: [1]; title: ; notranslate">
03 00 00 13 0e d0 00 00 12 34 00 02 00 08 00 *01*
00 00 00
</pre>
<p>In the next message the server chooses the protocol to use. The *01* in this case means the the server has chosen SSL (not CredSSP which would be *02*). Again, we pass this message back to the client unaltered.</p>
<p>Note that if the server were to select CredSSP (*02*), then the demonstration would fail. We&#8217;re attacking SSL, not CredSSP.</p>
<h3>3. Create SSL connection with RDP client</h3>
<p>Message #3: Client > MiTM</p>
<p>The 3rd message is the start of an SSL connection. Here is the SSL Client Hello message beginning *16 03 01*&#8230; (03 01 being the version of SSL used: SSL 3.1 AKA TLS 1.0).</p>
<pre class="brush: plain; gutter: false; highlight: [1]; title: ; notranslate">
*16 03 01* 00 5a 01 00 00 56 03 01 52 21 ac be 63
20 ce de 4b a5 90 18 f0 66 97 ee 9d 54 14 e3 1c
... snip ...
</pre>
<p>Our tool does not forward this data directly to the server. Instead it responds with a &#8220;SSL Server Hello&#8221; message and proceeds to complete the SSL connection with the client.</p>
<p>The SSL certificate we present to the RDP client is issued to fred and this is displayed in the mstsc SSL warning shown to the user:</p>
<div id="attachment_1517" style="width: 265px" class="wp-caption alignnone"><a name="imageclose-1514"><div class="lb-album"><a href="#image-1514"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/fred-255x300.jpg" alt="fred" class="size-medium wp-image-1517"><span></span></a></div>              
<a href="#imageclose-1514" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-1514">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/08/fred.jpg" alt="image-1514">
                   </div></a><p class="wp-caption-text">The certificate presented by our PoC tool causes this security warning</p></div>
<p>The details of the SSL certificate differ to those the user would normally see &#8211; if the user were to check. To refine the attack we could make the certificate details match more closely, but we&#8217;d never get the signature to be the same as the normal certificate, so there&#8217;d always be a difference.</p>
<h3>4. Create SSL connection with RDP server</h3>
<p>Simultaneously, our tool also sends and SSL Client Hello to the RDP server and creates a second SSL connection.</p>
<h2>Displaying key strokes</h2>
<p>Our tool is now in a position to display the cleartext messages about keystrokes (for example) sent by the RDP client. It is relatively easy to determine what sort of message is sent when a key is pressed. The following two 4-byte messages are sent when the &#8216;p&#8217; key is pressed:</p>
<pre class="brush: plain; gutter: false; title: ; notranslate">
44 04 00 19
44 04 01 19
</pre>
<p>The 3rd byte is the direction of key (00 means key-down, 01 means key-up).  The 4th byte is the key scan code.  If we <a title="look up" href="http://msdn.microsoft.com/en-us/library/aa299374%28v=vs.60%29.aspx">look up</a> 0&#215;19 we find it corresponds to the p key.</p>
<p>In the general case, the scan-code to character mapping depends which keyboard you&#8217;re using. In the PoC tool I implemented the mapping for for QWERTY keyboards, so if you have a UK/US keyboard, it should translate the majority of scan-codes to the correct characters. Note that we don&#8217;t get know whether characters are uppercase or lowercase. We&#8217;d have to manually track the status of CAPS Lock and SHIFT keys.</p>
<p>Without getting too bogged down in the details, here&#8217;s some sample output from the PoC tool that shows keystrokes being logged &#8211; in particular an administrator logging in with username Administrator, password Password:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate">
$ ./rdp-ssl-mitm.py -r 192.168.2.96:3389 
[+] Listening for connections on 0.0.0.0:3389
[+] Incoming connection from 192.168.190.1:60370
[+] New outgoing request to 192.168.2.96:3389 (SSL: 0)
[+] Connected
[+] Detected incoming SSL connection. Turning self into SSL socket
[+] Incoming connection from 192.168.190.1:60374
[+] New outgoing request to 192.168.2.96:3389 (SSL: 0)
[+] Connected
[+] Detected incoming SSL connection. Turning self into SSL socket
&lt;LShift-down&gt;A&lt;LShift-up&gt;DMINISTRATOR&lt;Tab&gt;&lt;LShift-down&gt;P&lt;LShift-up&gt;ASSWORD&lt;Enter&gt;
</pre>
<h2>Conclusions</h2>
<p>Learning to ignore SSL certificate warnings is as bad for RDP connection as it is for HTTPS web sites. The results are similar: users quickly become vulnerable to &#8220;Man-In-The-Middle&#8221; attacks. Such attacks can harvest usernames, passwords, keystrokes and other sensitive data.</p>
<p>Using SSL certificates that are signed by a Certificate Authority the RDP client trusts will result in no warning under normal operation, so is highly recommended.</p>
<p>This attack doesn&#8217;t work if the server mandates NLA, so using NLA is also highly recommended.</p>
<p>It&#8217;s important to note that this isn&#8217;t a vulnerability in the RDP Client or Server software. Nor is this a  new discovery. It&#8217;s a weakness in way RDP is sometimes used which stems from users ignoring security warnings. At a technical level, this is a fairly vanilla SSL MiTM attack.</p>
<p>It might be interesting to extend this work by recording screen captures; or by injecting images of login boxes to encourage users to part of with other credentials. There would also be an opportunity to attack any drives that the RDP client has mapped for drive redirection &#8211; see <a title="Attacking the RDP client" href="http://tombstone-bbs.co.uk/reverse-rdp/reverse-rdp.html">Attacking the RDP Clients</a> for inspiration. These would be pretty demanding coding challenges, though!</p>
<p>The post <a href="https://labs.portcullis.co.uk/blog/ssl-man-in-the-middle-attacks-on-rdp/">SSL &#8220;Man-In-The-Middle&#8221; attacks on RDP</a> appeared first on <a href="https://labs.portcullis.co.uk">Portcullis Labs</a>.</p>]]></content:encoded>
			<wfw:commentRss>https://labs.portcullis.co.uk/blog/ssl-man-in-the-middle-attacks-on-rdp/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
