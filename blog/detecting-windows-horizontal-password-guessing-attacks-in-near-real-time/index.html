<!DOCTYPE html>
<html lang="en-US" xmlns:fb="https://www.facebook.com/2008/fbml" xmlns:addthis="https://www.addthis.com/help/api-spec"  prefix="og: http://ogp.me/ns#">
<head>
<meta charset="UTF-8" />
<title>Detecting windows horizontal password guessing attacks in near real-time | Portcullis Labs</title>
<meta name="viewport" content="initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no, width = device-width">
<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<link rel="stylesheet" href="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/style.css" media="screen" />


<!-- This site is optimized with the Yoast WordPress SEO plugin v1.4.7 - http://yoast.com/wordpress/seo/ -->
<link rel="canonical" href="https://labs.portcullis.co.uk/blog/detecting-windows-horizontal-password-guessing-attacks-in-near-real-time/" />
<meta property='og:locale' content='en_US'/>
<meta property='og:type' content='article'/>
<meta property='og:title' content='Detecting windows horizontal password guessing attacks in near real-time - Portcullis Labs'/>
<meta property='og:url' content='https://labs.portcullis.co.uk/blog/detecting-windows-horizontal-password-guessing-attacks-in-near-real-time/'/>
<meta property='og:site_name' content='Portcullis Labs'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/01-run-gpmgmt-300x225.png'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/02-edit-default-policy-300x225.png'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/03-computer-audit-policy-properties-300x225.png'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/04-audit-policy-success-failure-300x225.png'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/05-run-gpupdate_-force-300x225.png'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/07-client-logon-failure-300x225.png'/>
<meta property='og:image' content='https://labs.portcullis.co.uk/wp-content/uploads/2014/02/08-dc-event-logon-failure-300x225.png'/>
<!-- / Yoast WordPress SEO plugin. -->

<link rel="alternate" type="application/rss+xml" title="Portcullis Labs &raquo; Feed" href="https://labs.portcullis.co.uk/feed/" />
<link rel='stylesheet' id='TheStyleSheets-css'  href='https://labs.portcullis.co.uk/wp-content/plugins/asm-brush/style.css?ver=3.8.5' type='text/css' media='all' />
<link rel='stylesheet' id='wpfb-css'  href='//labs.portcullis.co.uk/wp-content/plugins/wp-filebase/wp-filebase.css?t=1475825177&#038;ver=3.4.4' type='text/css' media='all' />
<link rel='stylesheet' id='contact-form-7-css'  href='https://labs.portcullis.co.uk/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=3.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='css3lightbox_style-css'  href='https://labs.portcullis.co.uk/wp-content/plugins/css3lightbox/assets/style.css?ver=3.8.5' type='text/css' media='all' />
<link rel='stylesheet' id='addthis_all_pages-css'  href='https://labs.portcullis.co.uk/wp-content/plugins/addthis/frontend/build/addthis_wordpress_public.min.css?ver=3.8.5' type='text/css' media='all' />
<!--[if lte IE 7]>
<link rel='stylesheet' id='style.ie7.css-css'  href='https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/style.ie7.css?ver=3.8.5' type='text/css' media='screen' />
<![endif]-->
<link rel='stylesheet' id='style.responsive.css-css'  href='https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/style.responsive.css?ver=3.8.5' type='text/css' media='all' />
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/jquery.js?ver=3.8.5'></script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/script.js?ver=3.8.5'></script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/script.responsive.js?ver=3.8.5'></script>

 

<link rel="shortcut icon" href="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/favicon.ico" /><link rel='header_link' href='/' /><style type="text/css" id="syntaxhighlighteranchor"></style>
<script data-cfasync="false" type="text/javascript">if (window.addthis_product === undefined) { window.addthis_product = "wpp"; } if (window.wp_product_version === undefined) { window.wp_product_version = "wpp-6.1.4"; } if (window.wp_blog_version === undefined) { window.wp_blog_version = "3.8.5"; } if (window.addthis_share === undefined) { window.addthis_share = {}; } if (window.addthis_config === undefined) { window.addthis_config = {"data_track_clickback":false,"ignore_server_config":true,"ui_atversion":300}; } if (window.addthis_layers === undefined) { window.addthis_layers = {}; } if (window.addthis_layers_tools === undefined) { window.addthis_layers_tools = []; } else {  } if (window.addthis_plugin_info === undefined) { window.addthis_plugin_info = {"info_status":"enabled","cms_name":"WordPress","plugin_name":"Share Buttons by AddThis","plugin_version":"6.1.4","plugin_mode":"WordPress","anonymous_profile_id":"wp-3219ffbb80dfd9f649eb0d9d76c4d2e4","page_info":{"template":"posts","post_type":""},"sharing_enabled_on_post_via_metabox":false}; } 
                    (function() {
                      var first_load_interval_id = setInterval(function () {
                        if (typeof window.addthis !== 'undefined') {
                          window.clearInterval(first_load_interval_id);
                          if (typeof window.addthis_layers !== 'undefined' && Object.getOwnPropertyNames(window.addthis_layers).length > 0) {
                            window.addthis.layers(window.addthis_layers);
                          }
                          if (Array.isArray(window.addthis_layers_tools)) {
                            for (i = 0; i < window.addthis_layers_tools.length; i++) {
                              window.addthis.layers(window.addthis_layers_tools[i]);
                            }
                          }
                        }
                     },1000)
                    }());
                </script> <script data-cfasync="false" type="text/javascript"src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50cef03053621092" async="async"></script><meta name="norton-safeweb-site-verification" content="t4bvmzb47z4-fa69d4guwu4ud9-4fjyp-p5zu1zngnplt83xrfxxg18yea8ev95lh9h4vlzkclbcvyu37rz5etuoczh7z3827pjv3s73uannz0xkwzfw2iiu4ol7o83f" />
</head>
<body class="single single-post postid-3914 single-format-standard">

<div id="portcullis-main">


<!-- Cisco -->
<div id="cisco">
    <div id="cisco-container" class="clearfix">
        <div class="left">
            <a href="http://www.cisco.com/" target="_blank"><img class="cisco-logo" src="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/images/portcullis_cisco_logo.png" alt=""></a>
            <a href="http://www.cisco.com/web/about/ac49/ac0/ac1/ac259/portcullis.html" class="learnmore">Learn More <img src="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/images/more-triangle.png" alt=""></a>
        </div>
        <div class="right">
            <div class="move-right"><a href="http://www.cisco.com/web/about/index.html" target="_blank" class="move-right">About Cisco</a></div>
        </div>
    </div>
</div>
<!-- /#cisco -->

<header class="clearfix portcullis-header clickable">


    <div class="portcullis-shapes">
		<div class="portcullis-headline" data-left="14.6%">
    <a href="https://labs.portcullis.co.uk/">Portcullis Labs</a>
</div>
		<div class="portcullis-slogan" data-left="16.4%">Research and Development</div>
<div class="logo"><a href="https://www.portcullis-security.com"><img style="border:none;" src="/wp-content/themes/Portcullisfinal/images/logo.png" /></a></div>

<div class="portcullis-textblock portcullis-object1741532833" data-left="92.34%">
    
</div><div class="portcullis-textblock portcullis-object1269462037" data-left="97.93%">
    
</div>
            </div>

<nav class="portcullis-nav clearfix">
    
<ul class="portcullis-hmenu">
	<li class="menu-item-268"><a href="https://labs.portcullis.co.uk" title="Home">Home</a>
	</li>
	<li class="menu-item-6568"><a href="https://labs.portcullis.co.uk/advisories/" title="Advisories">Advisories</a>
	</li>
	<li class="menu-item-83"><a href="https://labs.portcullis.co.uk/blog/" title="Blog">Blog</a>
	</li>
	<li class="menu-item-66"><a href="https://labs.portcullis.co.uk/presentations/" title="Presentations">Presentations</a>
	</li>
	<li class="menu-item-62"><a href="https://labs.portcullis.co.uk/tools/" title="Tools">Tools</a>
	</li>
	<li class="menu-item-64"><a href="https://labs.portcullis.co.uk/whitepapers/" title="Whitepapers">Whitepapers</a>
	</li>
	<li class="menu-item-59"><a href="https://labs.portcullis.co.uk/downloads/" title="Downloads">Downloads</a>
	</li>
</ul>
 
    </nav>

                    
</header>

<div class="portcullis-sheet clearfix">
            <div class="portcullis-layout-wrapper clearfix">
                <div class="portcullis-content-layout">
                    <div class="portcullis-content-layout-row">
                        <div class="portcullis-layout-cell portcullis-content clearfix">
							<article id="post-3914"  class="portcullis-post portcullis-article  post-3914 post type-post status-publish format-standard hentry category-blog tag-auditing tag-blue-team tag-training tag-windows">
                                <div class="portcullis-postmetadataheader"><h1 class="portcullis-postheader">Detecting windows horizontal password guessing attacks in near real-time</h1></div>                                                <div class="portcullis-postheadericons portcullis-metadata-icons"><span class="portcullis-postdateicon"><span class="date">Published</span> <span class="entry-date" title="13:37">16/02/2015</span></span> | <span class="portcullis-postauthoricon"><span class="author">By</span> <span class="author vcard"><a class="url fn n" href="https://labs.portcullis.co.uk/author/rgh/" title="View all posts by RGH">RGH</a></span></span></div>                <div class="portcullis-postcontent clearfix"><div class="at-above-post addthis_tool" data-url="https://labs.portcullis.co.uk/blog/detecting-windows-horizontal-password-guessing-attacks-in-near-real-time/"></div><!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style "><a class="addthis_button_email"><a class="addthis_button_twitter"></a><a class="addthis_button_reddit"></a></a>
</div><p>When attempting to gain a foothold into a Windows Domain, an attacker will often attempt one or two likely passwords against every user in the Active Directory, a so-called horizontal password guessing attack. A small number of failed logons per user will usually not trigger a user account lockout policy and can be very effective. This post will provide an example solution to detecting such attacks in near real time, using only native Windows tools.<span id="more-3914"></span></p>
<p>Even with password complexity requirements and custom filters there is no built-in way to stop users choosing poor passwords. It is scary how may user accounts are identified with the password Password1 for example. We need a method of detecting password guessing attacks, preferably before someone takes control of the Domain.</p>
<p>By following the instructions below you can get hourly (can be trivially customised) notifications of such horizontal password guessing attacks.</p>
<p>Note: The following method has been developed using Windows 2012.</p>
<h2>Configuring the Domain Controller</h2>
<p>First we need to configure the Active Directory Domain Controller to log failed logon attempts:</p>
<ul>
<li>From the Server Manager tool click Tools and select Group Policy Management, as shown in the screenshot below:
<div id="attachment_3906" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3915"><div class="lb-album"><a href="#image-3915"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/01-run-gpmgmt-300x225.png" alt="Server Manager..Tools..Group Policy Management" class="size-medium wp-image-3906"><span></span></a></div>              
<a href="#imageclose-3915" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3915">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/01-run-gpmgmt.png" alt="image-3915">
                   </div></a><p class="wp-caption-text">Figure 1. Opening the Group Policy Management tool</p></div></li>
<li>Expand the nodes in the left hand pane so you can see the policy Default Domain Controllers Policy for Domain Controllers within the Domain. Right-click it and select Edit, as shown below:
<div id="attachment_3907" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3916"><div class="lb-album"><a href="#image-3916"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/02-edit-default-policy-300x225.png" alt="Expand ' class="size-medium wp-image-3907"><span></span></a></div>              
<a href="#imageclose-3916" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3916">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/02-edit-default-policy.png" alt="image-3916">
                   </div></a><p class="wp-caption-text">Figure 2. Edit the &#8216;Default Domain Controllers Policy&#8217;</p></div></li>
<li>In the Group Policy Management Editor expand &#8220;Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Local Policies&#8221; and then click &#8220;Audit Policy&#8221;</li>
<li>Right-click &#8220;Audit account logon events&#8221; and select &#8220;Properties&#8221;, as shown below:
<div id="attachment_3908" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3917"><div class="lb-album"><a href="#image-3917"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/03-computer-audit-policy-properties-300x225.png" alt="Expand ' class="size-medium wp-image-3908"><span></span></a></div>              
<a href="#imageclose-3917" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3917">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/03-computer-audit-policy-properties.png" alt="image-3917">
                   </div></a><p class="wp-caption-text">Figure 3. Editing the policy setting for &#8216;Audit account logon events&#8217;</p></div></li>
<li>Ensure that both &#8220;Define these policy settings&#8221; and &#8220;Failure&#8221; are enabled then click &#8220;OK&#8221;. The following screenshot shows both &#8220;Success&#8221; and &#8220;Failure&#8221; are selected:
<div id="attachment_3909" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3918"><div class="lb-album"><a href="#image-3918"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/04-audit-policy-success-failure-300x225.png" alt="Tick ' class="size-medium wp-image-3909"><span></span></a></div>              
<a href="#imageclose-3918" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3918">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/04-audit-policy-success-failure.png" alt="image-3918">
                   </div></a><p class="wp-caption-text">Figure 4. Enabling failure events for the &#8216;Audit account logon events&#8217; properties</p></div></li>
<li>When you click &#8220;OK&#8221; the updated policy settings will be visible. Next we force the server to recognise the updated policy settings by running the command gpupdate /force by pressing Windows key + r, as shown below:
<div id="attachment_3911" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3919"><div class="lb-album"><a href="#image-3919"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/05-run-gpupdate_-force-300x225.png" alt="Run ' class="size-medium wp-image-3911"><span></span></a></div>              
<a href="#imageclose-3919" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3919">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/05-run-gpupdate_-force.png" alt="image-3919">
                   </div></a><p class="wp-caption-text">Figure 5. Forcing the updated policy to take effect</p></div></li>
<li>To test that the policy has taken affect we make a failed logon attempts (from another system). Note the IP address of the machine used in the screenshot below:
<div id="attachment_3949" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3920"><div class="lb-album"><a href="#image-3920"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/07-client-logon-failure-300x225.png" alt="Run ' class="size-medium wp-image-3949"><span></span></a></div>              
<a href="#imageclose-3920" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3920">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/07-client-logon-failure.png" alt="image-3920">
                   </div></a><p class="wp-caption-text">Figure 6. Triggering a failed logon event with a &#8220;net use&#8221; command</p></div></li>
<li>By viewing the Event Viewer on the Domain Controller we can see in the following screenshot that failed logon attempts now generate <em>Audit Failure</em> events (in this case EventID 4771) and that the IPAddress shown matches the host from which the logon attempt was made:
<div id="attachment_3913" style="width: 310px" class="wp-caption alignnone"><a name="imageclose-3921"><div class="lb-album"><a href="#image-3921"><img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/08-dc-event-logon-failure-300x225.png" alt="View the Domain event log to verify an ' class="size-medium wp-image-3913"><span></span></a></div>              
<a href="#imageclose-3921" class="css3lightbox-close">
				   <div class="lb-overlay" id="image-3921">
                   <img src="https://labs.portcullis.co.uk/wp-content/uploads/2014/02/08-dc-event-logon-failure.png" alt="image-3921">
                   </div></a><p class="wp-caption-text">Figure 7. Confirming a failed logon generates an event</p></div></li>
</ul>
<p>Ok. That&#8217;s the Domain Controller logging configured. Now we need a method of parsing the event log to detect failed logon attempts&#8230;</p>
<h2>Parsing the event logs</h2>
<p>PowerShell has a cmdlet called get-WinEvent that allows us to filter out all events with a specific EventId within a given timespan.</p>
<pre class="brush: powershell; title: ; notranslate" title="">
$events = get-winevent -EA silentlycontinue -filterhashtable @{LogName='Security';id=4771; `
starttime=(Get-Date).AddHours(-1);endtime=(Get-Date) }
</pre>
<p>Note: The backtick at the end of the first line is PowerShell&#8217;s multiline indicator and is required.</p>
<p>By running the above PowerShell command we get all events from the Security log with an ID value of 4771 from the past hour. If we wanted to change the timespan we could replace AddHours(-1) with AddMinutes(-30) for the last 30 minutes, or AddDays(-1) for the last 24 hours. Those events will be accessed via the $events variable.</p>
<p>If we want to check additional EventIds we simply add extra calls to get-WinEvent like so:</p>
<pre class="brush: powershell; title: ; notranslate" title="">
$events += get-winevent -EA silentlycontinue -filterhashtable @{LogName='Security';id=1234; `
starttime=(Get-Date).AddHours(-1);endtime=(Get-Date) }
</pre>
<p>Note the use of += to append the extra events.</p>
<p>We specify the parameter <em>-EA silentlycontinue</em> to avoid error messages if there are no events returned.</p>
<p>Of course some of those events might well be innocent users who mis-typed their password. Someone performing a horizontal password guessing attack against Active Directory users will be running that attack from a single host on the network (E.g. an IP address). Or several hosts might be being used, each testing a sub-set of user accounts and/or passwords. We want to identify any IP address that failed to logon more than a specified number of times within our timespan.</p>
<p>In order to obtain information from the event entry message we need to convert the event to XML so that we can parse it. We will make a note of each IP address that generated the failed logon event by looping through each event (remember we filtered only those events we are interested in) and increment a counter specific for each unique IP address we encounter.</p>
<p>Once we have counted each failed logon attempt originating from all the source IPs referenced in the log event we simply report on any IP where the counted value exceeds our specified threshold value by sending an email alert.</p>
<h2>The complete script</h2>
<p>The following PowerShell script implements the complete process:</p>
<pre class="brush: powershell; title: ; notranslate" title="">
# Script: detect-horizontal-user-brute-froce-attack.ps1
# Author: Richard Hatch, 2014 - RGH@Portcullis-Security.com

# Number of failed logons within the defined time span
# Total events -gt this value will trick the response action
$threshold = 4

#The email server to use when sending alerts
$EmailServer = &quot;127.0.0.1&quot;

#The email address to send from
$mail_domainSrc = &quot;alerts@mydomain.com&quot;

#clean-up any data from a previous run
Remove-Variable events

#get the events from the local system. RUN ON DC (or central log server)
$events = get-winevent -EA silentlycontinue -filterhashtable @{LogName='Security';id=4771; `
starttime=(Get-Date).AddHours(-1);endtime=(Get-Date)  }

# Copy the following line for each required ID value (and update the ID param!)

# $events += get-winevent -EA silentlycontinue -filterhashtable @{LogName='Security'; `
#id=4771;starttime=(Get-Date).AddHours(-1);endtime=(Get-Date) }

#declare our data hash
$scares = @{}

#process each event
ForEach ($evt in $events)
{
	#convert the event data to xml so we can get items
	$evtxml =
1
$evt.ToXML() $curTargetUserName = &quot;&quot; $curServiceName = &quot;&quot; $curIPAddress = &quot;&quot; $curEventTime = $evtxml.Event.System.TimeCreated.SystemTime #need to loop through each 'data' properties for ($i=0; $i -lt $evtxml.Event.EventData.childNodes.count; $i++) { if ($evtxml.Event.EventData.Data[$i].name -eq &quot;IpAddress&quot;) { $curIPAddress = $evtxml.Event.EventData.Data[$i].'#text' } } #end for ($i=0; $i -lt $evtxml.Event.EventData.count; $i++) #If we have never seen this IP failing to logon create a new entry # #Without this check the code attempts to repeatedly create the #same hash entry, causing an error. if (!($scares.ContainsKey($curIPAddress))) { $scares.Add($curIPAddress, 0); #init to 0 } #count this failed logon attempt $scares[&quot;$curIPAddress&quot;] += 1 } #end ForEach ($evt in $events) $scares.GetEnumerator() | % { if ( $($_.value) -gt $threshold ) { $attackerIP = $($_.key) $attackerFailedTimes = $($_.value) Write-Host &quot;[!] IP: $($_.key) failed to login $($_.value) times in the last hour&quot; #$mail_domainSrc = [string]([adsi]'').distinguishedName $mail_subject = &quot;ALERT ${mail_domainSrc}: Host $($_.key) may be attacking ActiveDirectory user accounts&quot; $mail_body = &quot; ALERT! A possible brute-force password guessing attack detected within the last hour from the host with the IP $attackerIP. Failed logon count was $attackerFailedTimes $mail_domainSrc &quot; Send-MailMessage -To ITSecurity@mydomain.com -From $mail_domainSrc ` -Subject $mail_subject -Body $mail_body -SmtpServer $EmailServer ` -Priority High } #end if ( $($_.value) -gt $threshold ) } #end $scares.GetEnumerator() | % {
</pre>
<p>The PowerShell script will diplay information to the PowerShell Console (if visible) and send an email, in this case to ITSecurity@mydomain.com from alerts@mydomain.com, using the <em>Send-MailMessage</em> cmdlet.</p>
<p>We can test the script with the following command:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
c:\&gt; powershell -File Detect-horizontal-user-brute-force-attack.ps1
[!] IP: ::ffff:10.1.2.3 failed to login 6 times in the last hour
</pre>
<p>Note: You may need to first enable external scripting within PowerShell:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
PS&gt; Set-ExecutionPolicy unrestricted
</pre>
<p>For a more secure configuration of PowerShell you can specify <em>Signed</em> instead of <em>Unrestricted</em>. More details on this can be found on Microsoft&#8217;s web site.</p>
<h2>Running the script automatically</h2>
<p>Now we need a method of running the script on the Domain Controller each hour. We can use the task scheduler (as an Administrator):</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
c:\&gt; schtasks /create /tn AD_PwdGuess_Alerter /tr &quot;powershell -NoLogo -WindowStyle hidden -File detect-horizontal-user-brute-force-attack.ps1 /sc hour /mo 1 /ru &quot;NT AUTHORITY\LOCALSERVICE&quot;
</pre>
<p>Once we create the scheduled task we need to start it:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
c:\&gt; schtasks /run /tn AD_PwdGuess_Alerter
</pre>
<p>Note: For extra security you should create a service account with the minimum privileges required to access the event log and send Emails, and specify that account in the /ru parameter, in place of NT AUTHORITY\LOCALSERVICE.</p>
<p>And that&#8217;s it. You may want to tweak the time period settings and the $mail_domainSr value, and the email settings will need to be updated.</p>
<p>This solution can also be used to cover password attacks on local user accounts through the use of Centralised Event Logging. Also see the National Security Agency&#8217;s (NSA) <a title="detailed paper" href="http://www.nsa.gov/ia/_files\app/Spotting_the_Adversary_with_Windows_Event_Log_Monitoring.pdf">detailed paper</a> on configuring centralised event logging.</p>
<div class="wpfilebase-file-default" onclick="if('undefined' == typeof event.target.href) document.getElementById('wpfb-file-link-1').click();">
  <div class="icon"><a href="https://labs.portcullis.co.uk/download/detect-horizontal-user-brute-force-attack.zip" target="_blank" title="Download Detect-horizontal-user-brute-force-attack"><img align="middle" src="https://labs.portcullis.co.uk/wp-includes/images/crystal/archive.png" alt="Detect-horizontal-user-brute-force-attack" /></a></div>
  <div class="filetitle">
    <a href="https://labs.portcullis.co.uk/download/detect-horizontal-user-brute-force-attack.zip" title="Download detect-horizontal-user-brute-force-attack.zip" target="_blank" id="wpfb-file-link-1">detect-horizontal-user-brute-force-attack.zip</a>
    
    <br />
    February 25, 2014<br />
    
  </div>
  <div class="info">
    1.8 KiB<br />
    MD5 hash: 08629677479f0cfd01b9fe960b632949 <br />
    <a href="#" onclick="return wpfilebase_filedetails(1);">Details</a>
  </div>
  <div class="details" id="wpfilebase-filedetails1" style="display: none;">
  
  <table border="0">
   
   
   
   
   
   
   <tr><td><strong>Date:</strong></td><td>February 25, 2014</td></tr>
  </table>
  </div>
 <div style="clear: both;"></div>
</div>
<br /> <div class="wpcf7" id="wpcf7-f375-p238-o1"><form action="/contact/" method="post" class="wpcf7-form">
<div style="display: none;">
<input type="hidden" name="_wpcf7" value="323" />
<input type="hidden" name="_wpcf7_version" value="3.3.2" />
<input type="hidden" name="_wpcf7_unit_tag" value="wpcf7-f375-p238-o1" />
<input type="hidden" name="_wpnonce" value="4c6cc9abab" />
</div>
<style>.portcullis-content .layout-item-0 { background: ; padding: 10px;  }
.portcullis-content .layout-item-1 {  border-collapse: separate;  }
.portcullis-content .layout-item-2 { border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-top-color:#C7C7C7;border-right-color:#C7C7C7;border-bottom-color:#C7C7C7;border-left-color:#C7C7C7; color: #1C1C1C; background: #FAFAFA url('https://www.portcullis-security.com/wp-content/uploads/2013/01/983aa2.png') scroll; padding: 10px; border-radius: 5px;  }
.ie7 .post .layout-cell {border:none !important; padding:0 !important; }
.ie6 .post .layout-cell {border:none !important; padding:0 !important; }</p>
</style>
<div class="portcullis-content-layout layout-item-1">
<div class="portcullis-content-layout-row">
<div class="portcullis-layout-cell layout-item-2" style="width: 80%" >
</p>
</p>
<h3>Request to be added to the Portcullis Labs newsletter</h3>
<p>
 We will email you whenever a new tool, or post is added to the site.</p>
<p>Your Name (required)<br />
    <span class="wpcf7-form-control-wrap your-name"><input type="text" name="your-name" value="" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" size="40" required="required" /></span> </p>
<p>Your Email (required)<br />
    <span class="wpcf7-form-control-wrap your-email"><input type="text" name="your-email" value="" class="wpcf7-form-control wpcf7-text wpcf7-email wpcf7-validates-as-required wpcf7-validates-as-email" size="40" required="required" /></span> </p>
<p><input type="hidden" name="porpoise" value="newsletter" /><br />
<input type="hidden" name="contact_form_7_recaptcha" value="g-recaptcha-7dotKKdGpz1j4Kz" class="g-recaptcha-explicit-id"><div id="g-recaptcha-7dotKKdGpz1j4Kz"></div><span class="wpcf7-form-control-wrap g-recaptcha-explicit" data-sitekey="6LdFERITAAAAAJKGS2TEXuWsyOxc-KxvAZBC8zE2"></span></p>
<p><input type="submit" value="Subscribe" class="wpcf7-form-control  wpcf7-submit" /></p>
</div>
</div>
</div>
<div class="wpcf7-response-output wpcf7-display-none"></div></form></div></br ><div style="clear:both;"></div><!-- AddThis Advanced Settings above via filter on the_content --><!-- AddThis Advanced Settings below via filter on the_content --><!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_toolbox addthis_default_style addthis_32x32_style"><a class="addthis_button_email"><a class="addthis_button_twitter"></a><a class="addthis_button_reddit"></a></a>
</div><!-- AddThis Advanced Settings generic via filter on the_content --><!-- AddThis Share Buttons above via filter on the_content --><!-- AddThis Share Buttons below via filter on the_content --><div class="at-below-post addthis_tool" data-url="https://labs.portcullis.co.uk/blog/detecting-windows-horizontal-password-guessing-attacks-in-near-real-time/"></div><!-- AddThis Share Buttons generic via filter on the_content --></div>
                                                                
</article>
				

                        </div>
                                            </div>
                </div>
            </div><footer class="portcullis-footer clearfix"><div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 100%">
        <p><br></p>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 33%">
        <p style="text-align: left;"><span style="font-size: 17px; padding-left:40px; font-family: Tahoma;"><span style="color: #ffffff;">Research and Development</span><br></span></p>
        <ul>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/advisories/">Advisories</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/blog/">Blog</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/presentations/">Presentations</a><br></span></li>
        <li style="text-align: left; padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/tools/">Tools</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/whitepapers/">Whitepapers</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/downloads/">Downloads</a><br></span></li>
               </ul>
        <p><br></p>
    </div><div class="portcullis-layout-cell" style="width: 34%">
        <p style="text-align: left;"><span style="font-size: 17px;"><span style="font-family: Tahoma;"><span style="font-weight: normal; color: #ffffff;">Company</span><br></span></span></p>
        <ul>
       <li style="text-align: left;"><span style="font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/contact-us/">Contact Us</a><span style="font-size: 12px;"><br></span></span></li>
        <li style="text-align: left;"><span style="font-family: Tahoma;"><a href="https://www.portcullis-security.com">Portcullis Computer Security Services</a><span style="font-size: 12px;"><br></span></span></li>
                </ul>
        <br>
    </div><div class="portcullis-layout-cell" style="width: 33%">
       <span style="color: #ffffff;"><br>
        <br>
        <p style="text-align: left;"><span style="color: #ffffff; font-family: Tahoma;"><span style="color: #ffffff;"><span style="font-size: 15px; color: #ffffff;">Follow Us</span> <span style="font-weight: bold;"> <a href="http://www.twitter.com/portcullislabs" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Twitter" class="" src="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/images/twitterfooter.png"></a> <a href="http://www.linkedin.com/company/portcullis?trk=hb_tab_compy_id_505813" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Linkedin" class="" src="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/images/linkedinfooter.png"></a> <a href="http://www.facebook.com/PortcullisCSL" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Facebook" class="" src="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/images/facebookfooter.png"></a> <a href="https://plus.google.com/114151721382021849037/posts" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Google Plus" class="" src="https://labs.portcullis.co.uk/wp-content/themes/Portcullisfinal/images/googleplusfooter.png"></a> <a href="/rss" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Rss" class=""img src="https://labs.portcullis.co.uk/wp-content/uploads/2013/04/rss.png"></a></span></span></span></p>
        <p><br></p>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 100%">
        <p><br></p>
        <hr>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 50%">
      <p style="text-align: left;"><span style="color: #ffffff; font-size: 12px; font-family: Tahoma;">© Portcullis Computer Security Ltd & Portcullis Inc. All rights reserved. ® 1992 - 2017.</span></p>
    </div><div class="portcullis-layout-cell" style="width: 50%">
        <p style="text-align: right;"><span style="color: #ffffff; font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/terms-of-use/">Terms of Use</a> </span>| <span style="color: #ffffff; font-size: 12px; font-family: Tahoma;"><a href="https://labs.portcullis.co.uk/privacy-and-cookies/">Privacy and Cookies</a></span></p>
    </div>
    </div>
</div></footer>

    </div>
</div>



<div id="wp-footer">
	<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/wp-filebase/js/common.js?ver=3.4.4'></script>
<script type="text/javascript">
//<![CDATA[
wpfbConf={"ql":true,"hl":0,"pl":1,"hu":"https:\/\/labs.portcullis.co.uk\/","db":"download","fb":false,"cm":0,"ajurl":"https:\/\/labs.portcullis.co.uk\/wp-admin\/admin-ajax.php?action=wpfilebase","ajurlpub":"\/\/labs.portcullis.co.uk\/?wpfilebase_ajax=1"};function wpfb_ondl(file_id,file_url,file_path){ if(typeof pageTracker == 'object') {
	pageTracker._trackPageview(file_url); // new google analytics tracker
} else if(typeof urchinTracker == 'function') {	
	urchinTracker(file_url); // old google analytics tracker
} }
//]]>
</script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPowerShell.js?ver=3.0.9b'></script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushBash.js?ver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://labs.portcullis.co.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "https://labs.portcullis.co.uk/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeMidnight.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/contact-form-7/includes/js/jquery.form.min.js?ver=3.23'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var _wpcf7 = {"loaderUrl":"https:\/\/labs.portcullis.co.uk\/wp-content\/plugins\/contact-form-7\/images\/ajax-loader.gif","sending":"Sending ..."};
/* ]]> */
</script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=3.3.2'></script>
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js?onload=contact_form_7_recaptcha_callback&#038;render=explicit&#038;ver=1.0.0'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var contact_form_7_recaptcha_data = {"sitekey":"6LdFERITAAAAAJKGS2TEXuWsyOxc-KxvAZBC8zE2"};
/* ]]> */
</script>
<script type='text/javascript' src='https://labs.portcullis.co.uk/wp-content/plugins/contact-form-7-recaptcha/script.js?ver=1.0.0'></script>
	<!-- 65 queries. 0.089 seconds. -->
</div>
</body>
</html>

