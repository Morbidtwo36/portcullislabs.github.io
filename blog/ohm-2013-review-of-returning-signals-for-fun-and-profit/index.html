<!DOCTYPE html>
<html lang="en-US" xmlns:fb="https://www.facebook.com/2008/fbml" xmlns:addthis="https://www.addthis.com/help/api-spec"  prefix="og: http://ogp.me/ns#">
<head>
<meta charset="UTF-8" />
<title>OHM 2013: Review of &quot;Returning signals for fun and profit&quot; | Portcullis Labs</title>
<meta name="viewport" content="initial-scale = 1.0, maximum-scale = 1.0, user-scalable = no, width = device-width">
<!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

<link rel="stylesheet" href="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/style.css" media="screen" />


<!-- This site is optimized with the Yoast WordPress SEO plugin v1.4.7 - http://yoast.com/wordpress/seo/ -->
<link rel="canonical" href="https://portcullislabs.github.io/blog/ohm-2013-review-of-returning-signals-for-fun-and-profit/" />
<meta property='og:locale' content='en_US'/>
<meta property='og:type' content='article'/>
<meta property='og:title' content='OHM 2013: Review of &quot;Returning signals for fun and profit&quot; - Portcullis Labs'/>
<meta property='og:url' content='https://portcullislabs.github.io/blog/ohm-2013-review-of-returning-signals-for-fun-and-profit/'/>
<meta property='og:site_name' content='Portcullis Labs'/>
<!-- / Yoast WordPress SEO plugin. -->

<link rel="alternate" type="application/rss+xml" title="Portcullis Labs &raquo; Feed" href="https://portcullislabs.github.io/feed/" />
<link rel='stylesheet' id='TheStyleSheets-css'  href='https://portcullislabs.github.io/wp-content/plugins/asm-brush/style.css?ver=3.8.5' type='text/css' media='all' />
<link rel='stylesheet' id='wpfb-css'  href='//portcullislabs.github.io/wp-content/plugins/wp-filebase/wp-filebase.css?t=1475825177&#038;ver=3.4.4' type='text/css' media='all' />
<link rel='stylesheet' id='contact-form-7-css'  href='https://portcullislabs.github.io/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=3.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='css3lightbox_style-css'  href='https://portcullislabs.github.io/wp-content/plugins/css3lightbox/assets/style.css?ver=3.8.5' type='text/css' media='all' />
<link rel='stylesheet' id='addthis_all_pages-css'  href='https://portcullislabs.github.io/wp-content/plugins/addthis/frontend/build/addthis_wordpress_public.min.css?ver=3.8.5' type='text/css' media='all' />
<!--[if lte IE 7]>
<link rel='stylesheet' id='style.ie7.css-css'  href='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/style.ie7.css?ver=3.8.5' type='text/css' media='screen' />
<![endif]-->
<link rel='stylesheet' id='style.responsive.css-css'  href='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/style.responsive.css?ver=3.8.5' type='text/css' media='all' />
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/jquery.js?ver=3.8.5'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/script.js?ver=3.8.5'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/script.responsive.js?ver=3.8.5'></script>

 

<link rel="shortcut icon" href="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/favicon.ico" /><link rel='header_link' href='/' /><style type="text/css" id="syntaxhighlighteranchor"></style>
<script data-cfasync="false" type="text/javascript">if (window.addthis_product === undefined) { window.addthis_product = "wpp"; } if (window.wp_product_version === undefined) { window.wp_product_version = "wpp-6.1.4"; } if (window.wp_blog_version === undefined) { window.wp_blog_version = "3.8.5"; } if (window.addthis_share === undefined) { window.addthis_share = {}; } if (window.addthis_config === undefined) { window.addthis_config = {"data_track_clickback":false,"ignore_server_config":true,"ui_atversion":300}; } if (window.addthis_layers === undefined) { window.addthis_layers = {}; } if (window.addthis_layers_tools === undefined) { window.addthis_layers_tools = []; } else {  } if (window.addthis_plugin_info === undefined) { window.addthis_plugin_info = {"info_status":"enabled","cms_name":"WordPress","plugin_name":"Share Buttons by AddThis","plugin_version":"6.1.4","plugin_mode":"WordPress","anonymous_profile_id":"wp-3219ffbb80dfd9f649eb0d9d76c4d2e4","page_info":{"template":"posts","post_type":""},"sharing_enabled_on_post_via_metabox":false}; } 
                    (function() {
                      var first_load_interval_id = setInterval(function () {
                        if (typeof window.addthis !== 'undefined') {
                          window.clearInterval(first_load_interval_id);
                          if (typeof window.addthis_layers !== 'undefined' && Object.getOwnPropertyNames(window.addthis_layers).length > 0) {
                            window.addthis.layers(window.addthis_layers);
                          }
                          if (Array.isArray(window.addthis_layers_tools)) {
                            for (i = 0; i < window.addthis_layers_tools.length; i++) {
                              window.addthis.layers(window.addthis_layers_tools[i]);
                            }
                          }
                        }
                     },1000)
                    }());
                </script> <script data-cfasync="false" type="text/javascript"src="https://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50cef03053621092" async="async"></script><meta name="norton-safeweb-site-verification" content="t4bvmzb47z4-fa69d4guwu4ud9-4fjyp-p5zu1zngnplt83xrfxxg18yea8ev95lh9h4vlzkclbcvyu37rz5etuoczh7z3827pjv3s73uannz0xkwzfw2iiu4ol7o83f" />
</head>
<body class="single single-post postid-1458 single-format-standard">

<div id="portcullis-main">


<!-- Cisco -->
<div id="cisco">
    <div id="cisco-container" class="clearfix">
        <div class="left">
            <a href="http://www.cisco.com/" target="_blank"><img class="cisco-logo" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/portcullis_cisco_logo.png" alt=""></a>
            <a href="http://www.cisco.com/web/about/ac49/ac0/ac1/ac259/portcullis.html" class="learnmore">Learn More <img src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/more-triangle.png" alt=""></a>
        </div>
        <div class="right">
            <div class="move-right"><a href="http://www.cisco.com/web/about/index.html" target="_blank" class="move-right">About Cisco</a></div>
        </div>
    </div>
</div>
<!-- /#cisco -->

<header class="clearfix portcullis-header clickable">


    <div class="portcullis-shapes">
		<div class="portcullis-headline" data-left="14.6%">
    <a href="https://portcullislabs.github.io/">Portcullis Labs</a>
</div>
		<div class="portcullis-slogan" data-left="16.4%">Research and Development</div>
<div class="logo"><a href="https://www.portcullis-security.com"><img style="border:none;" src="/wp-content/themes/Portcullisfinal/images/logo.png" /></a></div>

<div class="portcullis-textblock portcullis-object1741532833" data-left="92.34%">
    
</div><div class="portcullis-textblock portcullis-object1269462037" data-left="97.93%">
    
</div>
            </div>

<nav class="portcullis-nav clearfix">
    
<ul class="portcullis-hmenu">
	<li class="menu-item-268"><a href="https://portcullislabs.github.io" title="Home">Home</a>
	</li>
	<li class="menu-item-6568"><a href="https://portcullislabs.github.io/advisories/" title="Advisories">Advisories</a>
	</li>
	<li class="menu-item-83"><a href="https://portcullislabs.github.io/blog/" title="Blog">Blog</a>
	</li>
	<li class="menu-item-66"><a href="https://portcullislabs.github.io/presentations/" title="Presentations">Presentations</a>
	</li>
	<li class="menu-item-62"><a href="https://portcullislabs.github.io/tools/" title="Tools">Tools</a>
	</li>
	<li class="menu-item-64"><a href="https://portcullislabs.github.io/whitepapers/" title="Whitepapers">Whitepapers</a>
	</li>
	<li class="menu-item-59"><a href="https://portcullislabs.github.io/downloads/" title="Downloads">Downloads</a>
	</li>
</ul>
 
    </nav>

                    
</header>

<div class="portcullis-sheet clearfix">
            <div class="portcullis-layout-wrapper clearfix">
                <div class="portcullis-content-layout">
                    <div class="portcullis-content-layout-row">
                        <div class="portcullis-layout-cell portcullis-content clearfix">
							<article id="post-1458"  class="portcullis-post portcullis-article  post-1458 post type-post status-publish format-standard hentry category-blog tag-analysis tag-aslr tag-conference tag-ohm2013">
                                <div class="portcullis-postmetadataheader"><h1 class="portcullis-postheader">OHM 2013: Review of &#8220;Returning signals for fun and profit&#8221;</h1></div>                                                <div class="portcullis-postheadericons portcullis-metadata-icons"><span class="portcullis-postdateicon"><span class="date">Published</span> <span class="entry-date" title="14:38">05/11/2013</span></span> | <span class="portcullis-postauthoricon"><span class="author">By</span> <span class="author vcard"><a class="url fn n" href="https://portcullislabs.github.io/author/brc/" title="View all posts by BRC">BRC</a></span></span></div>                <div class="portcullis-postcontent clearfix"><div class="at-above-post addthis_tool" data-url="https://portcullislabs.github.io/blog/ohm-2013-review-of-returning-signals-for-fun-and-profit/"></div><!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style "><a class="addthis_button_email"><a class="addthis_button_twitter"></a><a class="addthis_button_reddit"></a></a>
</div><p>One interesting talk I&#8217;ve attended on OHM 2013 was titled &#8220;Returning Signals for fun and profit&#8221;. This talk was given by Erik Bosman. The talk refers to a new way exploiting binaries using the Linux signal&#8217;s stack frame.<span id="more-1458"></span></p>
<p>This post could be summarised with the following words:</p>
<p><a title="Return oriented programming" href="http://en.wikipedia.org/wiki/Return-oriented_programming">Return oriented programming</a> has been proven to be a very effective way of circumventing data execution prevention features like <a title="ASLR" href="http://en.wikipedia.org/wiki/Address_space_layout_randomization">ASLR</a> present in modern operating systems, but the attacker needs to know the binary structure of the target executable in order to extract the so-called <a href="http://users.suse.com/~krahmer/no-nx.pdf‎">borrowed chunks of code</a>. Here a generic binary exploitation technique will be covered which in some cases requires no knowledge about the running program.</a></p>
<h2>Contexts and switches</h2>
<p>A clever way to alter the control flow of the program by using <a title="context control" href="http://www.linfo.org/context_switch.html">context control</a> will be described. A program execution context comprises the CPU&#8217;s registers, the program counter plus other operating system specific data at any point in time. A context switch is the process of storing and restoring the state of a process so that execution can be resumed from the same point at a later time. There are two types of context switches: software and hardware.</p>
<p>In this post I will cover the software context switch used in the process of a task returning from a software signal on 64bits. The Linux implementation of signals is fully POSIX-compliant, and the data used to recover the task from a previus state (the interrupted context: registers, program counter, signal mask, etc.) is be saved in a ucontext_t structure on the stack for the thread, along with the trampoline return address. Signal handlers installed with the SA_SIGINFO flag are able to examine this ucontext_t structure. The definition of the structure ucontext can be seen in the include/uapi/asm-generic/ucontext.h header file:</p>
<pre class="brush: cpp; first-line: 1; title: ; notranslate" title="">
#ifndef __ASM_GENERIC_UCONTEXT_H
#define __ASM_GENERIC_UCONTEXT_H

struct ucontext {
        unsigned long     uc_flags;
        struct ucontext  *uc_link;
        stack_t           uc_stack;
        struct sigcontext uc_mcontext;
        sigset_t          uc_sigmask;   /* mask last for extensibility */
};

#endif /* __ASM_GENERIC_UCONTEXT_H */
</pre>
<p>The structure sigcontext, which holds the saved state of the task (registers, etc) can be examined in the arch/x86/include/asm/sigcontext.h header file:</p>
<pre class="brush: cpp; first-line: 40; title: ; notranslate" title="">
struct sigcontext {
        unsigned long r8;
        unsigned long r9;
        unsigned long r10;
        unsigned long r11;
        unsigned long r12;
        unsigned long r13;
        unsigned long r14;
        unsigned long r15;
        unsigned long di;
        unsigned long si;
        unsigned long bp;
        unsigned long bx;
        unsigned long dx;
        unsigned long ax;
        unsigned long cx;
        unsigned long sp;
        unsigned long ip;
        unsigned long flags;
        unsigned short cs;
        unsigned short gs;
        unsigned short fs;
        unsigned short __pad0;
        unsigned long err;
        unsigned long trapno;
        unsigned long oldmask;
        unsigned long cr2;

        /*
         * fpstate is really (struct _fpstate *) or (struct _xstate *)
         * depending on the FP_XSTATE_MAGIC1 encoded in the SW reserved
         * bytes of (struct _fpstate) and FP_XSTATE_MAGIC2 present at the end
         * of extended memory layout. See comments at the definition of
         * (struct _fpx_sw_bytes)
         */
        void __user *fpstate;           /* zero when no FPU/extended context */
        unsigned long reserved1[8];
};
</pre>
<p>The struct _fpstate __user *fpstate is defined in the arch/x86/include/uapi/asm/sigcontext.h header file:</p>
<pre class="brush: cpp; first-line: 69; title: ; notranslate" title="">
struct _fpstate {
        /* Regular FPU environment */
        unsigned long   cw;
        unsigned long   sw;
        unsigned long   tag;
        unsigned long   ipoff;
        unsigned long   cssel;
        unsigned long   dataoff;
        unsigned long   datasel;
        struct _fpreg   _st[8];
        unsigned short  status;
        unsigned short  magic;          /* 0xffff = regular FPU data only */

        /* FXSR FPU environment */
        unsigned long   _fxsr_env[6];   /* FXSR FPU env is ignored */
        unsigned long   mxcsr;
        unsigned long   reserved;
        struct _fpxreg  _fxsr_st[8];    /* FXSR FPU reg data is ignored */
        struct _xmmreg  _xmm[8];
        unsigned long   padding1[44];

        union {
                unsigned long   padding2[12];
                struct _fpx_sw_bytes sw_reserved; /* represents the extended
                                                   * state info */
        };
};
</pre>
<p>Finally, the signal information structure struct siginfo is available in include/uapi/asm-generic/siginfo.h:</p>
<p>From include/uapi/asm-generic/siginfo.h:</p>
<pre class="brush: cpp; first-line: 48; title: ; notranslate" title="">
typedef struct siginfo {
        int si_signo;
        int si_errno;
        int si_code;

        union {
                int _pad[SI_PAD_SIZE];

                /* kill() */
                struct {
                        __kernel_pid_t _pid;    /* sender's pid */
                        __ARCH_SI_UID_T _uid;   /* sender's uid */
                } _kill;

                /* POSIX.1b timers */
                struct {
                        __kernel_timer_t _tid;  /* timer id */
                        int _overrun;           /* overrun count */
                        char _pad[sizeof( __ARCH_SI_UID_T) - sizeof(int)];
                        sigval_t _sigval;       /* same as below */
                        int _sys_private;       /* not to be passed to user */
                } _timer;

                /* POSIX.1b signals */
                struct {
                        __kernel_pid_t _pid;    /* sender's pid */
                        __ARCH_SI_UID_T _uid;   /* sender's uid */
                        sigval_t _sigval;
                } _rt;

                /* SIGCHLD */
                struct {
                        __kernel_pid_t _pid;    /* which child */
                        __ARCH_SI_UID_T _uid;   /* sender's uid */
                        int _status;            /* exit code */
                        __ARCH_SI_CLOCK_T _utime;
                        __ARCH_SI_CLOCK_T _stime;
                } _sigchld;

                /* SIGILL, SIGFPE, SIGSEGV, SIGBUS */
                struct {
                        void __user *_addr; /* faulting insn/memory ref. */
#ifdef __ARCH_SI_TRAPNO
                        int _trapno;    /* TRAP # which caused the signal */
#endif
                        short _addr_lsb; /* LSB of the reported address */
                } _sigfault;

                /* SIGPOLL */
                struct {
                        __ARCH_SI_BAND_T _band; /* POLL_IN, POLL_OUT, POLL_MSG */
                        int _fd;
                } _sigpoll;

                /* SIGSYS */
                struct {
                        void __user *_call_addr; /* calling user insn */
                        int _syscall;   /* triggering system call number */
                        unsigned int _arch;     /* AUDIT_ARCH_* of syscall */
                } _sigsys;
        } _sifields;
} __ARCH_SI_ATTRIBUTES siginfo_t;
</pre>
<p>As a summary, the the following kernel source files play a part in this technique:</p>
<pre class="brush: cpp; gutter: false; highlight: [1,4,9]; title: ; notranslate" title="">
arch/x86/include/uapi/asm/sigcontext32.h (32bits)
   	struct _fpstate_ia32
   	struct sigcontext_ia32
arch/x86/include/uapi/asm/sigcontext.h
   	struct _fpstate
	#ifndef __KERNEL__
   	 	struct sigcontext (contains void __user *fpstate; )
	#endif /* !__KERNEL__ */
arch/x86/include/asm/sigcontext.h
 	#include &amp;lt;uapi/asm/sigcontext.h&amp;gt;
   	struct sigcontext ( contains void __user *fpstate; )&lt;/pre&gt;
</pre>
<p>The good thing about storing this data on the stack is that the kernel does not need to remember the signals it delivered, but the bad point is that It can be forged.</p>
<p>When switching context, the kernel will execute setup_rt_frame, where all user-space registers are saved and the kernel stack frame return address is modified to point to the handler of the installed signal handler. A small sequence of code jumper is put on the user stack which will return us to kernel space once the signal handler has finished.</p>
<p>From arch/x86/kernel/signal.c:</p>
<pre class="brush: cpp; first-line: 669; title: ; notranslate" title="">
static int
setup_rt_frame(int sig, struct k_sigaction *ka, siginfo_t *info,
                struct pt_regs *regs)
{
        int usig = signr_convert(sig);
        sigset_t *set = sigmask_to_save();
        compat_sigset_t *cset = (compat_sigset_t *) set;

        /* Set up the stack frame */
        if (is_ia32_frame()) {
                if (ka-&gt;sa.sa_flags &amp; SA_SIGINFO)
                        return ia32_setup_rt_frame(usig, ka, info, cset, regs);
                else
                        return ia32_setup_frame(usig, ka, cset, regs);
        } else if (is_x32_frame()) {
                return x32_setup_rt_frame(usig, ka, info, cset, regs);
        } else {
                return __setup_rt_frame(sig, ka, info, set, regs);
        }
}
</pre>
<p>From arch/x86/kernel/signal.c:</p>
<pre class="brush: cpp; first-line: 408; title: ; notranslate" title="">
static int __setup_rt_frame(int sig, struct k_sigaction *ka, siginfo_t *info,
                            sigset_t *set, struct pt_regs *regs)
{
        struct rt_sigframe __user *frame;
        void __user *fp = NULL;
        int err = 0;

        frame = get_sigframe(ka, regs, sizeof(struct rt_sigframe), &amp;fp);

        if (!access_ok(VERIFY_WRITE, frame, sizeof(*frame)))
                return -EFAULT;

        if (ka-&gt;sa.sa_flags &amp; SA_SIGINFO) {
                if (copy_siginfo_to_user(&amp;frame-&gt;info, info))
                        return -EFAULT;
        }

        put_user_try {
                /* Create the ucontext.  */
                if (cpu_has_xsave)
                        put_user_ex(UC_FP_XSTATE, &amp;frame-&gt;uc.uc_flags);
                else
                        put_user_ex(0, &amp;frame-&gt;uc.uc_flags);
                put_user_ex(0, &amp;frame-&gt;uc.uc_link);
                err |= __save_altstack(&amp;frame-&gt;uc.uc_stack, regs-&gt;sp);

                /* Set up to return from userspace.  If provided, use a stub
                   already in userspace.  */
                /* x86-64 should always use SA_RESTORER. */
                if (ka-&gt;sa.sa_flags &amp; SA_RESTORER) {
                        put_user_ex(ka-&gt;sa.sa_restorer, &amp;frame-&gt;pretcode);
                } else {
                        /* could use a vstub here */
                        err |= -EFAULT;
                }
        } put_user_catch(err);

        err |= setup_sigcontext(&amp;frame-&gt;uc.uc_mcontext, fp, regs, set-&gt;sig[0]);
        err |= __copy_to_user(&amp;frame-&gt;uc.uc_sigmask, set, sizeof(*set));

        if (err)
                return -EFAULT;

        /* Set up registers for signal handler */
        regs-&gt;di = sig;
        /* In case the signal handler was declared without prototypes */
        regs-&gt;ax = 0;

        /* This also works for non SA_SIGINFO handlers because they expect the
           next argument after the signal number on the stack. */
        regs-&gt;si = (unsigned long)&amp;frame-&gt;info;
        regs-&gt;dx = (unsigned long)&amp;frame-&gt;uc;
        regs-&gt;ip = (unsigned long) ka-&gt;sa.sa_handler;

        regs-&gt;sp = (unsigned long)frame;

        /* Set up the CS register to run signal handlers in 64-bit mode,
           even if the handler happens to be interrupting 32-bit code. */
        regs-&gt;cs = __USER_CS;

        return 0;
}
</pre>
<p>The above code restores the exact user-register contents into the kernel stack frame (including the return address and flags register) and executes a normal return from syscall, bringing the execution flow back to the original code that jumped to the signal handler.</p>
<p>The stack frame image that Linux configures for signal returning assembles the following diagram:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
 [-------------]
 [    STACK    ]
 [-------------]
 [   FPSTATE   ]
 [-------------]
 [   UCONTEXT  ]
 [-------------]
 [ SIGINFO+arg ]
 [-------------]
</pre>
<p>A detailed view on 64bits should assemble the following diagram:</p>
<pre class="brush: bash; gutter: false; title: ; notranslate" title="">
     [------------------------------------------]
0x00 [  rt_sigreturn()      |  uc_flags         ]
0x10 [  &amp;uc                 |  uc_stack.ss_sp   ]
0x20 [  uc_stack.ss_flags   |  uc_stack.ss_size ]
0x30 [  r8                  |  r9               ]
0x40 [  r10                 |  r11              ]
0x50 [  r12                 |  r13              ]
0x60 [  r14                 |  r15              ]
0x70 [  rdi                 |  rsi              ]
0x80 [  rbp                 |  rbx              ]
0x90 [  rdx                 |  rax              ]
0xA0 [  rcx                 |  rsp              ]
0xB0 [  rip                 |  eflags           ]
0xC0 [  cs / gs / fs        |  err              ]
0xD0 [  trapno              |  oldmask (unused) ]
0xE0 [  cr2 (segfault addr) |  &amp;fpstate         ]
0xF0 [  __reserved          |  sigmask          ]
     [------------------------------------------]
</pre>
<h2>Exploitation</h2>
<p>By forging the contents of the struct sigcontext, which holds the saved registers values, setting the $rax register to the desired syscall number, setting the systemcall args properly and finally setting the program counter $rip pointing to an >syscall; ret gadget, we can effectively modify the execution flow of the program and execute the desired systemcall. Also, several SigRet frames can be chained by using the value of the saved $rsp register of the returning frame and the gadget syscall;ret.</p>
<ul>
<li>rax =&gt; syscall_number</li>
<li>rdi =&gt; arg1</li>
<li>rsi =&gt; arg2</li>
<li>rdx =&gt; arg3</li>
<li>r10 =&gt; arg4</li>
<li>r8 =&gt; arg5</li>
<li>r9 =&gt; arg6</li>
<li>rip =&gt; syscall;ret</li>
<li>rsp =&gt; next_frame</li>
<li>cs=0&#215;33 / gs=0&#215;0 / fs=0&#215;0</li>
<li>&amp;fpstate = NULL</li>
</ul>
<p>The forged stack structure should assemble the following:</p>
<pre class="brush: bash; gutter: false; highlight: [1,4,5,8,10,11,12,13,15]; title: ; notranslate" title="">
     [------------------------------------------]
0x00 [  rt_sigreturn()      |  uc_flags         ]*
0x10 [  &amp;uc                 |  uc_stack.ss_sp   ]
0x20 [  uc_stack.ss_flags   |  uc_stack.ss_size ]
0x30 [  arg5                |  arg6             ]*
0x40 [  arg4                |  r11              ]*
0x50 [  r12                 |  r13              ]
0x60 [  r14                 |  r15              ]
0x70 [  arg1                |  arg2             ]*
0x80 [  rbp                 |  rbx              ]
0x90 [  arg3                |  syscall_number   ]*
0xA0 [  rcx                 |  next_frame       ]*
0xB0 [  syscall;ret         |  eflags           ]*
0xC0 [  cs=0x33/gs=0/fs=0   |  err              ]*
0xD0 [  trapno              |  oldmask (unused) ]
0xE0 [  cr2 (segfault addr) |  &amp;fpstate         ]*
0xF0 [  __reserved          |  sigmask          ]
     [------------------------------------------]
</pre>
<p>As a summary, for SigReturn oriented programming, the following requirements are needed:</p>
<ol>
<li>Controllable stack</li>
<li>Knowing the address of a system call gadget</li>
<li>A known writable address</li>
<li>Known file descriptor</li>
<li>Control over the RAX register</li>
</ol>
<p>More information:</p>
<ul>
<li>man(2) getcontext</li>
<li>man(2) setcontext</li>
<li><a title="Returning signals for fun and profit" href="https://program.ohm2013.org/event/233.html">Returning signals for fun and profit</a></li>
<li><a title="Context switch" href="http://www.linfo.org/context_switch.html">Context switch</a></li>
<li><a title="The Linux Signal Handling Model" href="http://www.linuxjournal.com/article/3985">The Linux Signal Handling Model</a></li>
<li><a title="The GNU C Library - Signal Handling" href="http://www.cs.utah.edu/dept/old/texinfo/glibc-manual-0.02/library_21.html">The GNU C Library &#8211; Signal Handling</a></li>
<li><a title="Wikipedia - Context switch" href="http://en.wikipedia.org/wiki/Context_switch">Wikipedia &#8211; Context switch</a></li>
<li><a title="Wikipedia - Getcontext" href="http://en.wikipedia.org/wiki/Getcontext">Wikipedia &#8211; Getcontext</a></li>
<li><a title="Wikipedia - Setcontext" href="http://en.wikipedia.org/wiki/Setcontext">Wikipedia &#8211; Setcontext</a></li>
</ul>
<br /> <div class="wpcf7" id="wpcf7-f375-p238-o1"><form action="/contact/" method="post" class="wpcf7-form">
<div style="display: none;">
<input type="hidden" name="_wpcf7" value="323" />
<input type="hidden" name="_wpcf7_version" value="3.3.2" />
<input type="hidden" name="_wpcf7_unit_tag" value="wpcf7-f375-p238-o1" />
<input type="hidden" name="_wpnonce" value="4c6cc9abab" />
</div>
<style>.portcullis-content .layout-item-0 { background: ; padding: 10px;  }
.portcullis-content .layout-item-1 {  border-collapse: separate;  }
.portcullis-content .layout-item-2 { border-top-style:solid;border-right-style:solid;border-bottom-style:solid;border-left-style:solid;border-top-width:1px;border-right-width:1px;border-bottom-width:1px;border-left-width:1px;border-top-color:#C7C7C7;border-right-color:#C7C7C7;border-bottom-color:#C7C7C7;border-left-color:#C7C7C7; color: #1C1C1C; background: #FAFAFA url('https://www.portcullis-security.com/wp-content/uploads/2013/01/983aa2.png') scroll; padding: 10px; border-radius: 5px;  }
.ie7 .post .layout-cell {border:none !important; padding:0 !important; }
.ie6 .post .layout-cell {border:none !important; padding:0 !important; }</p>
</style>
<div class="portcullis-content-layout layout-item-1">
<div class="portcullis-content-layout-row">
<div class="portcullis-layout-cell layout-item-2" style="width: 80%" >
</p>
</p>
<h3>Request to be added to the Portcullis Labs newsletter</h3>
<p>
 We will email you whenever a new tool, or post is added to the site.</p>
<p>Your Name (required)<br />
    <span class="wpcf7-form-control-wrap your-name"><input type="text" name="your-name" value="" class="wpcf7-form-control wpcf7-text wpcf7-validates-as-required" size="40" required="required" /></span> </p>
<p>Your Email (required)<br />
    <span class="wpcf7-form-control-wrap your-email"><input type="text" name="your-email" value="" class="wpcf7-form-control wpcf7-text wpcf7-email wpcf7-validates-as-required wpcf7-validates-as-email" size="40" required="required" /></span> </p>
<p><input type="hidden" name="porpoise" value="newsletter" /><br />
<input type="hidden" name="contact_form_7_recaptcha" value="g-recaptcha-Na18r21O2Hl4RrR" class="g-recaptcha-explicit-id"><div id="g-recaptcha-Na18r21O2Hl4RrR"></div><span class="wpcf7-form-control-wrap g-recaptcha-explicit" data-sitekey="6LdFERITAAAAAJKGS2TEXuWsyOxc-KxvAZBC8zE2"></span></p>
<p><input type="submit" value="Subscribe" class="wpcf7-form-control  wpcf7-submit" /></p>
</div>
</div>
</div>
<div class="wpcf7-response-output wpcf7-display-none"></div></form></div></br ><div style="clear:both;"></div><!-- AddThis Advanced Settings above via filter on the_content --><!-- AddThis Advanced Settings below via filter on the_content --><!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_toolbox addthis_default_style addthis_32x32_style"><a class="addthis_button_email"><a class="addthis_button_twitter"></a><a class="addthis_button_reddit"></a></a>
</div><!-- AddThis Advanced Settings generic via filter on the_content --><!-- AddThis Share Buttons above via filter on the_content --><!-- AddThis Share Buttons below via filter on the_content --><div class="at-below-post addthis_tool" data-url="https://portcullislabs.github.io/blog/ohm-2013-review-of-returning-signals-for-fun-and-profit/"></div><!-- AddThis Share Buttons generic via filter on the_content --></div>
                                                                
</article>
				

                        </div>
                                            </div>
                </div>
            </div><footer class="portcullis-footer clearfix"><div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 100%">
        <p><br></p>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 33%">
        <p style="text-align: left;"><span style="font-size: 17px; padding-left:40px; font-family: Tahoma;"><span style="color: #ffffff;">Research and Development</span><br></span></p>
        <ul>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/advisories/">Advisories</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/blog/">Blog</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/presentations/">Presentations</a><br></span></li>
        <li style="text-align: left; padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/tools/">Tools</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/whitepapers/">Whitepapers</a><br></span></li>
        <li style="text-align: left;padding-left:50px;"><span style="font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/downloads/">Downloads</a><br></span></li>
               </ul>
        <p><br></p>
    </div><div class="portcullis-layout-cell" style="width: 34%">
        <p style="text-align: left;"><span style="font-size: 17px;"><span style="font-family: Tahoma;"><span style="font-weight: normal; color: #ffffff;">Company</span><br></span></span></p>
        <ul>
       <li style="text-align: left;"><span style="font-family: Tahoma;"><a href="https://portcullislabs.github.io/contact-us/">Contact Us</a><span style="font-size: 12px;"><br></span></span></li>
        <li style="text-align: left;"><span style="font-family: Tahoma;"><a href="https://www.portcullis-security.com">Portcullis Computer Security Services</a><span style="font-size: 12px;"><br></span></span></li>
                </ul>
        <br>
    </div><div class="portcullis-layout-cell" style="width: 33%">
       <span style="color: #ffffff;"><br>
        <br>
        <p style="text-align: left;"><span style="color: #ffffff; font-family: Tahoma;"><span style="color: #ffffff;"><span style="font-size: 15px; color: #ffffff;">Follow Us</span> <span style="font-weight: bold;"> <a href="http://www.twitter.com/portcullislabs" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Twitter" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/twitterfooter.png"></a> <a href="http://www.linkedin.com/company/portcullis?trk=hb_tab_compy_id_505813" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Linkedin" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/linkedinfooter.png"></a> <a href="http://www.facebook.com/PortcullisCSL" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Facebook" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/facebookfooter.png"></a> <a href="https://plus.google.com/114151721382021849037/posts" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Google Plus" class="" src="https://portcullislabs.github.io/wp-content/themes/Portcullisfinal/images/googleplusfooter.png"></a> <a href="/rss" target="_blank"><img width="16" height="16" style=" border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px;" alt="Portcullis Rss" class=""img src="https://portcullislabs.github.io/wp-content/uploads/2013/04/rss.png"></a></span></span></span></p>
        <p><br></p>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 100%">
        <p><br></p>
        <hr>
    </div>
    </div>
</div>
<div class="portcullis-content-layout">
    <div class="portcullis-content-layout-row">
    <div class="portcullis-layout-cell" style="width: 50%">
      <p style="text-align: left;"><span style="color: #ffffff; font-size: 12px; font-family: Tahoma;">© Portcullis Computer Security Ltd & Portcullis Inc. All rights reserved. ® 1992 - 2017.</span></p>
    </div><div class="portcullis-layout-cell" style="width: 50%">
        <p style="text-align: right;"><span style="color: #ffffff; font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/terms-of-use/">Terms of Use</a> </span>| <span style="color: #ffffff; font-size: 12px; font-family: Tahoma;"><a href="https://portcullislabs.github.io/privacy-and-cookies/">Privacy and Cookies</a></span></p>
    </div>
    </div>
</div></footer>

    </div>
</div>



<div id="wp-footer">
	<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.9b'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCpp.js?ver=3.0.9b'></script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushBash.js?ver=3.0.9b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "https://portcullislabs.github.io/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeMidnight.css?ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/contact-form-7/includes/js/jquery.form.min.js?ver=3.23'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var _wpcf7 = {"loaderUrl":"https:\/\/portcullislabs.github.io\/wp-content\/plugins\/contact-form-7\/images\/ajax-loader.gif","sending":"Sending ..."};
/* ]]> */
</script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=3.3.2'></script>
<script type='text/javascript' src='https://www.google.com/recaptcha/api.js?onload=contact_form_7_recaptcha_callback&#038;render=explicit&#038;ver=1.0.0'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var contact_form_7_recaptcha_data = {"sitekey":"6LdFERITAAAAAJKGS2TEXuWsyOxc-KxvAZBC8zE2"};
/* ]]> */
</script>
<script type='text/javascript' src='https://portcullislabs.github.io/wp-content/plugins/contact-form-7-recaptcha/script.js?ver=1.0.0'></script>
	<!-- 63 queries. 0.088 seconds. -->
</div>
</body>
</html>

